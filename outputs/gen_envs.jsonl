{"scenario": "SurveyMonkey Apply", "db_path": "./outputs/databases/surveymonkey_apply.db", "full_code": "import os\nfrom typing import List, Optional, Dict, Any\nfrom fastapi import FastAPI, Query, Path, Body\nfrom pydantic import BaseModel, Field, ConfigDict\nfrom sqlalchemy import (\n    create_engine, Column, Integer, String, Float, Boolean, DateTime, ForeignKey, Text, UniqueConstraint, Index\n)\nfrom sqlalchemy.orm import declarative_base, sessionmaker, relationship\nfrom sqlalchemy.orm import Mapped\nfrom sqlalchemy.sql import func\nfrom datetime import datetime, date, time, timedelta\nimport json\n\nDATABASE_PATH = os.getenv(\"DATABASE_PATH\", \"sqlite:///xxxx.db\")\nengine = create_engine(DATABASE_PATH, connect_args={\"check_same_thread\": False})\nSessionLocal = sessionmaker(bind=engine, expire_on_commit=False)\nBase = declarative_base()\n\nclass Organization(Base):\n    __tablename__ = \"organizations\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, unique=True, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\n\nclass User(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, unique=True, nullable=False)\n    email = Column(String, unique=True, nullable=False)\n    full_name = Column(String)\n    organization_id = Column(Integer, ForeignKey(\"organizations.id\", ondelete=\"SET NULL\"))\n    profile_json = Column(Text)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Program(Base):\n    __tablename__ = \"programs\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    description = Column(Text)\n    default_time_zone = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('owner_user_id', 'name'),\n    )\n\n\nclass Cycle(Base):\n    __tablename__ = \"cycles\"\n    id = Column(Integer, primary_key=True)\n    program_id = Column(Integer, ForeignKey(\"programs.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    open_at = Column(String, nullable=False)\n    deadline_at = Column(String, nullable=False)\n    late_until_at = Column(String)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('program_id', 'name'),\n    )\n\n\nclass CycleStage(Base):\n    __tablename__ = \"cycle_stages\"\n    id = Column(Integer, primary_key=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    stage_order = Column(Integer, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('cycle_id', 'name'),\n        UniqueConstraint('cycle_id', 'stage_order'),\n    )\n\n\nclass ApplicationForm(Base):\n    __tablename__ = \"application_forms\"\n    id = Column(Integer, primary_key=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    name = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\n\nclass FormSection(Base):\n    __tablename__ = \"form_sections\"\n    id = Column(Integer, primary_key=True)\n    form_id = Column(Integer, ForeignKey(\"application_forms.id\", ondelete=\"CASCADE\"), nullable=False)\n    title = Column(String, nullable=False)\n    section_order = Column(Integer, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('form_id', 'section_order'),\n        UniqueConstraint('form_id', 'title'),\n    )\n\n\nclass FormQuestion(Base):\n    __tablename__ = \"form_questions\"\n    id = Column(Integer, primary_key=True)\n    section_id = Column(Integer, ForeignKey(\"form_sections.id\", ondelete=\"CASCADE\"), nullable=False)\n    question_key = Column(String, nullable=False)\n    label = Column(String, nullable=False)\n    question_type = Column(String, nullable=False)\n    is_required = Column(Integer, nullable=False, default=0)\n    max_length = Column(Integer)\n    min_value = Column(Float)\n    max_value = Column(Float)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('section_id', 'question_key'),\n    )\n\n\nclass FormQuestionOption(Base):\n    __tablename__ = \"form_question_options\"\n    id = Column(Integer, primary_key=True)\n    question_id = Column(Integer, ForeignKey(\"form_questions.id\", ondelete=\"CASCADE\"), nullable=False)\n    value = Column(String, nullable=False)\n    label = Column(String, nullable=False)\n    option_order = Column(Integer, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('question_id', 'value'),\n        UniqueConstraint('question_id', 'option_order'),\n    )\n\n\nclass DocumentRequirement(Base):\n    __tablename__ = \"document_requirements\"\n    id = Column(Integer, primary_key=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    is_required = Column(Integer, nullable=False, default=1)\n    allowed_mime_types = Column(String, nullable=False)\n    max_bytes = Column(Integer, nullable=False)\n    submitted_by_role = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('cycle_id', 'name'),\n    )\n\n\nclass EligibilityRule(Base):\n    __tablename__ = \"eligibility_rules\"\n    id = Column(Integer, primary_key=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    field_key = Column(String, nullable=False)\n    operator = Column(String, nullable=False)\n    value_json = Column(String, nullable=False)\n    on_fail_action = Column(String, nullable=False, default=\"mark_ineligible\")\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('cycle_id', 'name'),\n    )\n\n\nclass Submission(Base):\n    __tablename__ = \"submissions\"\n    id = Column(Integer, primary_key=True)\n    submission_code = Column(String, nullable=False, unique=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"CASCADE\"), nullable=False)\n    applicant_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    status = Column(String, nullable=False)\n    ineligible_reason = Column(String)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    submitted_at = Column(DateTime)\n\nclass SubmissionAnswer(Base):\n    __tablename__ = \"submission_answers\"\n    id = Column(Integer, primary_key=True)\n    submission_id = Column(Integer, ForeignKey(\"submissions.id\", ondelete=\"CASCADE\"), nullable=False)\n    question_id = Column(Integer, ForeignKey(\"form_questions.id\", ondelete=\"CASCADE\"), nullable=False)\n    value_text = Column(Text)\n    value_number = Column(Float)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('submission_id', 'question_id'),\n    )\n\nclass SubmissionDocument(Base):\n    __tablename__ = \"submission_documents\"\n    id = Column(Integer, primary_key=True)\n    submission_id = Column(Integer, ForeignKey(\"submissions.id\", ondelete=\"CASCADE\"), nullable=False)\n    requirement_id = Column(Integer, ForeignKey(\"document_requirements.id\", ondelete=\"CASCADE\"), nullable=False)\n    uploaded_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    uploaded_by_role = Column(String, nullable=False)\n    file_name = Column(String, nullable=False)\n    mime_type = Column(String, nullable=False)\n    file_size_bytes = Column(Integer, nullable=False)\n    storage_uri = Column(String, nullable=False)\n    uploaded_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('submission_id', 'requirement_id'),\n    )\n\nclass Reviewer(Base):\n    __tablename__ = \"reviewers\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\n\nclass ReviewAssignment(Base):\n    __tablename__ = \"review_assignments\"\n    id = Column(Integer, primary_key=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"CASCADE\"), nullable=False)\n    submission_id = Column(Integer, ForeignKey(\"submissions.id\", ondelete=\"CASCADE\"), nullable=False)\n    reviewer_id = Column(Integer, ForeignKey(\"reviewers.id\", ondelete=\"CASCADE\"), nullable=False)\n    assigned_at = Column(DateTime, nullable=False, default=func.now())\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('submission_id', 'reviewer_id'),\n    )\n\n\nclass Rubric(Base):\n    __tablename__ = \"rubrics\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, unique=True, nullable=False)\n    require_overall_comment = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass RubricCriterion(Base):\n    __tablename__ = \"rubric_criteria\"\n    id = Column(Integer, primary_key=True)\n    rubric_id = Column(Integer, ForeignKey(\"rubrics.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    min_score = Column(Integer, nullable=False)\n    max_score = Column(Integer, nullable=False)\n    criterion_order = Column(Integer, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('rubric_id', 'name'),\n        UniqueConstraint('rubric_id', 'criterion_order'),\n    )\n\nclass StageRubric(Base):\n    __tablename__ = \"stage_rubrics\"\n    id = Column(Integer, primary_key=True)\n    cycle_stage_id = Column(Integer, ForeignKey(\"cycle_stages.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    rubric_id = Column(Integer, ForeignKey(\"rubrics.id\", ondelete=\"RESTRICT\"), nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\n\nclass Review(Base):\n    __tablename__ = \"reviews\"\n    id = Column(Integer, primary_key=True)\n    submission_id = Column(Integer, ForeignKey(\"submissions.id\", ondelete=\"CASCADE\"), nullable=False)\n    reviewer_id = Column(Integer, ForeignKey(\"reviewers.id\", ondelete=\"CASCADE\"), nullable=False)\n    rubric_id = Column(Integer, ForeignKey(\"rubrics.id\", ondelete=\"RESTRICT\"), nullable=False)\n    conflict_status = Column(String, nullable=False)\n    overall_comment = Column(Text)\n    submitted_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('submission_id', 'reviewer_id', 'rubric_id'),\n    )\n\nclass ReviewScore(Base):\n    __tablename__ = \"review_scores\"\n    id = Column(Integer, primary_key=True)\n    review_id = Column(Integer, ForeignKey(\"reviews.id\", ondelete=\"CASCADE\"), nullable=False)\n    criterion_id = Column(Integer, ForeignKey(\"rubric_criteria.id\", ondelete=\"CASCADE\"), nullable=False)\n    score = Column(Integer, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('review_id', 'criterion_id'),\n    )\n\nclass InterviewCampaign(Base):\n    __tablename__ = \"interview_campaigns\"\n    id = Column(Integer, primary_key=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    time_zone = Column(String, nullable=False)\n    slot_minutes = Column(Integer, nullable=False)\n    start_at = Column(String, nullable=False)\n    end_at = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('cycle_id', 'name'),\n    )\n\nclass InterviewSlot(Base):\n    __tablename__ = \"interview_slots\"\n    id = Column(Integer, primary_key=True)\n    campaign_id = Column(Integer, ForeignKey(\"interview_campaigns.id\", ondelete=\"CASCADE\"), nullable=False)\n    start_at = Column(String, nullable=False)\n    end_at = Column(String, nullable=False)\n    is_booked = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('campaign_id', 'start_at'),\n    )\n\nclass InterviewBooking(Base):\n    __tablename__ = \"interview_bookings\"\n    id = Column(Integer, primary_key=True)\n    campaign_id = Column(Integer, ForeignKey(\"interview_campaigns.id\", ondelete=\"CASCADE\"), nullable=False)\n    slot_id = Column(Integer, ForeignKey(\"interview_slots.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    submission_id = Column(Integer, ForeignKey(\"submissions.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    booked_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    booked_at = Column(DateTime, nullable=False, default=func.now())\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass EmailTemplate(Base):\n    __tablename__ = \"email_templates\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    subject = Column(String, nullable=False)\n    body = Column(Text, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n    __table_args__ = (\n        UniqueConstraint('owner_user_id', 'name'),\n    )\n\nclass EmailOutbox(Base):\n    __tablename__ = \"email_outbox\"\n    id = Column(Integer, primary_key=True)\n    cycle_id = Column(Integer, ForeignKey(\"cycles.id\", ondelete=\"SET NULL\"))\n    submission_id = Column(Integer, ForeignKey(\"submissions.id\", ondelete=\"SET NULL\"))\n    recipient_email = Column(String, nullable=False)\n    subject = Column(String, nullable=False)\n    body = Column(Text, nullable=False)\n    status = Column(String, nullable=False, default=\"queued\")\n    queued_at = Column(DateTime, nullable=False, default=func.now())\n    sent_at = Column(DateTime)\n    error_text = Column(Text)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Award(Base):\n    __tablename__ = \"awards\"\n    id = Column(Integer, primary_key=True)\n    submission_id = Column(Integer, ForeignKey(\"submissions.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    award_amount = Column(Float, nullable=False)\n    decision_date = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nBase.metadata.create_all(engine)\n\napp = FastAPI()\n\nclass ProgramCreateRequest(BaseModel):\n    name: str = Field(..., description=\"Display name of the program\", example=\"STEM Scholars Grant\")\n    description: Optional[str] = Field(None, description=\"Short summary of the program's purpose\", example=\"Supports undergraduate research projects in STEM fields\")\n    default_time_zone: str = Field(..., description=\"IANA time zone for this program\", example=\"America/New_York\")\n\nclass ProgramResponse(BaseModel):\n    id: int = Field(..., description=\"Program unique ID\", example=10)\n    name: str = Field(..., description=\"Program name\", example=\"STEM Scholars Grant\")\n    description: Optional[str] = Field(None, description=\"Program description\", example=\"Supports undergraduate research projects in STEM fields\")\n    default_time_zone: str = Field(..., description=\"Time zone for all related cycles\", example=\"America/New_York\")\n    owner_user_id: int = Field(..., description=\"ID of the user who owns this program\", example=1)\n    created_at: str = Field(..., description=\"Program creation timestamp (ISO 8601)\", example=\"2026-01-15T09:30:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/programs\",\n    summary=\"Create a new program for the current user\",\n    description=\"Create a new entry in the programs table using the current user as owner\",\n    tags=[\"programs\"],\n    operation_id=\"create_program\",\n    response_model=ProgramResponse\n)\nasync def create_program(program: ProgramCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = Program(\n        owner_user_id=1,\n        name=program.name,\n        description=program.description,\n        default_time_zone=program.default_time_zone,\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = ProgramResponse(\n        id=obj.id,\n        name=obj.name,\n        description=obj.description,\n        default_time_zone=obj.default_time_zone,\n        owner_user_id=obj.owner_user_id,\n        created_at=obj.created_at.replace(microsecond=0).isoformat() + \"Z\"\n    )\n    session.close()\n    return ret\n\nclass ProgramShortSummary(BaseModel):\n    id: int = Field(..., description=\"Program unique ID\", example=10)\n    name: str = Field(..., description=\"Program name\", example=\"STEM Scholars Grant\")\n    description: Optional[str] = Field(None, description=\"Program description\", example=\"Supports undergraduate research projects in STEM fields\")\n    default_time_zone: str = Field(..., description=\"Time zone for the program\", example=\"America/New_York\")\n    owner_user_id: int = Field(..., description=\"ID of the owning user\", example=1)\n    model_config = ConfigDict(from_attributes=True)\n\nclass ProgramsListResponse(BaseModel):\n    programs: List[ProgramShortSummary] = Field(..., description=\"List of owned programs\", example=[\n        {\n            \"id\": 10,\n            \"name\": \"STEM Scholars Grant\",\n            \"description\": \"Supports undergraduate research projects in STEM fields\",\n            \"default_time_zone\": \"America/New_York\",\n            \"owner_user_id\": 1\n        }\n    ])\n    model_config = ConfigDict(from_attributes=True)\n\n@app.get(\n    \"/api/programs\",\n    summary=\"List all programs owned by the current user\",\n    description=\"Retrieve all programs where owner_user_id matches authenticated user\",\n    tags=[\"programs\"],\n    operation_id=\"list_programs_by_user\",\n    response_model=ProgramsListResponse\n)\nasync def list_programs_by_user():\n    session = SessionLocal()\n    objs = session.query(Program).filter(Program.owner_user_id == 1).all()\n    programs = []\n    for obj in objs:\n        programs.append(\n            ProgramShortSummary(\n                id=obj.id,\n                name=obj.name,\n                description=obj.description,\n                default_time_zone=obj.default_time_zone,\n                owner_user_id=obj.owner_user_id,\n            )\n        )\n    session.close()\n    return ProgramsListResponse(programs=programs)\n\nclass CycleCreateRequest(BaseModel):\n    program_id: int = Field(..., description=\"ID of the parent program\", example=10)\n    name: str = Field(..., description=\"Cycle name (e.g., Fall 2026)\", example=\"Fall 2026\")\n    open_at: str = Field(..., description=\"Opening datetime (ISO 8601)\", example=\"2026-08-01T09:00:00-04:00\")\n    deadline_at: str = Field(..., description=\"Submission deadline datetime (ISO 8601)\", example=\"2026-10-01T17:00:00-04:00\")\n    late_until_at: Optional[str] = Field(None, description=\"Datetime for late submission cutoff (ISO 8601, nullable)\", example=\"2026-10-08T17:00:00-04:00\")\n\nclass CycleResponse(BaseModel):\n    id: int = Field(..., description=\"Cycle unique ID\", example=50)\n    program_id: int = Field(..., description=\"Parent program ID\", example=10)\n    name: str = Field(..., description=\"Cycle name\", example=\"Fall 2026\")\n    open_at: str = Field(..., description=\"Cycle opening date/time (ISO 8601)\", example=\"2026-08-01T09:00:00-04:00\")\n    deadline_at: str = Field(..., description=\"Cycle deadline date/time (ISO 8601)\", example=\"2026-10-01T17:00:00-04:00\")\n    late_until_at: Optional[str] = Field(None, description=\"Late submission allowed until this date/time (ISO 8601 or null)\", example=\"2026-10-08T17:00:00-04:00\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/cycles\",\n    summary=\"Create a new application cycle for a program\",\n    description=\"Create an entry in cycles for a specified program owned by current user\",\n    tags=[\"cycles\"],\n    operation_id=\"create_cycle\",\n    response_model=CycleResponse\n)\nasync def create_cycle(cycle: CycleCreateRequest = Body(...)):\n    session = SessionLocal()\n    program = session.query(Program).filter(Program.id == cycle.program_id, Program.owner_user_id == 1).first()\n    obj = Cycle(\n        program_id=cycle.program_id,\n        name=cycle.name,\n        open_at=cycle.open_at,\n        deadline_at=cycle.deadline_at,\n        late_until_at=cycle.late_until_at\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = CycleResponse(\n        id=obj.id,\n        program_id=obj.program_id,\n        name=obj.name,\n        open_at=obj.open_at,\n        deadline_at=obj.deadline_at,\n        late_until_at=obj.late_until_at\n    )\n    session.close()\n    return ret\n\nclass ShortCycleSummary(BaseModel):\n    id: int = Field(..., description=\"Cycle ID\", example=50)\n    name: str = Field(..., description=\"Cycle name\", example=\"Fall 2026\")\n    open_at: str = Field(..., description=\"Open datetime (ISO 8601)\", example=\"2026-08-01T09:00:00-04:00\")\n    deadline_at: str = Field(..., description=\"Deadline datetime (ISO 8601)\", example=\"2026-10-01T17:00:00-04:00\")\n    late_until_at: Optional[str] = Field(None, description=\"Late submission allowed until this date/time (ISO 8601 or null)\", example=\"2026-10-08T17:00:00-04:00\")\n    program_id: int = Field(..., description=\"Parent program ID\", example=10)\n    model_config = ConfigDict(from_attributes=True)\n\nclass CyclesListResponse(BaseModel):\n    cycles: List[ShortCycleSummary] = Field(..., description=\"List of cycles\", example=[\n        {\n            \"id\": 50,\n            \"name\": \"Fall 2026\",\n            \"open_at\": \"2026-08-01T09:00:00-04:00\",\n            \"deadline_at\": \"2026-10-01T17:00:00-04:00\",\n            \"late_until_at\": \"2026-10-08T17:00:00-04:00\",\n            \"program_id\": 10,\n        }\n    ])\n    model_config = ConfigDict(from_attributes=True)\n\n@app.get(\n    \"/api/cycles\",\n    summary=\"List all cycles for a specific program\",\n    description=\"Retrieve all application cycles for given program_id (owned by current user)\",\n    tags=[\"cycles\"],\n    operation_id=\"list_cycles_for_program\",\n    response_model=CyclesListResponse\n)\nasync def list_cycles_for_program(\n    program_id: int = Query(..., description=\"Filter cycles by parent program ID\", example=10)\n):\n    session = SessionLocal()\n    program = session.query(Program).filter(Program.id == program_id, Program.owner_user_id == 1).first()\n    query = session.query(Cycle).filter(Cycle.program_id == program_id)\n    objs = query.all()\n    cycles = []\n    for obj in objs:\n        cycles.append(\n            ShortCycleSummary(\n                id=obj.id,\n                name=obj.name,\n                open_at=obj.open_at,\n                deadline_at=obj.deadline_at,\n                late_until_at=obj.late_until_at,\n                program_id=obj.program_id,\n            )\n        )\n    session.close()\n    return CyclesListResponse(cycles=cycles)\n\nclass ApplicationFormCreateRequest(BaseModel):\n    cycle_id: int = Field(..., description=\"Associated cycle ID for this form\", example=50)\n    name: str = Field(..., description=\"Title for the application form\", example=\"STEM Fall 2026 Form\")\n\nclass ApplicationFormResponse(BaseModel):\n    id: int = Field(..., description=\"Form unique ID\", example=101)\n    cycle_id: int = Field(..., description=\"Associated cycle ID\", example=50)\n    name: str = Field(..., description=\"Form name\", example=\"STEM Fall 2026 Form\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/application_forms\",\n    summary=\"Create an application form for a cycle\",\n    description=\"Create an application form record for the specified cycle ID\",\n    tags=[\"application_forms\"],\n    operation_id=\"create_application_form\",\n    response_model=ApplicationFormResponse\n)\nasync def create_application_form(form: ApplicationFormCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = ApplicationForm(\n        cycle_id=form.cycle_id,\n        name=form.name\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = ApplicationFormResponse(\n        id=obj.id,\n        cycle_id=obj.cycle_id,\n        name=obj.name\n    )\n    session.close()\n    return ret\n\nclass FormSectionCreateRequest(BaseModel):\n    form_id: int = Field(..., description=\"Form ID to add section to\", example=101)\n    title: str = Field(..., description=\"Section display title for applicants\", example=\"Applicant Info\")\n    section_order: int = Field(..., description=\"Order of this section (starting at 1)\", example=1)\n\nclass FormSectionResponse(BaseModel):\n    id: int = Field(..., description=\"Section unique ID\", example=201)\n    form_id: int = Field(..., description=\"Associated form ID\", example=101)\n    title: str = Field(..., description=\"Section title\", example=\"Applicant Info\")\n    section_order: int = Field(..., description=\"Section order in form\", example=1)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/form_sections\",\n    summary=\"Add a section to an application form\",\n    description=\"Add a new section with title and order to specified application form\",\n    tags=[\"form_sections\"],\n    operation_id=\"create_form_section\",\n    response_model=FormSectionResponse\n)\nasync def create_form_section(section: FormSectionCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = FormSection(\n        form_id=section.form_id,\n        title=section.title,\n        section_order=section.section_order\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = FormSectionResponse(\n        id=obj.id,\n        form_id=obj.form_id,\n        title=obj.title,\n        section_order=obj.section_order\n    )\n    session.close()\n    return ret\n\nclass FormQuestionCreateRequest(BaseModel):\n    section_id: int = Field(..., description=\"Section ID to add the question to\", example=201)\n    question_key: str = Field(..., description=\"Stable key for programmatic use (snake_case)\", example=\"full_name\")\n    label: str = Field(..., description=\"Question label shown to applicants\", example=\"Full Name\")\n    question_type: str = Field(..., description=\"Type of question\", example=\"text\")\n    is_required: bool = Field(..., description=\"Whether this field must be answered\", example=True)\n    max_length: Optional[int] = Field(None, description=\"Max length for text or long_text\", example=2000)\n    min_value: Optional[float] = Field(None, description=\"Minimum value for number questions\", example=500)\n    max_value: Optional[float] = Field(None, description=\"Maximum value for number questions\", example=5000)\n\nclass FormQuestionResponse(BaseModel):\n    id: int = Field(..., description=\"Unique question ID\", example=301)\n    section_id: int = Field(..., description=\"Section that holds this question\", example=201)\n    question_key: str = Field(..., description=\"Stable programmatic key\", example=\"full_name\")\n    label: str = Field(..., description=\"Question prompt\", example=\"Full Name\")\n    question_type: str = Field(..., description=\"Type (text, number, etc.)\", example=\"text\")\n    is_required: bool = Field(..., description=\"Whether required\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/form_questions\",\n    summary=\"Add a question to a form section\",\n    description=\"Add a new question to a specified section in a form with validation settings\",\n    tags=[\"form_questions\"],\n    operation_id=\"create_form_question\",\n    response_model=FormQuestionResponse\n)\nasync def create_form_question(q: FormQuestionCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = FormQuestion(\n        section_id=q.section_id,\n        question_key=q.question_key,\n        label=q.label,\n        question_type=q.question_type,\n        is_required=1 if q.is_required else 0,\n        max_length=q.max_length,\n        min_value=q.min_value,\n        max_value=q.max_value\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = FormQuestionResponse(\n        id=obj.id,\n        section_id=obj.section_id,\n        question_key=obj.question_key,\n        label=obj.label,\n        question_type=obj.question_type,\n        is_required=bool(obj.is_required)\n    )\n    session.close()\n    return ret\n\nclass FormQuestionOptionCreateRequest(BaseModel):\n    question_id: int = Field(..., description=\"Parent dropdown question ID\", example=305)\n    value: str = Field(..., description=\"Stable internal value for the option\", example=\"state_u\")\n    label: str = Field(..., description=\"Human-readable option text\", example=\"State U\")\n    option_order: int = Field(..., description=\"Display order within options list\", example=1)\n\nclass FormQuestionOptionResponse(BaseModel):\n    id: int = Field(..., description=\"Unique option ID\", example=500)\n    question_id: int = Field(..., description=\"ID of parent dropdown question\", example=305)\n    value: str = Field(..., description=\"Stable value\", example=\"state_u\")\n    label: str = Field(..., description=\"Display text\", example=\"State U\")\n    option_order: int = Field(..., description=\"Order for display\", example=1)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/form_question_options\",\n    summary=\"Add an option to a dropdown question\",\n    description=\"Create a selectable option for a form question of type dropdown\",\n    tags=[\"form_question_options\"],\n    operation_id=\"create_form_question_option\",\n    response_model=FormQuestionOptionResponse\n)\nasync def create_form_question_option(opt: FormQuestionOptionCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = FormQuestionOption(\n        question_id=opt.question_id,\n        value=opt.value,\n        label=opt.label,\n        option_order=opt.option_order\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = FormQuestionOptionResponse(\n        id=obj.id,\n        question_id=obj.question_id,\n        value=obj.value,\n        label=obj.label,\n        option_order=obj.option_order\n    )\n    session.close()\n    return ret\n\nclass DocumentRequirementCreateRequest(BaseModel):\n    cycle_id: int = Field(..., description=\"Cycle for which the document is required\", example=50)\n    name: str = Field(..., description=\"Document requirement name\", example=\"Unofficial Transcript\")\n    is_required: bool = Field(..., description=\"Is upload mandatory?\", example=True)\n    allowed_mime_types: str = Field(..., description=\"Comma-separated list of allowed MIME types\", example=\"application/pdf\")\n    max_bytes: int = Field(..., description=\"Maximum file size in bytes\", example=10485760)\n    submitted_by_role: str = Field(..., description=\"Role required for uploading (applicant or recommender)\", example=\"recommender\")\n\nclass DocumentRequirementResponse(BaseModel):\n    id: int = Field(..., description=\"Unique ID for the document requirement\", example=1000)\n    cycle_id: int = Field(..., description=\"Associated cycle ID\", example=50)\n    name: str = Field(..., description=\"Document name\", example=\"Letter of Recommendation\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/document_requirements\",\n    summary=\"Add a document requirement to an application cycle\",\n    description=\"Adds a file/document upload requirement for a specific cycle\",\n    tags=[\"document_requirements\"],\n    operation_id=\"create_document_requirement\",\n    response_model=DocumentRequirementResponse\n)\nasync def create_document_requirement(req: DocumentRequirementCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = DocumentRequirement(\n        cycle_id=req.cycle_id,\n        name=req.name,\n        is_required=1 if req.is_required else 0,\n        allowed_mime_types=req.allowed_mime_types,\n        max_bytes=req.max_bytes,\n        submitted_by_role=req.submitted_by_role\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = DocumentRequirementResponse(\n        id=obj.id,\n        cycle_id=obj.cycle_id,\n        name=obj.name\n    )\n    session.close()\n    return ret\n\nclass EligibilityRuleCreateRequest(BaseModel):\n    cycle_id: int = Field(..., description=\"Cycle ID this rule is attached to\", example=50)\n    name: str = Field(..., description=\"Display name for this eligibility rule\", example=\"Minimum GPA\")\n    field_key: str = Field(..., description=\"Form question key (e.g., 'gpa' or 'enrollment_status')\", example=\"gpa\")\n    operator: str = Field(..., description=\"Comparison operator (e.g., '<', '=', 'IN')\", example=\"<\")\n    value_json: str = Field(..., description=\"JSON-encoded comparison value or values\", example=\"3.2\")\n    on_fail_action: Optional[str] = Field(None, description=\"Action to take if rule fails (default: mark_ineligible)\", example=\"mark_ineligible\")\n\nclass EligibilityRuleResponse(BaseModel):\n    id: int = Field(..., description=\"Eligibility rule unique ID\", example=900)\n    cycle_id: int = Field(..., description=\"Associated cycle ID\", example=50)\n    field_key: str = Field(..., description=\"Field programmatic key\", example=\"gpa\")\n    operator: str = Field(..., description=\"Comparison operator\", example=\"<\")\n    value_json: str = Field(..., description=\"Comparison value(s) as JSON\", example=\"3.2\")\n    on_fail_action: str = Field(..., description=\"Action on rule failure\", example=\"mark_ineligible\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/eligibility_rules\",\n    summary=\"Create an eligibility rule for a cycle\",\n    description=\"Adds a new eligibility rule for a cycle, referencing a form question via field_key\",\n    tags=[\"eligibility_rules\"],\n    operation_id=\"create_eligibility_rule\",\n    response_model=EligibilityRuleResponse\n)\nasync def create_eligibility_rule(rule: EligibilityRuleCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = EligibilityRule(\n        cycle_id=rule.cycle_id,\n        name=rule.name,\n        field_key=rule.field_key,\n        operator=rule.operator,\n        value_json=rule.value_json,\n        on_fail_action=rule.on_fail_action if rule.on_fail_action else \"mark_ineligible\"\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = EligibilityRuleResponse(\n        id=obj.id,\n        cycle_id=obj.cycle_id,\n        field_key=obj.field_key,\n        operator=obj.operator,\n        value_json=obj.value_json,\n        on_fail_action=obj.on_fail_action\n    )\n    session.close()\n    return ret\n\nclass SubmissionSummary(BaseModel):\n    id: int = Field(..., description=\"Submission unique ID\", example=42)\n    submission_code: str = Field(..., description=\"Human-readable code\", example=\"SUB-1042\")\n    applicant_user_id: int = Field(..., description=\"Applicant user ID\", example=13)\n    status: str = Field(..., description=\"Current status\", example=\"Submitted\")\n    created_at: str = Field(..., description=\"When submission was created (ISO 8601)\", example=\"2026-09-17T16:40:00-04:00\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SubmissionsListResponse(BaseModel):\n    submissions: List[SubmissionSummary] = Field(..., description=\"Submissions list\", example=[\n        {\n            \"id\": 42,\n            \"submission_code\": \"SUB-1042\",\n            \"applicant_user_id\": 13,\n            \"status\": \"Submitted\",\n            \"created_at\": \"2026-09-17T16:40:00-04:00\"\n        }\n    ])\n    model_config = ConfigDict(from_attributes=True)\n\n@app.get(\n    \"/api/submissions\",\n    summary=\"List submissions for a cycle with filters\",\n    description=\"List submissions in a cycle with optional status and date range filters\",\n    tags=[\"submissions\"],\n    operation_id=\"list_submissions_for_cycle\",\n    response_model=SubmissionsListResponse\n)\nasync def list_submissions_for_cycle(\n    cycle_id: int = Query(..., description=\"Cycle to query submissions for\", example=50),\n    status: Optional[str] = Query(None, description=\"Submission status filter\", example=\"Submitted\"),\n    created_from: Optional[str] = Query(None, description=\"Return only submissions created at or after this date (YYYY-MM-DD)\", example=\"2026-09-15\"),\n    created_to: Optional[str] = Query(None, description=\"Return only submissions created at or before this date (YYYY-MM-DD)\", example=\"2026-09-30\")\n):\n    session = SessionLocal()\n    query = session.query(Submission).filter(Submission.cycle_id == cycle_id)\n    if status:\n        query = query.filter(Submission.status == status)\n    if created_from:\n        dt = datetime.fromisoformat(created_from)\n        query = query.filter(Submission.created_at >= dt)\n    if created_to:\n        dt = datetime.fromisoformat(created_to)\n        query = query.filter(Submission.created_at <= dt + timedelta(days=1))\n    objs = query.all()\n    lst = []\n    for obj in objs:\n        lst.append(\n            SubmissionSummary(\n                id=obj.id,\n                submission_code=obj.submission_code,\n                applicant_user_id=obj.applicant_user_id,\n                status=obj.status,\n                created_at=obj.created_at.replace(microsecond=0).isoformat()\n            )\n        )\n    session.close()\n    return SubmissionsListResponse(submissions=lst)\n\nclass SubmissionStatusUpdateRequest(BaseModel):\n    status: str = Field(..., description=\"New status value\", example=\"In Review\")\n\nclass SubmissionStatusUpdateResponse(BaseModel):\n    id: int = Field(..., description=\"Submission ID\", example=42)\n    submission_code: str = Field(..., description=\"Human-readable code for submission\", example=\"SUB-1042\")\n    status: str = Field(..., description=\"Updated status\", example=\"In Review\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.patch(\n    \"/api/submissions/{submission_id}/status\",\n    summary=\"Change a submission's status\",\n    description=\"Update the status field for a specified submission by ID\",\n    tags=[\"submissions\"],\n    operation_id=\"update_submission_status\",\n    response_model=SubmissionStatusUpdateResponse\n)\nasync def update_submission_status(\n    submission_id: int = Path(..., description=\"Submission record ID\", example=42),\n    body: SubmissionStatusUpdateRequest = Body(...)\n):\n    session = SessionLocal()\n    obj = session.query(Submission).filter(Submission.id == submission_id).first()\n    obj.status = body.status\n    session.commit()\n    session.refresh(obj)\n    ret = SubmissionStatusUpdateResponse(\n        id=obj.id,\n        submission_code=obj.submission_code,\n        status=obj.status\n    )\n    session.close()\n    return ret\n\nclass UserCreateRequest(BaseModel):\n    username: str = Field(..., description=\"Username/login\", example=\"maya.chen\")\n    email: str = Field(..., description=\"Email address\", example=\"maya.chen@example.edu\")\n    full_name: str = Field(..., description=\"Full display name\", example=\"Dr. Maya Chen\")\n    organization_id: Optional[int] = Field(None, description=\"Organization ID (can be null)\", example=2)\n\nclass UserResponse(BaseModel):\n    id: int = Field(..., description=\"Unique user ID\", example=21)\n    username: str = Field(..., description=\"Username\", example=\"maya.chen\")\n    email: str = Field(..., description=\"Email address\", example=\"maya.chen@example.edu\")\n    full_name: Optional[str] = Field(None, description=\"Full display name\", example=\"Dr. Maya Chen\")\n    organization_id: Optional[int] = Field(None, description=\"Organization ID, if any\", example=2)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/users\",\n    summary=\"Create a user in the system\",\n    description=\"Create a new user with full_name, username, email, and organization\",\n    tags=[\"users\"],\n    operation_id=\"create_user\",\n    response_model=UserResponse\n)\nasync def create_user(user: UserCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = User(\n        username=user.username,\n        email=user.email,\n        full_name=user.full_name,\n        organization_id=user.organization_id\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = UserResponse(\n        id=obj.id,\n        username=obj.username,\n        email=obj.email,\n        full_name=obj.full_name,\n        organization_id=obj.organization_id\n    )\n    session.close()\n    return ret\n\nclass ReviewerCreateRequest(BaseModel):\n    user_id: int = Field(..., description=\"Existing user ID to mark as reviewer\", example=21)\n\nclass ReviewerResponse(BaseModel):\n    id: int = Field(..., description=\"Reviewer ID\", example=3)\n    user_id: int = Field(..., description=\"User account ID\", example=21)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/reviewers\",\n    summary=\"Create a reviewer from a user account\",\n    description=\"Register an existing user as a reviewer (one-to-one relation)\",\n    tags=[\"reviewers\"],\n    operation_id=\"create_reviewer\",\n    response_model=ReviewerResponse\n)\nasync def create_reviewer(body: ReviewerCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = Reviewer(\n        user_id=body.user_id\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = ReviewerResponse(\n        id=obj.id,\n        user_id=obj.user_id\n    )\n    session.close()\n    return ret\n\nclass ReviewAssignmentCreateRequest(BaseModel):\n    cycle_id: int = Field(..., description=\"Application cycle ID\", example=50)\n    submission_id: int = Field(..., description=\"ID of submission being reviewed\", example=42)\n    reviewer_id: int = Field(..., description=\"Reviewer ID to assign\", example=3)\n\nclass ReviewAssignmentResponse(BaseModel):\n    id: int = Field(..., description=\"Assignment unique ID\", example=101)\n    cycle_id: int = Field(..., description=\"Cycle of this assignment\", example=50)\n    submission_id: int = Field(..., description=\"Submission ID\", example=42)\n    reviewer_id: int = Field(..., description=\"Reviewer ID\", example=3)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/review_assignments\",\n    summary=\"Assign a reviewer to a submission in a cycle\",\n    description=\"Create a single review assignment connecting reviewer to a submission for a given cycle\",\n    tags=[\"review_assignments\"],\n    operation_id=\"create_review_assignment\",\n    response_model=ReviewAssignmentResponse\n)\nasync def create_review_assignment(assign: ReviewAssignmentCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = ReviewAssignment(\n        cycle_id=assign.cycle_id,\n        submission_id=assign.submission_id,\n        reviewer_id=assign.reviewer_id\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = ReviewAssignmentResponse(\n        id=obj.id,\n        cycle_id=obj.cycle_id,\n        submission_id=obj.submission_id,\n        reviewer_id=obj.reviewer_id\n    )\n    session.close()\n    return ret\n\nclass RubricCreateRequest(BaseModel):\n    name: str = Field(..., description=\"Unique rubric name\", example=\"Research Potential v1\")\n    require_overall_comment: bool = Field(..., description=\"Require an overall comment on each review\", example=True)\n\nclass RubricResponse(BaseModel):\n    id: int = Field(..., description=\"Rubric unique ID\", example=10)\n    name: str = Field(..., description=\"Rubric name\", example=\"Research Potential v1\")\n    require_overall_comment: bool = Field(..., description=\"Is an overall comment required?\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/rubrics\",\n    summary=\"Create a new review rubric\",\n    description=\"Adds a named evaluation rubric to the system\",\n    tags=[\"rubrics\"],\n    operation_id=\"create_rubric\",\n    response_model=RubricResponse\n)\nasync def create_rubric(body: RubricCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = Rubric(\n        name=body.name,\n        require_overall_comment=1 if body.require_overall_comment else 0\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = RubricResponse(\n        id=obj.id,\n        name=obj.name,\n        require_overall_comment=bool(obj.require_overall_comment)\n    )\n    session.close()\n    return ret\n\nclass RubricCriterionCreateRequest(BaseModel):\n    rubric_id: int = Field(..., description=\"ID of parent rubric\", example=10)\n    name: str = Field(..., description=\"Criterion label\", example=\"Feasibility\")\n    min_score: int = Field(..., description=\"Minimum allowed score for this criterion\", example=0)\n    max_score: int = Field(..., description=\"Maximum allowed score for this criterion\", example=5)\n    criterion_order: int = Field(..., description=\"Display order in rubric\", example=1)\n\nclass RubricCriterionResponse(BaseModel):\n    id: int = Field(..., description=\"Criterion unique ID\", example=101)\n    rubric_id: int = Field(..., description=\"Parent rubric ID\", example=10)\n    name: str = Field(..., description=\"Criterion label\", example=\"Feasibility\")\n    min_score: int = Field(..., description=\"Minimum score\", example=0)\n    max_score: int = Field(..., description=\"Maximum score\", example=5)\n    criterion_order: int = Field(..., description=\"Order in rubric\", example=1)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/rubric_criteria\",\n    summary=\"Add a criterion to a rubric\",\n    description=\"Adds a scoring criterion to a rubric with name, min, max and order\",\n    tags=[\"rubric_criteria\"],\n    operation_id=\"create_rubric_criterion\",\n    response_model=RubricCriterionResponse\n)\nasync def create_rubric_criterion(body: RubricCriterionCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = RubricCriterion(\n        rubric_id=body.rubric_id,\n        name=body.name,\n        min_score=body.min_score,\n        max_score=body.max_score,\n        criterion_order=body.criterion_order\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = RubricCriterionResponse(\n        id=obj.id,\n        rubric_id=obj.rubric_id,\n        name=obj.name,\n        min_score=obj.min_score,\n        max_score=obj.max_score,\n        criterion_order=obj.criterion_order\n    )\n    session.close()\n    return ret\n\nclass CycleStageCreateRequest(BaseModel):\n    cycle_id: int = Field(..., description=\"Cycle to associate this stage with\", example=50)\n    name: str = Field(..., description=\"Stage name (e.g., Review)\", example=\"Review\")\n    stage_order: int = Field(..., description=\"Order of the stage\", example=2)\n\nclass CycleStageResponse(BaseModel):\n    id: int = Field(..., description=\"Stage unique ID\", example=200)\n    cycle_id: int = Field(..., description=\"Parent cycle ID\", example=50)\n    name: str = Field(..., description=\"Stage name\", example=\"Review\")\n    stage_order: int = Field(..., description=\"Order in cycle process\", example=2)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/cycle_stages\",\n    summary=\"Create a stage in an application cycle\",\n    description=\"Create a new stage for a cycle with name and order\",\n    tags=[\"cycle_stages\"],\n    operation_id=\"create_cycle_stage\",\n    response_model=CycleStageResponse\n)\nasync def create_cycle_stage(body: CycleStageCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = CycleStage(\n        cycle_id=body.cycle_id,\n        name=body.name,\n        stage_order=body.stage_order\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = CycleStageResponse(\n        id=obj.id,\n        cycle_id=obj.cycle_id,\n        name=obj.name,\n        stage_order=obj.stage_order\n    )\n    session.close()\n    return ret\n\nclass StageRubricCreateRequest(BaseModel):\n    cycle_stage_id: int = Field(..., description=\"Cycle stage ID (e.g., review stage)\", example=200)\n    rubric_id: int = Field(..., description=\"Rubric to attach\", example=10)\n\nclass StageRubricResponse(BaseModel):\n    id: int = Field(..., description=\"Unique stage rubric link ID\", example=301)\n    cycle_stage_id: int = Field(..., description=\"Stage ID\", example=200)\n    rubric_id: int = Field(..., description=\"Rubric ID\", example=10)\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/stage_rubrics\",\n    summary=\"Attach a rubric to a review stage\",\n    description=\"Links a rubric to a review stage in a specific cycle\",\n    tags=[\"stage_rubrics\"],\n    operation_id=\"create_stage_rubric\",\n    response_model=StageRubricResponse\n)\nasync def create_stage_rubric(body: StageRubricCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = StageRubric(\n        cycle_stage_id=body.cycle_stage_id,\n        rubric_id=body.rubric_id\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = StageRubricResponse(\n        id=obj.id,\n        cycle_stage_id=obj.cycle_stage_id,\n        rubric_id=obj.rubric_id\n    )\n    session.close()\n    return ret\n\nclass ReviewScoreDetail(BaseModel):\n    criterion_id: int = Field(..., description=\"Criterion scored\", example=31)\n    score: int = Field(..., description=\"Score for this criterion\", example=4)\n    model_config = ConfigDict(from_attributes=True)\n\nclass ReviewSubmitRequest(BaseModel):\n    submission_id: int = Field(..., description=\"Submission being reviewed\", example=42)\n    reviewer_id: int = Field(..., description=\"Reviewer who is scoring\", example=3)\n    rubric_id: int = Field(..., description=\"Rubric associated with this review\", example=10)\n    conflict_status: str = Field(..., description=\"Conflict of interest status\", example=\"None\")\n    overall_comment: str = Field(..., description=\"Comment about this submission\", example=\"Strong idea; budget needs more detail\")\n    scores: List[ReviewScoreDetail] = Field(..., description=\"Scores for each criterion (criterion_id and value)\", example=[\n        {\"criterion_id\": 31, \"score\": 4}, {\"criterion_id\": 32, \"score\": 5}, {\"criterion_id\": 33, \"score\": 3}\n    ])\n\nclass ReviewSubmitResponse(BaseModel):\n    review_id: int = Field(..., description=\"Review record ID\", example=1001)\n    submission_id: int = Field(..., description=\"Submission reviewed\", example=42)\n    reviewer_id: int = Field(..., description=\"Reviewer for this review\", example=3)\n    rubric_id: int = Field(..., description=\"Rubric used\", example=10)\n    scores: List[ReviewScoreDetail] = Field(..., description=\"Scores for criteria\", example=[\n        {\"criterion_id\": 31, \"score\": 4}, {\"criterion_id\": 32, \"score\": 5}\n    ])\n    conflict_status: str = Field(..., description=\"Conflict status\", example=\"None\")\n    overall_comment: str = Field(..., description=\"Overall review comment\", example=\"Strong idea; budget needs more detail\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/reviews\",\n    summary=\"Submit a review and scores for a submission\",\n    description=\"Stores review, scores for attached rubric, and conflict details for the reviewer-submission pair\",\n    tags=[\"reviews\"],\n    operation_id=\"submit_review\",\n    response_model=ReviewSubmitResponse\n)\nasync def submit_review(body: ReviewSubmitRequest = Body(...)):\n    session = SessionLocal()\n    obj = Review(\n        submission_id=body.submission_id,\n        reviewer_id=body.reviewer_id,\n        rubric_id=body.rubric_id,\n        conflict_status=body.conflict_status,\n        overall_comment=body.overall_comment\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    scores = []\n    for s in body.scores:\n        score_obj = ReviewScore(\n            review_id=obj.id,\n            criterion_id=s.criterion_id,\n            score=s.score\n        )\n        session.add(score_obj)\n        scores.append(\n            ReviewScoreDetail(\n                criterion_id=score_obj.criterion_id,\n                score=score_obj.score\n            )\n        )\n    session.commit()\n    ret = ReviewSubmitResponse(\n        review_id=obj.id,\n        submission_id=obj.submission_id,\n        reviewer_id=obj.reviewer_id,\n        rubric_id=obj.rubric_id,\n        scores=scores,\n        conflict_status=obj.conflict_status,\n        overall_comment=obj.overall_comment\n    )\n    session.close()\n    return ret\n\nclass SubmissionAdvanceRequest(BaseModel):\n    to_status: str = Field(..., description=\"Status to advance to\", example=\"Shortlisted\")\n\nclass SubmissionAdvanceResponse(BaseModel):\n    id: int = Field(..., description=\"Submission ID\", example=42)\n    submission_code: str = Field(..., description=\"Code for the submission\", example=\"SUB-1042\")\n    status: str = Field(..., description=\"Advanced status value\", example=\"Shortlisted\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/submissions/{submission_id}/advance\",\n    summary=\"Advance a submission to a new status\",\n    description=\"Advance a submission to a next stage (e.g., Shortlisted or Approved) by updating status\",\n    tags=[\"submissions\"],\n    operation_id=\"advance_submission_status\",\n    response_model=SubmissionAdvanceResponse\n)\nasync def advance_submission_status(\n    submission_id: int = Path(..., description=\"Submission record ID to advance\", example=42),\n    body: SubmissionAdvanceRequest = Body(...)\n):\n    session = SessionLocal()\n    obj = session.query(Submission).filter(Submission.id == submission_id).first()\n    obj.status = body.to_status\n    session.commit()\n    session.refresh(obj)\n    ret = SubmissionAdvanceResponse(\n        id=obj.id,\n        submission_code=obj.submission_code,\n        status=obj.status\n    )\n    session.close()\n    return ret\n\nclass InterviewCampaignCreateRequest(BaseModel):\n    cycle_id: int = Field(..., description=\"Cycle whose shortlisted applicants will be interviewed\", example=50)\n    name: str = Field(..., description=\"Interview campaign name\", example=\"STEM Interviews Fall 2026\")\n    time_zone: str = Field(..., description=\"IANA time zone for scheduling\", example=\"America/New_York\")\n    slot_minutes: int = Field(..., description=\"Minutes for each interview slot\", example=20)\n    start_at: str = Field(..., description=\"Scheduling window start (ISO 8601 datetime)\", example=\"2026-10-20T10:00:00-04:00\")\n    end_at: str = Field(..., description=\"Scheduling window end (ISO 8601 datetime)\", example=\"2026-10-20T12:00:00-04:00\")\n\nclass InterviewCampaignResponse(BaseModel):\n    id: int = Field(..., description=\"Campaign unique ID\", example=80)\n    cycle_id: int = Field(..., description=\"Cycle this campaign is linked to\", example=50)\n    name: str = Field(..., description=\"Campaign name\", example=\"STEM Interviews Fall 2026\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/interview_campaigns\",\n    summary=\"Create an interview campaign and time window for a cycle\",\n    description=\"Begins an interview scheduling campaign for all eligible submissions in a cycle\",\n    tags=[\"interviews\"],\n    operation_id=\"create_interview_campaign\",\n    response_model=InterviewCampaignResponse\n)\nasync def create_interview_campaign(body: InterviewCampaignCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = InterviewCampaign(\n        cycle_id=body.cycle_id,\n        name=body.name,\n        time_zone=body.time_zone,\n        slot_minutes=body.slot_minutes,\n        start_at=body.start_at,\n        end_at=body.end_at\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = InterviewCampaignResponse(\n        id=obj.id,\n        cycle_id=obj.cycle_id,\n        name=obj.name\n    )\n    session.close()\n    return ret\n\nclass InterviewSlotBulkCreateRequest(BaseModel):\n    campaign_id: int = Field(..., description=\"Interview campaign ID\", example=80)\n\nclass InterviewSlotBulkCreateResponse(BaseModel):\n    slots_created: int = Field(..., description=\"Number of interview slots made\", example=6)\n    slot_ids: List[int] = Field(..., description=\"Slot IDs created for this campaign\", example=[1200,1201,1202])\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/interview_slots/bulk\",\n    summary=\"Bulk create time slots for an interview campaign\",\n    description=\"Creates a sequence of interview slots of equal length within a campaign window\",\n    tags=[\"interviews\"],\n    operation_id=\"bulk_create_interview_slots\",\n    response_model=InterviewSlotBulkCreateResponse\n)\nasync def bulk_create_interview_slots(body: InterviewSlotBulkCreateRequest = Body(...)):\n    session = SessionLocal()\n    campaign = session.query(InterviewCampaign).filter(InterviewCampaign.id == body.campaign_id).first()\n    start_time = datetime.fromisoformat(campaign.start_at)\n    end_time = datetime.fromisoformat(campaign.end_at)\n    slot_len = timedelta(minutes=campaign.slot_minutes)\n    current = start_time\n    ids = []\n    while current + slot_len <= end_time:\n        slot = InterviewSlot(\n            campaign_id=campaign.id,\n            start_at=current.isoformat(),\n            end_at=(current + slot_len).isoformat(),\n            is_booked=0\n        )\n        session.add(slot)\n        session.commit()\n        session.refresh(slot)\n        ids.append(slot.id)\n        current += slot_len\n    ret = InterviewSlotBulkCreateResponse(\n        slots_created=len(ids),\n        slot_ids=ids\n    )\n    session.close()\n    return ret\n\nclass EmailTemplateCreateRequest(BaseModel):\n    name: str = Field(..., description=\"Name/label for the template\", example=\"Interview Invitation - STEM Scholars Grant\")\n    subject: str = Field(..., description=\"Template email subject line\", example=\"Interview Invitation - STEM Scholars Grant\")\n    body: str = Field(..., description=\"Email message body (text or HTML)\", example=\"Please select an interview time by Oct 15; replies are monitored.\")\n\nclass EmailTemplateResponse(BaseModel):\n    id: int = Field(..., description=\"Email template ID\", example=55)\n    name: str = Field(..., description=\"Template name\", example=\"Interview Invitation - STEM Scholars Grant\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/email_templates\",\n    summary=\"Create a reusable email template\",\n    description=\"Create an email template owned by the current user with subject and body\",\n    tags=[\"email_templates\"],\n    operation_id=\"create_email_template\",\n    response_model=EmailTemplateResponse\n)\nasync def create_email_template(body: EmailTemplateCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = EmailTemplate(\n        owner_user_id=1,\n        name=body.name,\n        subject=body.subject,\n        body=body.body\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = EmailTemplateResponse(\n        id=obj.id,\n        name=obj.name\n    )\n    session.close()\n    return ret\n\nclass EmailOutboxCreateRequest(BaseModel):\n    cycle_id: Optional[int] = Field(None, description=\"Related cycle (null if not applicable)\", example=50)\n    submission_id: Optional[int] = Field(None, description=\"Related submission (nullable)\", example=42)\n    recipient_email: str = Field(..., description=\"Receiver's email address\", example=\"amy.stem@example.edu\")\n    subject: str = Field(..., description=\"Subject line for the email\", example=\"Interview Invitation - STEM Scholars Grant\")\n    body: str = Field(..., description=\"Body content of the email\", example=\"Please select an interview time by Oct 15; replies are monitored.\")\n\nclass EmailOutboxResponse(BaseModel):\n    id: int = Field(..., description=\"Queued email outbox record ID\", example=800)\n    status: str = Field(..., description=\"Queue status (queued/sent/failed)\", example=\"queued\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/email_outbox\",\n    summary=\"Queue an email for a cycle or submission\",\n    description=\"Schedule automatic emails related to submissions or cycles; uses template or direct content\",\n    tags=[\"email_outbox\"],\n    operation_id=\"queue_email_outbox\",\n    response_model=EmailOutboxResponse\n)\nasync def queue_email_outbox(body: EmailOutboxCreateRequest = Body(...)):\n    session = SessionLocal()\n    obj = EmailOutbox(\n        cycle_id=body.cycle_id,\n        submission_id=body.submission_id,\n        recipient_email=body.recipient_email,\n        subject=body.subject,\n        body=body.body,\n        status=\"queued\"\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = EmailOutboxResponse(\n        id=obj.id,\n        status=obj.status\n    )\n    session.close()\n    return ret\n\nclass AwardsExportResponse(BaseModel):\n    csv_url: str = Field(..., description=\"URL to download the generated CSV file\", example=\"https://apply.example.edu/exports/awards_fall2026.csv\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.get(\n    \"/api/awards/export_csv\",\n    summary=\"Export approved awardee data as CSV\",\n    description=\"Download a CSV file listing all approved awardees for a cycle, including key submission and award info\",\n    tags=[\"awards\"],\n    operation_id=\"export_awards_csv\",\n    response_model=AwardsExportResponse\n)\nasync def export_awards_csv(\n    cycle_id: int = Query(..., description=\"Cycle whose awards to export\", example=50)\n):\n    session = SessionLocal()\n    # Only generate the URL (simulate; in real, would create file)\n    url = f\"https://apply.example.edu/exports/awards_cycle_{cycle_id}.csv\"\n    session.close()\n    return AwardsExportResponse(csv_url=url)\n\nif __name__ == \"__main__\":\n    import uvicorn, os\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
{"scenario": "Etsy Digital Downloads", "db_path": "./outputs/databases/etsy_digital_downloads.db", "full_code": "import os\nfrom typing import Optional, List, Dict\nfrom datetime import datetime\nfrom fastapi import FastAPI, Query, Path, Body\nfrom pydantic import BaseModel, Field, ConfigDict\nfrom sqlalchemy import create_engine, Column, Integer, String, Float, DateTime, ForeignKey, Boolean, Text, UniqueConstraint, CheckConstraint\nfrom sqlalchemy.orm import declarative_base, relationship, sessionmaker\n\nDATABASE_PATH = os.getenv(\"DATABASE_PATH\") or \"sqlite:///xxxx.db\"\nengine = create_engine(DATABASE_PATH, connect_args={\"check_same_thread\": False})\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\nBase = declarative_base()\napp = FastAPI(title=\"Etsy Digital Downloads Simplified\", version=\"0.1.0\")\n\nclass User(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, unique=True, nullable=False)\n    email = Column(String, unique=True, nullable=False)\n    display_name = Column(String)\n    verification_status = Column(String, nullable=False, default='verified')\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Shop(Base):\n    __tablename__ = \"shops\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    currency_code = Column(String, nullable=False, default='USD')\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Category(Base):\n    __tablename__ = \"categories\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, unique=True, nullable=False)\n\nclass Listing(Base):\n    __tablename__ = \"listings\"\n    id = Column(Integer, primary_key=True)\n    shop_id = Column(Integer, ForeignKey(\"shops.id\", ondelete=\"CASCADE\"), nullable=False)\n    sku = Column(String)\n    title = Column(String, nullable=False)\n    category_id = Column(Integer, ForeignKey(\"categories.id\", ondelete=\"SET NULL\"))\n    base_price_amount = Column(Float, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    fulfillment_type = Column(String, nullable=False, default=\"auto\")\n    status = Column(String, nullable=False, default=\"active\")\n    removed_reason = Column(String)\n    removed_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    removed_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Tag(Base):\n    __tablename__ = \"tags\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, unique=True, nullable=False)\n\nclass ListingTag(Base):\n    __tablename__ = \"listing_tags\"\n    listing_id = Column(Integer, ForeignKey(\"listings.id\", ondelete=\"CASCADE\"), primary_key=True, nullable=False)\n    tag_id = Column(Integer, ForeignKey(\"tags.id\", ondelete=\"CASCADE\"), primary_key=True, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass ListingFile(Base):\n    __tablename__ = \"listing_files\"\n    id = Column(Integer, primary_key=True)\n    listing_id = Column(Integer, ForeignKey(\"listings.id\", ondelete=\"CASCADE\"), nullable=False)\n    filename = Column(String, nullable=False)\n    mime_type = Column(String, nullable=False)\n    size_bytes = Column(Integer, nullable=False)\n    storage_key = Column(String)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass ListingVariation(Base):\n    __tablename__ = \"listing_variations\"\n    id = Column(Integer, primary_key=True)\n    listing_id = Column(Integer, ForeignKey(\"listings.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    position = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass VariationOption(Base):\n    __tablename__ = \"variation_options\"\n    id = Column(Integer, primary_key=True)\n    variation_id = Column(Integer, ForeignKey(\"listing_variations.id\", ondelete=\"CASCADE\"), nullable=False)\n    value = Column(String, nullable=False)\n    price_delta_amount = Column(Float, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass ListingInventoryRule(Base):\n    __tablename__ = \"listing_inventory_rules\"\n    id = Column(Integer, primary_key=True)\n    listing_id = Column(Integer, ForeignKey(\"listings.id\", ondelete=\"CASCADE\"), nullable=False)\n    variation_id = Column(Integer, ForeignKey(\"listing_variations.id\", ondelete=\"CASCADE\"), nullable=False)\n    option_id = Column(Integer, ForeignKey(\"variation_options.id\", ondelete=\"CASCADE\"), nullable=False)\n    max_total_sales = Column(Integer)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Coupon(Base):\n    __tablename__ = \"coupons\"\n    id = Column(Integer, primary_key=True)\n    shop_id = Column(Integer, ForeignKey(\"shops.id\", ondelete=\"CASCADE\"), nullable=False)\n    code = Column(String, nullable=False)\n    discount_type = Column(String, nullable=False)\n    discount_value = Column(Float, nullable=False)\n    minimum_subtotal_amount = Column(Float, nullable=False, default=0)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    starts_at = Column(DateTime, nullable=False)\n    ends_at = Column(DateTime, nullable=False)\n    max_redemptions = Column(Integer)\n    is_active = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Sale(Base):\n    __tablename__ = \"sales\"\n    id = Column(Integer, primary_key=True)\n    shop_id = Column(Integer, ForeignKey(\"shops.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String)\n    discount_type = Column(String, nullable=False)\n    discount_value = Column(Float, nullable=False)\n    starts_at = Column(DateTime, nullable=False)\n    ends_at = Column(DateTime, nullable=False)\n    allow_coupon_stacking = Column(Integer, nullable=False, default=1)\n    is_active = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass SaleListing(Base):\n    __tablename__ = \"sale_listings\"\n    sale_id = Column(Integer, ForeignKey(\"sales.id\", ondelete=\"CASCADE\"), primary_key=True, nullable=False)\n    listing_id = Column(Integer, ForeignKey(\"listings.id\", ondelete=\"CASCADE\"), primary_key=True, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Order(Base):\n    __tablename__ = \"orders\"\n    id = Column(Integer, primary_key=True)\n    shop_id = Column(Integer, ForeignKey(\"shops.id\", ondelete=\"CASCADE\"), nullable=False)\n    buyer_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    currency_code = Column(String, nullable=False, default='USD')\n    status = Column(String, nullable=False, default='placed')\n    fulfillment_status = Column(String, nullable=False, default='manual')\n    private_note = Column(Text)\n    placed_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    fulfilled_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass OrderItem(Base):\n    __tablename__ = \"order_items\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    listing_id = Column(Integer, ForeignKey(\"listings.id\", ondelete=\"RESTRICT\"), nullable=False)\n    quantity = Column(Integer, nullable=False, default=1)\n    unit_price_amount = Column(Float, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass OrderItemVariationSelection(Base):\n    __tablename__ = \"order_item_variation_selections\"\n    order_item_id = Column(Integer, ForeignKey(\"order_items.id\", ondelete=\"CASCADE\"), primary_key=True, nullable=False)\n    variation_id = Column(Integer, ForeignKey(\"listing_variations.id\", ondelete=\"RESTRICT\"), primary_key=True, nullable=False)\n    option_id = Column(Integer, ForeignKey(\"variation_options.id\", ondelete=\"RESTRICT\"), nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass OrderAppliedDiscount(Base):\n    __tablename__ = \"order_applied_discounts\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    source_type = Column(String, nullable=False)\n    source_id = Column(Integer, nullable=False)\n    code = Column(String)\n    discount_amount = Column(Float, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass OrderFeeLine(Base):\n    __tablename__ = \"order_fee_lines\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    fee_type = Column(String, nullable=False)\n    amount = Column(Float, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Refund(Base):\n    __tablename__ = \"refunds\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    amount = Column(Float, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    reason = Column(String, nullable=False)\n    platform_fee_adjustment_amount = Column(Float, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Message(Base):\n    __tablename__ = \"messages\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"orders.id\", ondelete=\"SET NULL\"))\n    shop_id = Column(Integer, ForeignKey(\"shops.id\", ondelete=\"CASCADE\"), nullable=False)\n    sender_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    recipient_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    body = Column(Text, nullable=False)\n    is_private = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass AdminAction(Base):\n    __tablename__ = \"admin_actions\"\n    id = Column(Integer, primary_key=True)\n    actor_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    action_type = Column(String, nullable=False)\n    target_type = Column(String, nullable=False)\n    target_id = Column(Integer, nullable=False)\n    reason = Column(String)\n    message_to_seller = Column(String)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nBase.metadata.create_all(engine)\n\ndef dt_to_iso(dt: datetime) -> str:\n    return dt.replace(microsecond=0).isoformat(\"T\") + \"Z\"\n\nclass CategoryOut(BaseModel):\n    id: int = Field(..., description=\"Category ID\", example=4)\n    name: str = Field(..., description=\"Category name\", example=\"Invitations\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass CategoriesListOut(BaseModel):\n    categories: List[CategoryOut] = Field(..., description=\"Categories array\", example=[{\"id\": 4, \"name\": \"Invitations\"}])\n\nclass TagOut(BaseModel):\n    id: int = Field(..., description=\"Tag ID\", example=4)\n    name: str = Field(..., description=\"Tag name\", example=\"minimalist\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass TagsListOut(BaseModel):\n    tags: List[TagOut] = Field(..., description=\"Tags array\", example=[{\"id\": 4, \"name\": \"minimalist\"}])\n\nclass CreateListingIn(BaseModel):\n    title: str = Field(..., description=\"Listing title\", example=\"Minimalist Wedding Invitation Template (A5)\")\n    category_id: int = Field(..., description=\"Category ID for the listing\", example=4)\n    sku: Optional[str] = Field(None, description=\"Unique SKU for the listing\", example=\"INV-2026-001\")\n    base_price_amount: float = Field(..., description=\"Base price in USD\", example=12.0)\n    currency_code: Optional[str] = Field(None, description=\"Currency code (default USD)\", example=\"USD\")\n    fulfillment_type: str = Field(..., description=\"Fulfillment type: auto/manual\", example=\"auto\")\n    license: str = Field(..., description=\"Default license option (e.g. personal use)\", example=\"personal use\")\n\nclass CreateListingOut(BaseModel):\n    id: int = Field(..., description=\"Listing ID\", example=6732)\n    shop_id: int = Field(..., description=\"Shop ID\", example=120)\n    title: str = Field(..., description=\"Listing title\", example=\"Minimalist Wedding Invitation Template (A5)\")\n    sku: Optional[str] = Field(None, description=\"Listing SKU\", example=\"INV-2026-001\")\n    category_id: Optional[int] = Field(None, description=\"Category ID\", example=4)\n    base_price_amount: float = Field(..., description=\"Listing base price\", example=12.0)\n    currency_code: str = Field(..., description=\"Listing currency\", example=\"USD\")\n    fulfillment_type: str = Field(..., description=\"Fulfillment type\", example=\"auto\")\n    status: str = Field(..., description=\"Listing status\", example=\"active\")\n    created_at: str = Field(..., description=\"Creation datetime\", example=\"2026-02-15T12:45:32Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass ListingTagIn(BaseModel):\n    tags: List[str] = Field(..., description=\"Array of tag names to add\", example=[\"wedding\", \"minimalist\", \"editable\", \"A5\", \"printable\"])\n\nclass ListingTagItemOut(BaseModel):\n    tag_id: int = Field(..., description=\"Tag ID\", example=14)\n    name: str = Field(..., description=\"Tag name\", example=\"wedding\")\n    model_config = ConfigDict(from_attributes=False)\n\nclass ListingTagsOut(BaseModel):\n    listing_id: int = Field(..., description=\"Listing ID\", example=6732)\n    tags: List[ListingTagItemOut] = Field(..., description=\"Tags for listing\", example=[{\"tag_id\": 14, \"name\": \"wedding\"}])\n\nclass FileMetaIn(BaseModel):\n    filename: str = Field(..., description=\"Original file name\", example=\"invitation-A5.pdf\")\n    mime_type: str = Field(..., description=\"MIME type\", example=\"application/pdf\")\n    size_bytes: int = Field(..., description=\"File size in bytes\", example=2457600)\n\nclass ListingFilesIn(BaseModel):\n    files: List[FileMetaIn] = Field(..., description=\"File metadata array\", example=[\n        {\"filename\": \"invitation-template-canva-link.txt\", \"mime_type\": \"text/plain\", \"size_bytes\": 1024},\n        {\"filename\": \"invitation-A5.pdf\", \"mime_type\": \"application/pdf\", \"size_bytes\": 2457600}\n    ])\n\nclass ListingFileOut(BaseModel):\n    id: int = Field(..., description=\"File ID\", example=450)\n    filename: str = Field(..., description=\"Original file name\", example=\"invitation-A5.pdf\")\n    mime_type: str = Field(..., description=\"MIME type\", example=\"application/pdf\")\n    size_bytes: int = Field(..., description=\"File size in bytes\", example=2457600)\n    created_at: str = Field(..., description=\"Upload timestamp\", example=\"2026-02-15T09:45:32Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass ListingFilesOut(BaseModel):\n    listing_id: int = Field(..., description=\"Listing ID\", example=6732)\n    files: List[ListingFileOut] = Field(..., description=\"Attached files\", example=[{\"id\": 450, \"filename\": \"invitation-A5.pdf\", \"mime_type\": \"application/pdf\", \"size_bytes\": 2457600, \"created_at\": \"2026-02-15T09:45:32Z\"}])\n\nclass UpdateListingIn(BaseModel):\n    title: Optional[str] = Field(None, description=\"New listing title\", example=\"Budget Planner Spreadsheet (Google Sheets + Excel)\")\n    base_price_amount: Optional[float] = Field(None, description=\"Updated base price\", example=9.5)\n\nclass UpdateListingOut(BaseModel):\n    id: int = Field(..., description=\"Listing ID\", example=1123)\n    title: str = Field(..., description=\"Listing title\", example=\"Budget Planner Spreadsheet (Google Sheets + Excel)\")\n    base_price_amount: float = Field(..., description=\"Listing base price\", example=9.5)\n    updated_at: str = Field(..., description=\"Last updated timestamp\", example=\"2026-02-14T18:29:20Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass ListingVariationIn(BaseModel):\n    name: str = Field(..., description=\"Variation name\", example=\"License\")\n    position: Optional[int] = Field(0, description=\"Variation position (display order)\", example=0)\n\nclass ListingVariationOut(BaseModel):\n    id: int = Field(..., description=\"Variation ID\", example=980)\n    listing_id: int = Field(..., description=\"Listing ID\", example=4812)\n    name: str = Field(..., description=\"Variation name\", example=\"License\")\n    position: int = Field(..., description=\"Variation position\", example=0)\n    created_at: str = Field(..., description=\"Creation timestamp\", example=\"2026-02-15T09:45:32Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass VariationOptionIn(BaseModel):\n    value: str = Field(..., description=\"Option display value\", example=\"Commercial\")\n    price_delta_amount: Optional[float] = Field(0, description=\"Extra price for this option\", example=25.0)\n\nclass VariationOptionOut(BaseModel):\n    id: int = Field(..., description=\"Option ID\", example=2204)\n    variation_id: int = Field(..., description=\"Variation ID\", example=980)\n    value: str = Field(..., description=\"Option value\", example=\"Commercial\")\n    price_delta_amount: float = Field(..., description=\"Price delta\", example=25.0)\n    model_config = ConfigDict(from_attributes=True)\n\nclass InventoryRuleIn(BaseModel):\n    variation_id: int = Field(..., description=\"Variation ID\", example=3407)\n    option_id: int = Field(..., description=\"Option ID\", example=13085)\n    max_total_sales: Optional[int] = Field(None, description=\"Maximum allowed sales, NULL for unlimited\", example=50)\n\nclass InventoryRuleOut(BaseModel):\n    id: int = Field(..., description=\"Inventory rule ID\", example=46)\n    listing_id: int = Field(..., description=\"Listing ID\", example=7720)\n    variation_id: int = Field(..., description=\"Variation ID\", example=3407)\n    option_id: int = Field(..., description=\"Option ID\", example=13085)\n    max_total_sales: Optional[int] = Field(None, description=\"Sales limit, null=unlimited\", example=50)\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateCouponIn(BaseModel):\n    code: str = Field(..., description=\"Coupon code\", example=\"SPRING20\")\n    discount_type: str = Field(..., description=\"Discount type ('percent')\", example=\"percent\")\n    discount_value: float = Field(..., description=\"Discount value (percent)\", example=20.0)\n    minimum_subtotal_amount: Optional[float] = Field(0, description=\"Minimum subtotal for coupon activation\", example=15.0)\n    starts_at: str = Field(..., description=\"Coupon start date/time (ISO 8601)\", example=\"2026-03-01T00:00:00Z\")\n    ends_at: str = Field(..., description=\"Coupon end date/time (ISO 8601)\", example=\"2026-03-31T23:59:59Z\")\n    max_redemptions: Optional[int] = Field(None, description=\"Maximum redemption count\", example=200)\n\nclass CreateCouponOut(BaseModel):\n    id: int = Field(..., description=\"Coupon ID\", example=886)\n    code: str = Field(..., description=\"Coupon code\", example=\"SPRING20\")\n    discount_type: str = Field(..., description=\"Discount type\", example=\"percent\")\n    discount_value: float = Field(..., description=\"Discount value\", example=20.0)\n    minimum_subtotal_amount: float = Field(..., description=\"Minimum subtotal\", example=15.0)\n    starts_at: str = Field(..., description=\"Coupon start date/time\", example=\"2026-03-01T00:00:00Z\")\n    ends_at: str = Field(..., description=\"Coupon end date/time\", example=\"2026-03-31T23:59:59Z\")\n    max_redemptions: Optional[int] = Field(None, description=\"Maximum redemption count\", example=200)\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateSaleIn(BaseModel):\n    name: Optional[str] = Field(None, description=\"Sale event name\", example=\"72hr Wedding Invitation Sale\")\n    discount_type: str = Field(..., description=\"Discount type ('percent')\", example=\"percent\")\n    discount_value: float = Field(..., description=\"Percent discount\", example=30.0)\n    starts_at: str = Field(..., description=\"Sale start date/time\", example=\"2026-02-20T09:00:00Z\")\n    ends_at: str = Field(..., description=\"Sale end date/time\", example=\"2026-02-23T09:00:00Z\")\n    allow_coupon_stacking: Optional[bool] = Field(True, description=\"Allow stacking with coupons\", example=False)\n\nclass CreateSaleOut(BaseModel):\n    id: int = Field(..., description=\"Sale ID\", example=77)\n    name: Optional[str] = Field(None, description=\"Sale event name\", example=\"72hr Wedding Invitation Sale\")\n    discount_type: str = Field(..., description=\"Discount type\", example=\"percent\")\n    discount_value: float = Field(..., description=\"Percent discount\", example=30.0)\n    starts_at: str = Field(..., description=\"Sale start date/time\", example=\"2026-02-20T09:00:00Z\")\n    ends_at: str = Field(..., description=\"Sale end date/time\", example=\"2026-02-23T09:00:00Z\")\n    allow_coupon_stacking: bool = Field(..., description=\"Coupons stacking allowed\", example=False)\n    model_config = ConfigDict(from_attributes=True)\n\nclass AssignListingToSaleIn(BaseModel):\n    sale_id: int = Field(..., description=\"Sale ID\", example=77)\n    listing_id: int = Field(..., description=\"Listing ID\", example=6633)\n\nclass AssignListingToSaleOut(BaseModel):\n    sale_id: int = Field(..., description=\"Sale ID\", example=77)\n    listing_id: int = Field(..., description=\"Listing ID\", example=6633)\n\nclass AnalyticsListingOut(BaseModel):\n    id: int = Field(..., description=\"Listing ID\", example=5537)\n    title: str = Field(..., description=\"Listing title\", example=\"Minimalist Wedding Invitation Template (A5)\")\n    units_sold: int = Field(..., description=\"Total units sold\", example=23)\n    gross_revenue: float = Field(..., description=\"Total gross revenue\", example=276.0)\n    fees: float = Field(..., description=\"Total fees (platform, processing, etc.)\", example=36.0)\n    net_revenue: float = Field(..., description=\"Gross revenue minus fees\", example=240.0)\n\nclass AnalyticsListingListOut(BaseModel):\n    listings: List[AnalyticsListingOut] = Field(..., description=\"Array of top listings\", example=[\n        {\"id\": 5537, \"title\": \"Minimalist Wedding Invitation Template (A5)\", \"units_sold\": 23, \"gross_revenue\": 276.0, \"fees\": 36.0, \"net_revenue\": 240.0}\n    ])\n\nclass UpdateOrderIn(BaseModel):\n    fulfillment_status: Optional[str] = Field(None, description=\"New fulfillment status ('fulfilled' or 'manual')\", example=\"fulfilled\")\n    private_note: Optional[str] = Field(None, description=\"Private note for the order\", example=\"Sent custom color variant via message on 2026-02-18\")\n\nclass UpdateOrderOut(BaseModel):\n    id: int = Field(..., description=\"Order ID\", example=90517)\n    fulfillment_status: str = Field(..., description=\"Fulfillment status\", example=\"fulfilled\")\n    private_note: Optional[str] = Field(None, description=\"Order private note\", example=\"Sent custom color variant via message on 2026-02-18\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass MessageIn(BaseModel):\n    order_id: int = Field(..., description=\"Order ID for the message\", example=90517)\n    recipient_user_id: int = Field(..., description=\"Buyer User ID\", example=4578)\n    body: str = Field(..., description=\"Message body/content\", example=\"Hi! Your custom color variant is readythanks for your order; please reply if you need any tweaks.\")\n    is_private: Optional[bool] = Field(False, description=\"Private note indicator\", example=False)\n\nclass MessageOut(BaseModel):\n    id: int = Field(..., description=\"Message ID\", example=38922)\n    order_id: Optional[int] = Field(None, description=\"Order ID\", example=90517)\n    recipient_user_id: Optional[int] = Field(None, description=\"Recipient (buyer) user ID\", example=4578)\n    sender_user_id: Optional[int] = Field(None, description=\"Sender user ID (current user)\", example=1)\n    body: str = Field(..., description=\"Message text\", example=\"Hi! Your custom color variant is readythanks for your order; please reply if you need any tweaks.\")\n    is_private: bool = Field(..., description=\"Private note flag\", example=False)\n    created_at: str = Field(..., description=\"Creation timestamp\", example=\"2026-02-18T13:12:45Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateRefundIn(BaseModel):\n    order_id: int = Field(..., description=\"Order ID for refund\", example=89110)\n    amount: float = Field(..., description=\"Refund amount in USD\", example=6.0)\n    reason: str = Field(..., description=\"Reason for refund\", example=\"File duplicated in bundle\")\n    platform_fee_adjustment_amount: Optional[float] = Field(0, description=\"Platform fee adjustment (if applicable)\", example=1.1)\n\nclass CreateRefundOut(BaseModel):\n    id: int = Field(..., description=\"Refund ID\", example=1188)\n    order_id: int = Field(..., description=\"Order ID\", example=89110)\n    amount: float = Field(..., description=\"Refund amount\", example=6.0)\n    reason: str = Field(..., description=\"Refund reason\", example=\"File duplicated in bundle\")\n    platform_fee_adjustment_amount: float = Field(..., description=\"Platform fee adjustment\", example=1.1)\n    created_at: str = Field(..., description=\"Timestamp\", example=\"2026-02-20T19:30:22Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass TakedownListingIn(BaseModel):\n    actor_user_id: int = Field(..., description=\"Admin user ID (must be 1 for this spec)\", example=1)\n    target_listing_id: int = Field(..., description=\"Listing ID to takedown\", example=7001)\n    reason: str = Field(..., description=\"Reason for takedown\", example=\"Policy: trademark infringement\")\n    message_to_seller: str = Field(..., description=\"Notification message to seller\", example=\"Your listing was removed due to trademarked terms in the title; please edit and resubmit without brand names.\")\n\nclass TakedownListingOut(BaseModel):\n    action_id: int = Field(..., description=\"Admin action record ID\", example=357)\n    target_listing_id: int = Field(..., description=\"Listing ID taken down\", example=7001)\n    status: str = Field(..., description=\"Listing status set\", example=\"removed\")\n    removed_reason: str = Field(..., description=\"Listing removed reason\", example=\"Policy: trademark infringement\")\n    message_to_seller: str = Field(..., description=\"Notification message\", example=\"Your listing was removed due to trademarked terms in the title; please edit and resubmit without brand names.\")\n    created_at: str = Field(..., description=\"Action creation timestamp\", example=\"2026-02-18T22:34:05Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SetSellerVerificationIn(BaseModel):\n    actor_user_id: int = Field(..., description=\"Admin user ID\", example=1)\n    target_user_id: int = Field(..., description=\"User ID whose verification is updated\", example=322)\n    verification_status: str = Field(..., description=\"New verification status ('review_required')\", example=\"review_required\")\n    reason: Optional[str] = Field(None, description=\"Reason for status change\", example=\"Trademark review pending\")\n\nclass SetSellerVerificationOut(BaseModel):\n    action_id: int = Field(..., description=\"Admin action record ID\", example=498)\n    user_id: int = Field(..., description=\"Affected user ID\", example=322)\n    verification_status: str = Field(..., description=\"Current verification status\", example=\"review_required\")\n    reason: Optional[str] = Field(None, description=\"Reason for status change\", example=\"Trademark review pending\")\n    created_at: str = Field(..., description=\"Action creation timestamp\", example=\"2026-02-18T22:35:05Z\")\n\n@app.post(\n    \"/api/listings\",\n    summary=\"Create a new digital product listing\",\n    description=\"Add a new listing to the current user's shop with product details and meta.\",\n    tags=[\"listings\"],\n    operation_id=\"create_listing\",\n    response_model=CreateListingOut\n)\nasync def create_listing(body: CreateListingIn = Body(...)) -> CreateListingOut:\n    session = SessionLocal()\n    shop = session.query(Shop).filter(Shop.owner_user_id == 1).first()\n    data = body.dict()\n    listing = Listing(\n        shop_id=shop.id,\n        sku=data.get(\"sku\"),\n        title=data[\"title\"],\n        category_id=data.get(\"category_id\"),\n        base_price_amount=data[\"base_price_amount\"],\n        currency_code=data.get(\"currency_code\") or \"USD\",\n        fulfillment_type=data.get(\"fulfillment_type\"),\n        status=\"active\",\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(listing)\n    session.commit()\n    out = CreateListingOut(\n        id=listing.id,\n        shop_id=listing.shop_id,\n        title=listing.title,\n        sku=listing.sku,\n        category_id=listing.category_id,\n        base_price_amount=listing.base_price_amount,\n        currency_code=listing.currency_code,\n        fulfillment_type=listing.fulfillment_type,\n        status=listing.status,\n        created_at=dt_to_iso(listing.created_at)\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/listings/{listing_id}/tags\",\n    summary=\"Add tags to a listing\",\n    description=\"Attach one or more tags to the listing. Use to set or update keywords for discoverability.\",\n    tags=[\"listings\", \"tags\"],\n    operation_id=\"add_listing_tags\",\n    response_model=ListingTagsOut\n)\nasync def add_listing_tags(\n    listing_id: int = Path(..., description=\"Unique listing ID\", example=6732),\n    body: ListingTagIn = Body(...)\n) -> ListingTagsOut:\n    session = SessionLocal()\n    listing = session.query(Listing).filter(Listing.id == listing_id).first()\n    tags_out = []\n    for tag_name in body.tags:\n        tag = session.query(Tag).filter(Tag.name == tag_name).first()\n        if not tag:\n            tag = Tag(name=tag_name)\n            session.add(tag)\n            session.commit()\n        lt = session.query(ListingTag).filter(ListingTag.listing_id == listing_id, ListingTag.tag_id == tag.id).first()\n        if not lt:\n            listing_tag = ListingTag(listing_id=listing_id, tag_id=tag.id, created_at=datetime.utcnow())\n            session.add(listing_tag)\n            session.commit()\n        tags_out.append(ListingTagItemOut(tag_id=tag.id, name=tag.name))\n    result = ListingTagsOut(listing_id=listing_id, tags=tags_out)\n    session.close()\n    return result\n\n@app.post(\n    \"/api/listings/{listing_id}/files\",\n    summary=\"Attach files to a listing\",\n    description=\"Uploads files and attaches each to the listing with metadata. Use to provide digital assets.\",\n    tags=[\"listings\", \"files\"],\n    operation_id=\"add_listing_files\",\n    response_model=ListingFilesOut\n)\nasync def add_listing_files(\n    listing_id: int = Path(..., description=\"Listing ID\", example=6732),\n    body: ListingFilesIn = Body(...)\n) -> ListingFilesOut:\n    session = SessionLocal()\n    files_objs = []\n    for file in body.files:\n        lf = ListingFile(\n            listing_id=listing_id,\n            filename=file.filename,\n            mime_type=file.mime_type,\n            size_bytes=file.size_bytes,\n            created_at=datetime.utcnow(),\n            updated_at=datetime.utcnow()\n        )\n        session.add(lf)\n        session.commit()\n        files_objs.append(ListingFileOut(\n            id=lf.id,\n            filename=lf.filename,\n            mime_type=lf.mime_type,\n            size_bytes=lf.size_bytes,\n            created_at=dt_to_iso(lf.created_at)\n        ))\n    out = ListingFilesOut(listing_id=listing_id, files=files_objs)\n    session.close()\n    return out\n\n@app.patch(\n    \"/api/listings/{listing_id}\",\n    summary=\"Update listing fields\",\n    description=\"Modify selected listing fields. Use to update title, price, or status.\",\n    tags=[\"listings\"],\n    operation_id=\"update_listing\",\n    response_model=UpdateListingOut\n)\nasync def update_listing(\n    listing_id: int = Path(..., description=\"Listing ID\", example=1123),\n    body: UpdateListingIn = Body(...)\n) -> UpdateListingOut:\n    session = SessionLocal()\n    listing = session.query(Listing).filter(Listing.id == listing_id).first()\n    updated = False\n    if body.title is not None:\n        listing.title = body.title\n        updated = True\n    if body.base_price_amount is not None:\n        listing.base_price_amount = body.base_price_amount\n        updated = True\n    if updated:\n        listing.updated_at = datetime.utcnow()\n    session.commit()\n    out = UpdateListingOut(\n        id=listing.id,\n        title=listing.title,\n        base_price_amount=listing.base_price_amount,\n        updated_at=dt_to_iso(listing.updated_at)\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/listings/{listing_id}/variations\",\n    summary=\"Create a variation for a listing\",\n    description=\"Defines a new variation for a listing, e.g., license or file format.\",\n    tags=[\"listings\", \"variations\"],\n    operation_id=\"create_listing_variation\",\n    response_model=ListingVariationOut\n)\nasync def create_listing_variation(\n    listing_id: int = Path(..., description=\"Listing ID\", example=4812),\n    body: ListingVariationIn = Body(...)\n) -> ListingVariationOut:\n    session = SessionLocal()\n    variation = ListingVariation(\n        listing_id=listing_id,\n        name=body.name,\n        position=body.position if body.position is not None else 0,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(variation)\n    session.commit()\n    out = ListingVariationOut(\n        id=variation.id,\n        listing_id=variation.listing_id,\n        name=variation.name,\n        position=variation.position,\n        created_at=dt_to_iso(variation.created_at)\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/listing_variations/{variation_id}/options\",\n    summary=\"Create variation option\",\n    description=\"Adds a new option to a variation (e.g. Personal or Commercial license).\",\n    tags=[\"variations\"],\n    operation_id=\"create_variation_option\",\n    response_model=VariationOptionOut\n)\nasync def create_variation_option(\n    variation_id: int = Path(..., description=\"Variation ID\", example=980),\n    body: VariationOptionIn = Body(...)\n) -> VariationOptionOut:\n    session = SessionLocal()\n    opt = VariationOption(\n        variation_id=variation_id,\n        value=body.value,\n        price_delta_amount=body.price_delta_amount if body.price_delta_amount is not None else 0,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(opt)\n    session.commit()\n    out = VariationOptionOut(\n        id=opt.id,\n        variation_id=opt.variation_id,\n        value=opt.value,\n        price_delta_amount=opt.price_delta_amount\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/listings/{listing_id}/inventory_rules\",\n    summary=\"Create inventory rule for a variation option\",\n    description=\"Adds inventory limit for a variation option for this listing. Use NULL for unlimited.\",\n    tags=[\"inventory\", \"listings\"],\n    operation_id=\"create_inventory_rule\",\n    response_model=InventoryRuleOut\n)\nasync def create_inventory_rule(\n    listing_id: int = Path(..., description=\"Listing ID\", example=7720),\n    body: InventoryRuleIn = Body(...)\n) -> InventoryRuleOut:\n    session = SessionLocal()\n    inv = ListingInventoryRule(\n        listing_id=listing_id,\n        variation_id=body.variation_id,\n        option_id=body.option_id,\n        max_total_sales=body.max_total_sales,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(inv)\n    session.commit()\n    out = InventoryRuleOut(\n        id=inv.id,\n        listing_id=inv.listing_id,\n        variation_id=inv.variation_id,\n        option_id=inv.option_id,\n        max_total_sales=inv.max_total_sales\n    )\n    session.close()\n    return out\n\n@app.get(\n    \"/api/tags\",\n    summary=\"List all tags\",\n    description=\"Returns all available tags in the platform. Use for autocomplete or search.\",\n    tags=[\"tags\"],\n    operation_id=\"list_tags\",\n    response_model=TagsListOut\n)\nasync def list_tags() -> TagsListOut:\n    session = SessionLocal()\n    tags = session.query(Tag).all()\n    tags_objs = [TagOut(id=tag.id, name=tag.name) for tag in tags]\n    session.close()\n    return TagsListOut(tags=tags_objs)\n\n@app.get(\n    \"/api/categories\",\n    summary=\"List all categories\",\n    description=\"Fetches all product categories. Use to populate category dropdowns.\",\n    tags=[\"categories\"],\n    operation_id=\"list_categories\",\n    response_model=CategoriesListOut\n)\nasync def list_categories() -> CategoriesListOut:\n    session = SessionLocal()\n    cats = session.query(Category).all()\n    cats_objs = [CategoryOut(id=cat.id, name=cat.name) for cat in cats]\n    session.close()\n    return CategoriesListOut(categories=cats_objs)\n\n@app.post(\n    \"/api/coupons\",\n    summary=\"Create a coupon code for the shop\",\n    description=\"Adds a discount coupon to the authenticated user's shop. Use for shop-wide promotions.\",\n    tags=[\"coupons\"],\n    operation_id=\"create_coupon\",\n    response_model=CreateCouponOut\n)\nasync def create_coupon(body: CreateCouponIn = Body(...)) -> CreateCouponOut:\n    session = SessionLocal()\n    shop = session.query(Shop).filter(Shop.owner_user_id == 1).first()\n    coupon = Coupon(\n        shop_id=shop.id,\n        code=body.code,\n        discount_type=body.discount_type,\n        discount_value=body.discount_value,\n        minimum_subtotal_amount=body.minimum_subtotal_amount if body.minimum_subtotal_amount is not None else 0,\n        currency_code=\"USD\",\n        starts_at=datetime.fromisoformat(body.starts_at.replace(\"Z\", \"+00:00\")),\n        ends_at=datetime.fromisoformat(body.ends_at.replace(\"Z\", \"+00:00\")),\n        max_redemptions=body.max_redemptions,\n        is_active=1,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(coupon)\n    session.commit()\n    out = CreateCouponOut(\n        id=coupon.id,\n        code=coupon.code,\n        discount_type=coupon.discount_type,\n        discount_value=coupon.discount_value,\n        minimum_subtotal_amount=coupon.minimum_subtotal_amount,\n        starts_at=dt_to_iso(coupon.starts_at),\n        ends_at=dt_to_iso(coupon.ends_at),\n        max_redemptions=coupon.max_redemptions\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/sales\",\n    summary=\"Create a sale for the shop\",\n    description=\"Adds a sale event to the authenticated user's shop with percent discount and duration.\",\n    tags=[\"sales\"],\n    operation_id=\"create_sale\",\n    response_model=CreateSaleOut\n)\nasync def create_sale(body: CreateSaleIn = Body(...)) -> CreateSaleOut:\n    session = SessionLocal()\n    shop = session.query(Shop).filter(Shop.owner_user_id == 1).first()\n    allow_coupon_stacking = 1 if body.allow_coupon_stacking is None or body.allow_coupon_stacking else 0 if body.allow_coupon_stacking is False else 1\n    if body.allow_coupon_stacking is not None:\n        allow_coupon_stacking = 1 if body.allow_coupon_stacking else 0\n    sale = Sale(\n        shop_id=shop.id,\n        name=body.name,\n        discount_type=body.discount_type,\n        discount_value=body.discount_value,\n        starts_at=datetime.fromisoformat(body.starts_at.replace(\"Z\", \"+00:00\")),\n        ends_at=datetime.fromisoformat(body.ends_at.replace(\"Z\", \"+00:00\")),\n        allow_coupon_stacking=allow_coupon_stacking,\n        is_active=1,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(sale)\n    session.commit()\n    out = CreateSaleOut(\n        id=sale.id,\n        name=sale.name,\n        discount_type=sale.discount_type,\n        discount_value=sale.discount_value,\n        starts_at=dt_to_iso(sale.starts_at),\n        ends_at=dt_to_iso(sale.ends_at),\n        allow_coupon_stacking=bool(sale.allow_coupon_stacking)\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/sale_listings\",\n    summary=\"Assign listing to sale\",\n    description=\"Links a listing to a sale event for discount activation. Use after creating a sale.\",\n    tags=[\"sales\", \"listings\"],\n    operation_id=\"assign_listing_to_sale\",\n    response_model=AssignListingToSaleOut\n)\nasync def assign_listing_to_sale(body: AssignListingToSaleIn = Body(...)) -> AssignListingToSaleOut:\n    session = SessionLocal()\n    obj = SaleListing(\n        sale_id=body.sale_id,\n        listing_id=body.listing_id,\n        created_at=datetime.utcnow()\n    )\n    session.add(obj)\n    session.commit()\n    session.close()\n    return AssignListingToSaleOut(\n        sale_id=body.sale_id,\n        listing_id=body.listing_id\n    )\n\n@app.get(\n    \"/api/listings/top\",\n    summary=\"Get top N listings by shop revenue\",\n    description=\"Returns top listings by revenue for date range. Use for sales analytics/reporting.\",\n    tags=[\"analytics\", \"listings\"],\n    operation_id=\"listings_top_by_revenue\",\n    response_model=AnalyticsListingListOut\n)\nasync def listings_top_by_revenue(\n    start_date: str = Query(..., description=\"Range start date (ISO 8601)\", example=\"2026-01-01\"),\n    end_date: str = Query(..., description=\"Range end date (ISO 8601)\", example=\"2026-01-31\"),\n    limit: Optional[int] = Query(5, description=\"Max result count\", example=5)\n) -> AnalyticsListingListOut:\n    session = SessionLocal()\n    shop = session.query(Shop).filter(Shop.owner_user_id == 1).first()\n    start_dt = datetime.fromisoformat(start_date)\n    end_dt = datetime.fromisoformat(end_date)\n    orders_query = session.query(Order.id).filter(\n        Order.shop_id == shop.id,\n        Order.placed_at >= start_dt,\n        Order.placed_at <= end_dt\n    ).subquery()\n    stats = []\n    listing_ids_query = session.query(OrderItem.listing_id).join(Order, Order.id == OrderItem.order_id).filter(\n        Order.shop_id == shop.id,\n        Order.placed_at >= start_dt,\n        Order.placed_at <= end_dt\n    ).group_by(OrderItem.listing_id)\n    listing_ids = [row[0] for row in listing_ids_query]\n    for lid in listing_ids:\n        title = session.query(Listing.title).filter(Listing.id == lid).scalar()\n        items = session.query(OrderItem).join(Order, Order.id == OrderItem.order_id).filter(\n            OrderItem.listing_id == lid,\n            Order.shop_id == shop.id,\n            Order.placed_at >= start_dt,\n            Order.placed_at <= end_dt\n        ).all()\n        units_sold = sum(item.quantity for item in items)\n        gross_revenue = sum(item.quantity * item.unit_price_amount for item in items)\n        order_ids = {item.order_id for item in items}\n        fees = float(session.query(OrderFeeLine).filter(OrderFeeLine.order_id.in_(order_ids)).with_entities(func.coalesce(func.sum(OrderFeeLine.amount), 0.0)).scalar() or 0.0) if order_ids else 0.0\n        net_revenue = gross_revenue - fees\n        stats.append(AnalyticsListingOut(\n            id=lid,\n            title=title,\n            units_sold=units_sold,\n            gross_revenue=gross_revenue,\n            fees=fees,\n            net_revenue=net_revenue\n        ))\n    stats = sorted(stats, key=lambda x: x.gross_revenue, reverse=True)\n    session.close()\n    return AnalyticsListingListOut(listings=stats[:limit])\n\nfrom sqlalchemy import func\n\n@app.patch(\n    \"/api/orders/{order_id}\",\n    summary=\"Update order fulfillment status and private note\",\n    description=\"Sets fulfillment to fulfilled and adds private note. For converting completed manual orders.\",\n    tags=[\"orders\"],\n    operation_id=\"update_order_fulfillment_and_note\",\n    response_model=UpdateOrderOut\n)\nasync def update_order_fulfillment_and_note(\n    order_id: int = Path(..., description=\"Order ID to update\", example=90517),\n    body: UpdateOrderIn = Body(...)\n) -> UpdateOrderOut:\n    session = SessionLocal()\n    order = session.query(Order).filter(Order.id == order_id).first()\n    if body.fulfillment_status is not None:\n        order.fulfillment_status = body.fulfillment_status\n    if body.private_note is not None:\n        order.private_note = body.private_note\n    session.commit()\n    out = UpdateOrderOut(\n        id=order.id,\n        fulfillment_status=order.fulfillment_status,\n        private_note=order.private_note\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/messages\",\n    summary=\"Send a message to a buyer\",\n    description=\"Sends a message linked to an order from seller to buyer. Use for communication and proof of fulfillment.\",\n    tags=[\"messages\", \"orders\"],\n    operation_id=\"send_order_message\",\n    response_model=MessageOut\n)\nasync def send_order_message(body: MessageIn = Body(...)) -> MessageOut:\n    session = SessionLocal()\n    order = session.query(Order).filter(Order.id == body.order_id).first()\n    shop_id = order.shop_id\n    obj = Message(\n        order_id=body.order_id,\n        shop_id=shop_id,\n        sender_user_id=1,\n        recipient_user_id=body.recipient_user_id,\n        body=body.body,\n        is_private=1 if body.is_private else 0,\n        created_at=datetime.utcnow()\n    )\n    session.add(obj)\n    session.commit()\n    out = MessageOut(\n        id=obj.id,\n        order_id=obj.order_id,\n        recipient_user_id=obj.recipient_user_id,\n        sender_user_id=obj.sender_user_id,\n        body=obj.body,\n        is_private=bool(obj.is_private),\n        created_at=dt_to_iso(obj.created_at)\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/refunds\",\n    summary=\"Issue a refund for an order\",\n    description=\"Records a refund for an order, specifying amount, reason, and platform fee adjustment if required.\",\n    tags=[\"refunds\", \"orders\"],\n    operation_id=\"create_refund\",\n    response_model=CreateRefundOut\n)\nasync def create_refund(body: CreateRefundIn = Body(...)) -> CreateRefundOut:\n    session = SessionLocal()\n    ref = Refund(\n        order_id=body.order_id,\n        amount=body.amount,\n        reason=body.reason,\n        platform_fee_adjustment_amount=body.platform_fee_adjustment_amount if body.platform_fee_adjustment_amount is not None else 0,\n        currency_code=\"USD\",\n        created_at=datetime.utcnow()\n    )\n    session.add(ref)\n    session.commit()\n    out = CreateRefundOut(\n        id=ref.id,\n        order_id=ref.order_id,\n        amount=ref.amount,\n        reason=ref.reason,\n        platform_fee_adjustment_amount=ref.platform_fee_adjustment_amount,\n        created_at=dt_to_iso(ref.created_at)\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/admin_actions/takedown_listing\",\n    summary=\"Admin takedown of a listing\",\n    description=\"Records an admin takedown for a listing and updates status/notify seller. Used for policy violations.\",\n    tags=[\"admin\", \"listings\"],\n    operation_id=\"admin_takedown_listing\",\n    response_model=TakedownListingOut\n)\nasync def admin_takedown_listing(body: TakedownListingIn = Body(...)) -> TakedownListingOut:\n    session = SessionLocal()\n    listing = session.query(Listing).filter(Listing.id == body.target_listing_id).first()\n    listing.status = \"removed\"\n    listing.removed_reason = body.reason\n    listing.removed_by_user_id = body.actor_user_id\n    listing.removed_at = datetime.utcnow()\n    action = AdminAction(\n        actor_user_id=body.actor_user_id,\n        action_type=\"takedown_listing\",\n        target_type=\"listing\",\n        target_id=body.target_listing_id,\n        reason=body.reason,\n        message_to_seller=body.message_to_seller,\n        created_at=datetime.utcnow()\n    )\n    session.add(action)\n    session.commit()\n    out = TakedownListingOut(\n        action_id=action.id,\n        target_listing_id=listing.id,\n        status=listing.status,\n        removed_reason=listing.removed_reason,\n        message_to_seller=action.message_to_seller,\n        created_at=dt_to_iso(action.created_at)\n    )\n    session.close()\n    return out\n\n@app.post(\n    \"/api/admin_actions/set_seller_verification\",\n    summary=\"Admin sets seller verification status\",\n    description=\"Updates seller verification status and logs admin action. Use for review-required cases.\",\n    tags=[\"admin\", \"users\"],\n    operation_id=\"admin_set_seller_verification\",\n    response_model=SetSellerVerificationOut\n)\nasync def admin_set_seller_verification(body: SetSellerVerificationIn = Body(...)) -> SetSellerVerificationOut:\n    session = SessionLocal()\n    user = session.query(User).filter(User.id == body.target_user_id).first()\n    user.verification_status = body.verification_status\n    action = AdminAction(\n        actor_user_id=body.actor_user_id,\n        action_type=\"set_seller_verification_status\",\n        target_type=\"user\",\n        target_id=body.target_user_id,\n        reason=body.reason,\n        message_to_seller=None,\n        created_at=datetime.utcnow()\n    )\n    session.add(action)\n    session.commit()\n    out = SetSellerVerificationOut(\n        action_id=action.id,\n        user_id=body.target_user_id,\n        verification_status=body.verification_status,\n        reason=body.reason,\n        created_at=dt_to_iso(action.created_at)\n    )\n    session.close()\n    return out\n\nif __name__ == \"__main__\":\n    import uvicorn, os\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
{"scenario": "Rover", "db_path": "./outputs/databases/rover.db", "full_code": "import os\nfrom fastapi import FastAPI, Query, Path, Body, Depends\nfrom sqlalchemy import create_engine, Column, Integer, String, Float, Boolean, DateTime, ForeignKey, Text, UniqueConstraint, Date, CheckConstraint, Index\nfrom sqlalchemy.orm import declarative_base, relationship, sessionmaker\nfrom typing import Optional, List, Dict\nfrom datetime import datetime, date, time\nfrom pydantic import BaseModel, Field, ConfigDict\n\nDATABASE_PATH = os.getenv(\"DATABASE_PATH\", \"sqlite:///xxxx.db\")\nengine = create_engine(DATABASE_PATH, connect_args={\"check_same_thread\": False})\nBase = declarative_base()\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\n\napp = FastAPI(title=\"Simplified Rover API (Simulated)\", version=\"1.0.0\")\n\nclass User(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, unique=True, nullable=False)\n    email = Column(String, unique=True, nullable=False)\n    full_name = Column(String)\n    phone = Column(String)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Pet(Base):\n    __tablename__ = \"pets\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    species = Column(String, nullable=False)\n    breed = Column(String)\n    sex = Column(String)\n    birth_date = Column(Date)\n    age_years = Column(Integer)\n    behavior_notes = Column(Text)\n    emergency_contact_name = Column(String)\n    emergency_contact_phone = Column(String)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass PetVaccination(Base):\n    __tablename__ = \"pet_vaccinations\"\n    id = Column(Integer, primary_key=True)\n    pet_id = Column(Integer, ForeignKey(\"pets.id\", ondelete=\"CASCADE\"), nullable=False)\n    vaccine_type = Column(String, nullable=False)\n    administered_on = Column(Date, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass ServiceListing(Base):\n    __tablename__ = \"service_listings\"\n    id = Column(Integer, primary_key=True)\n    sitter_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    service_type = Column(String, nullable=False)\n    title = Column(String)\n    description = Column(Text)\n    house_rules = Column(Text)\n    price_amount = Column(Float, nullable=False)\n    price_unit = Column(String, nullable=False)\n    currency = Column(String, nullable=False, default=\"USD\")\n    base_postal_code = Column(String, nullable=False)\n    service_radius_miles = Column(Float, nullable=False)\n    city = Column(String)\n    state = Column(String)\n    active = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass ServiceAvailabilityRule(Base):\n    __tablename__ = \"service_availability_rules\"\n    id = Column(Integer, primary_key=True)\n    service_listing_id = Column(Integer, ForeignKey(\"service_listings.id\", ondelete=\"CASCADE\"), nullable=False)\n    start_date = Column(Date, nullable=False)\n    day_of_week = Column(Integer, nullable=False)\n    start_time = Column(String, nullable=False)\n    end_time = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass ServiceBlackout(Base):\n    __tablename__ = \"service_blackouts\"\n    id = Column(Integer, primary_key=True)\n    service_listing_id = Column(Integer, ForeignKey(\"service_listings.id\", ondelete=\"CASCADE\"), nullable=False)\n    start_datetime = Column(DateTime, nullable=False)\n    end_datetime = Column(DateTime, nullable=False)\n    reason = Column(String)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass ServiceCapacity(Base):\n    __tablename__ = \"service_capacity\"\n    id = Column(Integer, primary_key=True)\n    service_listing_id = Column(Integer, ForeignKey(\"service_listings.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    max_dogs_per_night = Column(Integer, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass SitterDailyMetric(Base):\n    __tablename__ = \"sitter_daily_metrics\"\n    id = Column(Integer, primary_key=True)\n    sitter_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    metric_date = Column(Date, nullable=False)\n    avg_rating = Column(Float)\n    rating_count = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Booking(Base):\n    __tablename__ = \"bookings\"\n    id = Column(Integer, primary_key=True)\n    booking_code = Column(String, nullable=False, unique=True)\n    service_listing_id = Column(Integer, ForeignKey(\"service_listings.id\", ondelete=\"RESTRICT\"), nullable=False)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    sitter_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    pet_id = Column(Integer, ForeignKey(\"pets.id\", ondelete=\"RESTRICT\"), nullable=False)\n    status = Column(String, nullable=False)\n    start_datetime = Column(DateTime, nullable=False)\n    end_datetime = Column(DateTime, nullable=False)\n    duration_minutes = Column(Integer)\n    owner_message = Column(Text)\n    cancellation_reason_code = Column(String)\n    canceled_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    canceled_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass PromoCode(Base):\n    __tablename__ = \"promo_codes\"\n    id = Column(Integer, primary_key=True)\n    code = Column(String, nullable=False, unique=True)\n    discount_type = Column(String, nullable=False)\n    discount_value = Column(Float, nullable=False)\n    currency = Column(String, nullable=False, default=\"USD\")\n    active = Column(Integer, nullable=False, default=1)\n    starts_at = Column(DateTime)\n    ends_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass BookingPricing(Base):\n    __tablename__ = \"booking_pricing\"\n    id = Column(Integer, primary_key=True)\n    booking_id = Column(Integer, ForeignKey(\"bookings.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    currency = Column(String, nullable=False, default=\"USD\")\n    base_amount = Column(Float, nullable=False)\n    promo_code_id = Column(Integer, ForeignKey(\"promo_codes.id\", ondelete=\"SET NULL\"))\n    promo_discount_amount = Column(Float, nullable=False, default=0)\n    platform_fee_amount = Column(Float, nullable=False, default=0)\n    total_amount = Column(Float, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Payment(Base):\n    __tablename__ = \"payments\"\n    id = Column(Integer, primary_key=True)\n    booking_id = Column(Integer, ForeignKey(\"bookings.id\", ondelete=\"CASCADE\"), nullable=False)\n    payer_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    amount = Column(Float, nullable=False)\n    currency = Column(String, nullable=False, default=\"USD\")\n    status = Column(String, nullable=False)\n    method_type = Column(String, nullable=False)\n    external_reference = Column(String)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass RefundRequest(Base):\n    __tablename__ = \"refund_requests\"\n    id = Column(Integer, primary_key=True)\n    booking_id = Column(Integer, ForeignKey(\"bookings.id\", ondelete=\"CASCADE\"), nullable=False)\n    payment_id = Column(Integer, ForeignKey(\"payments.id\", ondelete=\"SET NULL\"))\n    requested_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    requested_amount = Column(Float)\n    refund_to_original_method = Column(Integer, nullable=False, default=1)\n    eligibility_status = Column(String, nullable=False, default=\"unknown\")\n    status = Column(String, nullable=False, default=\"requested\")\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass MessageThread(Base):\n    __tablename__ = \"message_threads\"\n    id = Column(Integer, primary_key=True)\n    thread_code = Column(String, nullable=False, unique=True)\n    booking_id = Column(Integer, ForeignKey(\"bookings.id\", ondelete=\"SET NULL\"))\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    sitter_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Message(Base):\n    __tablename__ = \"messages\"\n    id = Column(Integer, primary_key=True)\n    message_code = Column(String, nullable=False, unique=True)\n    thread_id = Column(Integer, ForeignKey(\"message_threads.id\", ondelete=\"CASCADE\"), nullable=False)\n    sender_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    body = Column(Text, nullable=False)\n    sent_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass VisitReport(Base):\n    __tablename__ = \"visit_reports\"\n    id = Column(Integer, primary_key=True)\n    booking_id = Column(Integer, ForeignKey(\"bookings.id\", ondelete=\"CASCADE\"), nullable=False)\n    report_datetime = Column(DateTime, nullable=False)\n    potty_notes = Column(Text)\n    meal_notes = Column(Text)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass VisitReportPhoto(Base):\n    __tablename__ = \"visit_report_photos\"\n    id = Column(Integer, primary_key=True)\n    visit_report_id = Column(Integer, ForeignKey(\"visit_reports.id\", ondelete=\"CASCADE\"), nullable=False)\n    taken_at = Column(String, nullable=False)\n    caption = Column(String)\n    storage_key = Column(String)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass Fee(Base):\n    __tablename__ = \"fees\"\n    id = Column(Integer, primary_key=True)\n    booking_id = Column(Integer, ForeignKey(\"bookings.id\", ondelete=\"CASCADE\"), nullable=False)\n    fee_type = Column(String, nullable=False)\n    amount = Column(Float, nullable=False)\n    currency = Column(String, nullable=False, default=\"USD\")\n    charged = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nclass SupportTicket(Base):\n    __tablename__ = \"support_tickets\"\n    id = Column(Integer, primary_key=True)\n    ticket_code = Column(String, nullable=False, unique=True)\n    created_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    booking_id = Column(Integer, ForeignKey(\"bookings.id\", ondelete=\"SET NULL\"))\n    related_thread_id = Column(Integer, ForeignKey(\"message_threads.id\", ondelete=\"SET NULL\"))\n    category = Column(String, nullable=False)\n    subject = Column(String)\n    description = Column(Text, nullable=False)\n    status = Column(String, nullable=False, default=\"open\")\n    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow)\n\nBase.metadata.create_all(engine)\n\n# -------------------------- Pydantic Models ----------------------------\nclass PetCreateRequest(BaseModel):\n    name: str = Field(..., description=\"Pet's name\", example=\"Milo\")\n    species: str = Field(..., description=\"Species of the pet\", example=\"dog\")\n    breed: Optional[str] = Field(None, description=\"Breed of the pet\", example=\"Golden Retriever\")\n    sex: Optional[str] = Field(None, description=\"Sex of the pet\", example=\"male\")\n    age_years: Optional[int] = Field(None, description=\"Age of pet in years\", example=3)\n    birth_date: Optional[str] = Field(None, description=\"Birth date (YYYY-MM-DD)\", example=\"2021-07-10\")\n    behavior_notes: Optional[str] = Field(None, description=\"Behavior notes for the pet\", example=\"friendly with dogs, nervous around fireworks\")\n    emergency_contact_name: Optional[str] = Field(None, description=\"Emergency contact person's name\", example=\"Sara Kim\")\n    emergency_contact_phone: Optional[str] = Field(None, description=\"Emergency contact phone number\", example=\"+1-415-555-0139\")\n\nclass PetResponse(BaseModel):\n    id: int = Field(..., description=\"Newly created pet's ID\", example=11)\n    owner_user_id: int = Field(..., description=\"Owner user id (auto set as 1)\", example=1)\n    name: str = Field(..., description=\"Pet name\", example=\"Milo\")\n    species: str = Field(..., description=\"Pet species\", example=\"dog\")\n    breed: Optional[str] = Field(None, description=\"Pet breed\", example=\"Golden Retriever\")\n    sex: Optional[str] = Field(None, description=\"Pet sex\", example=\"male\")\n    birth_date: Optional[str] = Field(None, description=\"Birth date\", example=\"2021-07-10\")\n    age_years: Optional[int] = Field(None, description=\"Pet's age in years (if provided)\", example=3)\n    behavior_notes: Optional[str] = Field(None, description=\"Behavior notes\", example=\"friendly with dogs, nervous around fireworks\")\n    emergency_contact_name: Optional[str] = Field(None, description=\"Emergency contact's name\", example=\"Sara Kim\")\n    emergency_contact_phone: Optional[str] = Field(None, description=\"Emergency contact's number\", example=\"+1-415-555-0139\")\n    created_at: str = Field(..., description=\"Creation timestamp\", example=\"2024-06-03T12:00:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass PetVaccinationCreateRequest(BaseModel):\n    pet_id: int = Field(..., description=\"ID of the owned pet\", example=11)\n    vaccine_type: str = Field(..., description=\"Type of vaccine: rabies or dhpp\", example=\"rabies\")\n    administered_on: str = Field(..., description=\"Date vaccine was administered (YYYY-MM-DD)\", example=\"2025-01-10\")\n\nclass PetVaccinationResponse(BaseModel):\n    id: int = Field(..., description=\"Vaccination record ID\", example=1)\n    pet_id: int = Field(..., description=\"Pet ID this vaccination belongs to\", example=11)\n    vaccine_type: str = Field(..., description=\"Vaccine type\", example=\"rabies\")\n    administered_on: str = Field(..., description=\"Date administered\", example=\"2025-01-10\")\n    created_at: str = Field(..., description=\"Creation timestamp\", example=\"2024-06-03T12:00:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SearchWalkersResultItem(BaseModel):\n    service_listing_id: int = Field(..., description=\"Service listing ID\", example=51)\n    sitter_user_id: int = Field(..., description=\"Sitter's user ID\", example=42)\n    sitter_name: str = Field(..., description=\"Sitter's display name\", example=\"Jordan Lee\")\n    per_walk_rate: float = Field(..., description=\"Price per walk\", example=20.0)\n    currency: str = Field(..., description=\"Currency code\", example=\"USD\")\n    avg_rating: Optional[float] = Field(None, description=\"Average sitter rating on date\", example=4.92)\n\nclass SearchWalkersResponse(BaseModel):\n    results: List[SearchWalkersResultItem] = Field(..., description=\"Matching sitters and their walk details\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass ServiceListingCreateRequest(BaseModel):\n    service_type: str = Field(..., description=\"Service type\", example=\"drop_in\")\n    title: Optional[str] = Field(None, description=\"Service title\", example=\"Drop-in visit\")\n    description: Optional[str] = Field(None, description=\"Service description\", example=\"Care for your pet at your home\")\n    house_rules: Optional[str] = Field(None, description=\"House rules for this service\", example=\"no off-leash, no dog parks\")\n    price_amount: float = Field(..., description=\"Price for this service (per unit)\", example=28.0)\n    price_unit: str = Field(..., description=\"Unit for the price\", example=\"per_visit\")\n    currency: Optional[str] = Field(None, description=\"Currency code\", example=\"USD\")\n    base_postal_code: str = Field(..., description=\"Listing's base postal code\", example=\"11211\")\n    service_radius_miles: float = Field(..., description=\"Radius of service area in miles\", example=3.0)\n    city: Optional[str] = Field(None, description=\"City served\", example=\"Brooklyn\")\n    state: Optional[str] = Field(None, description=\"State served\", example=\"NY\")\n\nclass ServiceListingResponse(BaseModel):\n    id: int = Field(..., description=\"Service listing ID\", example=100)\n    sitter_user_id: int = Field(..., description=\"Sitter's user ID (auto set)\", example=1)\n    service_type: str = Field(..., description=\"Service type\", example=\"drop_in\")\n    price_amount: float = Field(..., description=\"Service price amount\", example=28.0)\n    price_unit: str = Field(..., description=\"Service price unit\", example=\"per_visit\")\n    currency: str = Field(..., description=\"Currency\", example=\"USD\")\n    base_postal_code: str = Field(..., description=\"Base postal code\", example=\"11211\")\n    service_radius_miles: float = Field(..., description=\"Radius in miles\", example=3.0)\n    house_rules: Optional[str] = Field(None, description=\"House rules\", example=\"no off-leash, no dog parks\")\n    city: Optional[str] = Field(None, description=\"City\", example=\"Brooklyn\")\n    state: Optional[str] = Field(None, description=\"State\", example=\"NY\")\n    active: int = Field(..., description=\"Is this listing active (1=yes, 0=no)\", example=1)\n    created_at: str = Field(..., description=\"Creation time\", example=\"2024-06-03T12:00:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass ServiceAvailabilityRuleCreateRequest(BaseModel):\n    service_listing_id: int = Field(..., description=\"Service listing to add to\", example=100)\n    start_date: str = Field(..., description=\"Date for this rule to start (YYYY-MM-DD)\", example=\"2026-03-01\")\n    day_of_week: int = Field(..., description=\"Day of week (0=Monday to 6=Sunday)\", example=0)\n    start_time: str = Field(..., description=\"Window start time (HH:MM in 24h)\", example=\"07:00\")\n    end_time: str = Field(..., description=\"Window end time (HH:MM in 24h)\", example=\"09:00\")\n\nclass ServiceAvailabilityRuleResponse(BaseModel):\n    id: int = Field(..., description=\"Availability rule ID\", example=14)\n    service_listing_id: int = Field(..., description=\"Service listing ID\", example=100)\n    start_date: str = Field(..., description=\"Start date for this rule\", example=\"2026-03-01\")\n    day_of_week: int = Field(..., description=\"Applicable day of week (0=Monday)\", example=0)\n    start_time: str = Field(..., description=\"Start time\", example=\"07:00\")\n    end_time: str = Field(..., description=\"End time\", example=\"09:00\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass ServiceBlackoutCreateRequest(BaseModel):\n    service_listing_id: int = Field(..., description=\"ID of the listing\", example=88)\n    start_datetime: str = Field(..., description=\"Blackout start datetime (YYYY-MM-DDTHH:MM:SS)\", example=\"2026-03-14T00:00:00\")\n    end_datetime: str = Field(..., description=\"Blackout end datetime\", example=\"2026-03-16T23:59:59\")\n    reason: Optional[str] = Field(None, description=\"Optional blackout reason\", example=\"Travel\")\n\nclass ServiceBlackoutResponse(BaseModel):\n    id: int = Field(..., description=\"Blackout ID\", example=7)\n    service_listing_id: int = Field(..., description=\"Service listing blocked\", example=88)\n    start_datetime: str = Field(..., description=\"Blackout period start\", example=\"2026-03-14T00:00:00\")\n    end_datetime: str = Field(..., description=\"Blackout period end\", example=\"2026-03-16T23:59:59\")\n    reason: Optional[str] = Field(None, description=\"Reason provided\", example=\"Travel\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass ServiceCapacityCreateRequest(BaseModel):\n    service_listing_id: int = Field(..., description=\"Service listing ID\", example=77)\n    max_dogs_per_night: int = Field(..., description=\"Max dogs per night (boarding capacity)\", example=2)\n\nclass ServiceCapacityResponse(BaseModel):\n    id: int = Field(..., description=\"Capacity record ID\", example=31)\n    service_listing_id: int = Field(..., description=\"Service listing\", example=77)\n    max_dogs_per_night: int = Field(..., description=\"Per-night boarding max dogs\", example=2)\n    model_config = ConfigDict(from_attributes=True)\n\nclass BookingCreateRequest(BaseModel):\n    service_listing_id: int = Field(..., description=\"Service listing to book\", example=51)\n    pet_id: int = Field(..., description=\"ID of pet to book for\", example=11)\n    start_datetime: str = Field(..., description=\"Job start datetime (YYYY-MM-DDTHH:MM)\", example=\"2026-03-05T18:15:00\")\n    end_datetime: str = Field(..., description=\"Job end datetime (YYYY-MM-DDTHH:MM)\", example=\"2026-03-05T18:45:00\")\n    duration_minutes: Optional[int] = Field(None, description=\"Duration in minutes (optional; calculated from start/end)\", example=30)\n    owner_message: Optional[str] = Field(None, description=\"Optional owner message for sitter\", example=\"Please use the lobby entrance and avoid the construction zone on 3rd St.\")\n\nclass BookingResponse(BaseModel):\n    id: int = Field(..., description=\"New booking ID\", example=200)\n    booking_code: str = Field(..., description=\"Unique booking code\", example=\"BK-10500\")\n    service_listing_id: int = Field(..., description=\"Linked service listing\", example=51)\n    owner_user_id: int = Field(..., description=\"Booking user's id (auto set)\", example=1)\n    sitter_user_id: int = Field(..., description=\"Sitter assigned\", example=42)\n    pet_id: int = Field(..., description=\"Booked pet ID\", example=11)\n    status: str = Field(..., description=\"Current status\", example=\"pending\")\n    start_datetime: str = Field(..., description=\"Start time\", example=\"2026-03-05T18:15:00\")\n    end_datetime: str = Field(..., description=\"End time\", example=\"2026-03-05T18:45:00\")\n    duration_minutes: Optional[int] = Field(None, description=\"Job duration\", example=30)\n    owner_message: Optional[str] = Field(None, description=\"Booking note for sitter\", example=\"Please use the lobby entrance and avoid the construction zone on 3rd St.\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass BookingAcceptResponse(BaseModel):\n    id: int = Field(..., description=\"Booking ID\", example=333)\n    status: str = Field(..., description=\"Booking status\", example=\"accepted\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass BookingApplyPromoCodeRequest(BaseModel):\n    promo_code: str = Field(..., description=\"Promotional code to apply\", example=\"SPRING10\")\n\nclass BookingApplyPromoCodeResponse(BaseModel):\n    booking_id: int = Field(..., description=\"Booking receiving discount\", example=333)\n    currency: str = Field(..., description=\"Currency for booking\", example=\"USD\")\n    base_amount: float = Field(..., description=\"Base before discount/fees\", example=120.0)\n    promo_code_id: Optional[int] = Field(None, description=\"Applied promo code ID\", example=4)\n    promo_discount_amount: float = Field(..., description=\"Promo applied discount\", example=10.0)\n    platform_fee_amount: float = Field(..., description=\"Platform service fee\", example=8.0)\n    total_amount: float = Field(..., description=\"Final amount due (total)\", example=118.0)\n    model_config = ConfigDict(from_attributes=True)\n\nclass BookingGetResponse(BaseModel):\n    id: int = Field(..., description=\"Booking ID\", example=200)\n    booking_code: str = Field(..., description=\"Unique booking code\", example=\"BK-10500\")\n    pet_id: int = Field(..., description=\"Pet ID\", example=11)\n    sitter_user_id: int = Field(..., description=\"Sitter user ID\", example=42)\n    owner_user_id: int = Field(..., description=\"Owner user ID\", example=1)\n    status: str = Field(..., description=\"Booking status\", example=\"pending\")\n    start_datetime: str = Field(..., description=\"Start date/time\", example=\"2026-03-05T18:15:00\")\n    end_datetime: str = Field(..., description=\"End date/time\", example=\"2026-03-05T18:45:00\")\n    owner_message: Optional[str] = Field(None, description=\"Owner's message\", example=\"Please use the lobby entrance.\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass BookingCancelRequest(BaseModel):\n    reason_code: str = Field(..., description=\"Reason for cancellation (see schema's allowed values)\", example=\"pet_illness\")\n    request_refund: Optional[bool] = Field(True, description=\"Request refund if eligible (default true)\", example=True)\n\nclass BookingCancelResponse(BaseModel):\n    id: int = Field(..., description=\"Booking ID canceled\", example=456)\n    status: str = Field(..., description=\"Booking is now canceled\", example=\"canceled\")\n    cancellation_reason_code: Optional[str] = Field(None, description=\"Cancellation reason\", example=\"pet_illness\")\n    refund_requested: Optional[bool] = Field(False, description=\"Was refund requested\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass MessageThreadsThreadItem(BaseModel):\n    id: int = Field(..., description=\"Thread ID\", example=17)\n    thread_code: str = Field(..., description=\"Unique thread code\", example=\"MSG-88310\")\n    booking_id: Optional[int] = Field(None, description=\"Related booking\", example=10492)\n    sitter_user_id: int = Field(..., description=\"Sitter id\", example=77)\n    owner_user_id: int = Field(..., description=\"Owner id\", example=1)\n\nclass MessageThreadsResponse(BaseModel):\n    threads: List[MessageThreadsThreadItem] = Field(..., description=\"Message threads owned by or involving user\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SendMessageRequest(BaseModel):\n    body: str = Field(..., description=\"Message content\", example=\"Can you confirm youre comfortable administering an oral flea tablet after the walk if I leave it on the counter?\")\n\nclass SendMessageResponse(BaseModel):\n    id: int = Field(..., description=\"New message record ID\", example=1501)\n    message_code: str = Field(..., description=\"Unique code for this message\", example=\"MSG-120204\")\n    thread_id: int = Field(..., description=\"Thread this belongs to\", example=17)\n    sender_user_id: int = Field(..., description=\"Sender user id (auto set)\", example=1)\n    body: str = Field(..., description=\"Full body of the message\", example=\"Can you confirm youre comfortable administering an oral flea tablet after the walk if I leave it on the counter?\")\n    sent_at: str = Field(..., description=\"Message send time\", example=\"2024-06-03T13:41:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass VisitReportCreateRequest(BaseModel):\n    booking_id: int = Field(..., description=\"Booking this report is for\", example=202)\n    report_datetime: str = Field(..., description=\"Date/time report is being made for\", example=\"2026-04-11T18:45:00-04:00\")\n    potty_notes: Optional[str] = Field(None, description=\"Potty break notes\", example=\"pee and poop\")\n    meal_notes: Optional[str] = Field(None, description=\"Meal/feeding notes\", example=\"ate 1 cup kibble\")\n\nclass VisitReportResponse(BaseModel):\n    id: int = Field(..., description=\"Visit report ID\", example=88)\n    booking_id: int = Field(..., description=\"Booking linked to report\", example=202)\n    report_datetime: str = Field(..., description=\"Report date/time\", example=\"2026-04-11T18:45:00-04:00\")\n    potty_notes: Optional[str] = Field(None, description=\"Potty break notes\", example=\"pee and poop\")\n    meal_notes: Optional[str] = Field(None, description=\"Meal/feeding notes\", example=\"ate 1 cup kibble\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass VisitReportPhotoCreateRequest(BaseModel):\n    visit_report_id: int = Field(..., description=\"Visit report to attach photo to\", example=88)\n    taken_at: str = Field(..., description=\"Date/time when photo was taken\", example=\"2026-04-11T08:12:00-04:00\")\n    caption: Optional[str] = Field(None, description=\"Caption for this photo\", example=\"Morning walk\")\n    storage_key: Optional[str] = Field(None, description=\"Object storage key for file, if uploaded\", example=\"vrp/88/2026-04-11T08_12_00.jpg\")\n\nclass VisitReportPhotoResponse(BaseModel):\n    id: int = Field(..., description=\"Visit report photo ID\", example=201)\n    visit_report_id: int = Field(..., description=\"Visit report this photo is linked to\", example=88)\n    taken_at: str = Field(..., description=\"Photo timestamp\", example=\"2026-04-11T08:12:00-04:00\")\n    caption: Optional[str] = Field(None, description=\"Photo caption\", example=\"Morning walk\")\n    storage_key: Optional[str] = Field(None, description=\"Storage key for image file\", example=\"vrp/88/2026-04-11T08_12_00.jpg\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SupportTicketCreateRequest(BaseModel):\n    category: str = Field(..., description=\"Primary category (fee_dispute, payment, booking, other)\", example=\"fee_dispute\")\n    subject: Optional[str] = Field(None, description=\"Short issue summary\", example=\"Late Cancellation Fee Dispute\")\n    description: str = Field(..., description=\"Detailed description of the issue\", example=\"Sitter canceled 2 hours before start; I was still charged a late fee\")\n    booking_id: Optional[int] = Field(None, description=\"Booking involved (if any)\", example=10492)\n    related_thread_id: Optional[int] = Field(None, description=\"ID of related message thread, if applicable\", example=17)\n\nclass SupportTicketResponse(BaseModel):\n    id: int = Field(..., description=\"Created ticket ID\", example=81)\n    ticket_code: str = Field(..., description=\"Ticket code\", example=\"SUP-38491\")\n    category: str = Field(..., description=\"Ticket category\", example=\"fee_dispute\")\n    subject: Optional[str] = Field(None, description=\"Issue subject\", example=\"Late Cancellation Fee Dispute\")\n    description: str = Field(..., description=\"Issue details\", example=\"Sitter canceled 2 hours before start; I was still charged a late fee\")\n    status: str = Field(..., description=\"Ticket status\", example=\"open\")\n    booking_id: Optional[int] = Field(None, description=\"Related booking\", example=10492)\n    related_thread_id: Optional[int] = Field(None, description=\"Related message thread\", example=17)\n    model_config = ConfigDict(from_attributes=True)\n\n# --------- Helper (synchronous, since no try/except) -----------------\ndef next_booking_code(session):\n    now = int(datetime.utcnow().timestamp() * 100)\n    code = f\"BK-{now}\"\n    exists = session.query(Booking).filter_by(booking_code=code).first()\n    while exists:\n        now += 1\n        code = f\"BK-{now}\"\n        exists = session.query(Booking).filter_by(booking_code=code).first()\n    return code\n\ndef next_message_code(session):\n    now = int(datetime.utcnow().timestamp() * 100)\n    code = f\"MSG-{now}\"\n    exists = session.query(Message).filter_by(message_code=code).first()\n    while exists:\n        now += 1\n        code = f\"MSG-{now}\"\n        exists = session.query(Message).filter_by(message_code=code).first()\n    return code\n\ndef next_thread_code(session):\n    now = int(datetime.utcnow().timestamp() * 100)\n    code = f\"MSG-{now}\"\n    exists = session.query(MessageThread).filter_by(thread_code=code).first()\n    while exists:\n        now += 1\n        code = f\"MSG-{now}\"\n        exists = session.query(MessageThread).filter_by(thread_code=code).first()\n    return code\n\ndef next_support_ticket_code(session):\n    now = int(datetime.utcnow().timestamp() * 100)\n    code = f\"SUP-{now}\"\n    exists = session.query(SupportTicket).filter_by(ticket_code=code).first()\n    while exists:\n        now += 1\n        code = f\"SUP-{now}\"\n        exists = session.query(SupportTicket).filter_by(ticket_code=code).first()\n    return code\n\n# -------------------- ENDPOINTS ------------------------------------------\n\n@app.post(\n    \"/api/pets\",\n    summary=\"Add a new pet record for current user\",\n    description=\"Create a new pet with all fields and set current user as owner. Use to add a pet to your profile.\",\n    tags=[\"pets\"],\n    operation_id=\"create_pet\",\n    response_model=PetResponse,\n)\nasync def create_pet(\n    req: PetCreateRequest\n) -> PetResponse:\n    session = SessionLocal()\n    current_user_id = 1\n    pet = Pet(\n        owner_user_id=current_user_id,\n        name=req.name,\n        species=req.species,\n        breed=req.breed,\n        sex=req.sex,\n        birth_date=datetime.strptime(req.birth_date, \"%Y-%m-%d\").date() if req.birth_date else None,\n        age_years=req.age_years,\n        behavior_notes=req.behavior_notes,\n        emergency_contact_name=req.emergency_contact_name,\n        emergency_contact_phone=req.emergency_contact_phone,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow(),\n    )\n    session.add(pet)\n    session.commit()\n    session.refresh(pet)\n    resp = PetResponse(\n        id=pet.id,\n        owner_user_id=pet.owner_user_id,\n        name=pet.name,\n        species=pet.species,\n        breed=pet.breed,\n        sex=pet.sex,\n        birth_date=pet.birth_date.isoformat() if pet.birth_date else None,\n        age_years=pet.age_years,\n        behavior_notes=pet.behavior_notes,\n        emergency_contact_name=pet.emergency_contact_name,\n        emergency_contact_phone=pet.emergency_contact_phone,\n        created_at=pet.created_at.replace(microsecond=0).isoformat() + \"Z\" if pet.created_at else None,\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/pet_vaccinations\",\n    summary=\"Add a vaccination record for a pet\",\n    description=\"Create a vaccination entry (rabies, dhpp) for an owned pet. Call after pet creation.\",\n    tags=[\"pets\", \"pet_vaccinations\"],\n    operation_id=\"create_pet_vaccination\",\n    response_model=PetVaccinationResponse,\n)\nasync def create_pet_vaccination(\n    req: PetVaccinationCreateRequest\n) -> PetVaccinationResponse:\n    session = SessionLocal()\n    v = PetVaccination(\n        pet_id=req.pet_id,\n        vaccine_type=req.vaccine_type,\n        administered_on=datetime.strptime(req.administered_on, \"%Y-%m-%d\").date(),\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(v)\n    session.commit()\n    session.refresh(v)\n    resp = PetVaccinationResponse(\n        id=v.id,\n        pet_id=v.pet_id,\n        vaccine_type=v.vaccine_type,\n        administered_on=v.administered_on.isoformat(),\n        created_at=v.created_at.replace(microsecond=0).isoformat() + \"Z\" if v.created_at else None\n    )\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/service_listings/search\",\n    summary=\"Search dog walk sitters by location, date, time and sort results\",\n    description=\"Find active walk services near provided postal code/time, sorted by price & rating. For searching walk/visit sitters.\",\n    tags=[\"service_listings\", \"search\"],\n    operation_id=\"search_walkers\",\n    response_model=SearchWalkersResponse,\n)\nasync def search_walkers(\n    service_type: str = Query(..., description=\"Service type (walk, drop_in, boarding, daycare)\", example=\"walk\"),\n    base_postal_code: str = Query(..., description=\"Base postal code to search from\", example=\"94107\"),\n    service_radius_miles: float = Query(..., description=\"Radius in miles from postal code\", example=2.0),\n    date_: str = Query(..., alias=\"date\", description=\"Service date (YYYY-MM-DD)\", example=\"2026-03-05\"),\n    start_time: str = Query(..., description=\"Window start time in 24h HH:MM\", example=\"18:00\"),\n    end_time: str = Query(..., description=\"Window end time in 24h HH:MM\", example=\"19:00\"),\n    duration_minutes: int = Query(..., description=\"Requested service duration in minutes\", example=30),\n    limit: Optional[int] = Query(None, description=\"Max results to return\", example=3),\n    sort: Optional[str] = Query(None, description=\"Sorting order. Use 'price_asc' for lowest price.\", example=\"price_asc\"),\n) -> SearchWalkersResponse:\n    session = SessionLocal()\n    q = session.query(ServiceListing).filter(\n        ServiceListing.active == 1,\n        ServiceListing.service_type == service_type,\n        ServiceListing.base_postal_code == base_postal_code,\n        ServiceListing.service_radius_miles >= service_radius_miles,\n    )\n    if sort == \"price_asc\":\n        q = q.order_by(ServiceListing.price_amount.asc())\n    else:\n        q = q.order_by(ServiceListing.id.desc())\n    if limit is not None:\n        q = q.limit(limit)\n    items = []\n    for s in q.all():\n        metric = session.query(SitterDailyMetric).filter(\n            SitterDailyMetric.sitter_user_id == s.sitter_user_id,\n            SitterDailyMetric.metric_date == datetime.strptime(date_, \"%Y-%m-%d\").date()\n        ).first()\n        avg_rating = metric.avg_rating if metric else None\n        user = session.query(User).filter(User.id == s.sitter_user_id).first()\n        items.append(SearchWalkersResultItem(\n            service_listing_id=s.id,\n            sitter_user_id=s.sitter_user_id,\n            sitter_name=user.full_name if user else \"\",\n            per_walk_rate=s.price_amount,\n            currency=s.currency,\n            avg_rating=avg_rating\n        ))\n    session.close()\n    return SearchWalkersResponse(results=items)\n\n@app.post(\n    \"/api/service_listings\",\n    summary=\"Create a new service listing for the authenticated sitter\",\n    description=\"Add a new drop-in, walk, boarding or daycare service listing under current sitter.\",\n    tags=[\"service_listings\"],\n    operation_id=\"create_service_listing\",\n    response_model=ServiceListingResponse,\n)\nasync def create_service_listing(\n    req: ServiceListingCreateRequest\n) -> ServiceListingResponse:\n    session = SessionLocal()\n    current_user_id = 1\n    s = ServiceListing(\n        sitter_user_id=current_user_id,\n        service_type=req.service_type,\n        title=req.title,\n        description=req.description,\n        house_rules=req.house_rules,\n        price_amount=req.price_amount,\n        price_unit=req.price_unit,\n        currency=req.currency if req.currency else \"USD\",\n        base_postal_code=req.base_postal_code,\n        service_radius_miles=req.service_radius_miles,\n        city=req.city,\n        state=req.state,\n        active=1,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(s)\n    session.commit()\n    session.refresh(s)\n    resp = ServiceListingResponse(\n        id=s.id,\n        sitter_user_id=s.sitter_user_id,\n        service_type=s.service_type,\n        price_amount=s.price_amount,\n        price_unit=s.price_unit,\n        currency=s.currency,\n        base_postal_code=s.base_postal_code,\n        service_radius_miles=s.service_radius_miles,\n        house_rules=s.house_rules,\n        city=s.city,\n        state=s.state,\n        active=s.active,\n        created_at=s.created_at.replace(microsecond=0).isoformat() + \"Z\" if s.created_at else None,\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/service_availability_rules\",\n    summary=\"Add weekly availability rule to service listing\",\n    description=\"Specify days/times service listing is available starting given date. For recurring slots.\",\n    tags=[\"service_listings\", \"availability\"],\n    operation_id=\"create_service_availability_rule\",\n    response_model=ServiceAvailabilityRuleResponse,\n)\nasync def create_service_availability_rule(\n    req: ServiceAvailabilityRuleCreateRequest\n) -> ServiceAvailabilityRuleResponse:\n    session = SessionLocal()\n    r = ServiceAvailabilityRule(\n        service_listing_id=req.service_listing_id,\n        start_date=datetime.strptime(req.start_date, \"%Y-%m-%d\").date(),\n        day_of_week=req.day_of_week,\n        start_time=req.start_time,\n        end_time=req.end_time,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(r)\n    session.commit()\n    session.refresh(r)\n    resp = ServiceAvailabilityRuleResponse(\n        id=r.id,\n        service_listing_id=r.service_listing_id,\n        start_date=r.start_date.isoformat(),\n        day_of_week=r.day_of_week,\n        start_time=r.start_time,\n        end_time=r.end_time\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/service_blackouts\",\n    summary=\"Block off service listing for custom blackout (like travel/unavailable)\",\n    description=\"Creates an unavailable period for given service listing across any date/time span.\",\n    tags=[\"service_listings\", \"blackouts\"],\n    operation_id=\"create_service_blackout\",\n    response_model=ServiceBlackoutResponse,\n)\nasync def create_service_blackout(\n    req: ServiceBlackoutCreateRequest\n) -> ServiceBlackoutResponse:\n    session = SessionLocal()\n    s = ServiceBlackout(\n        service_listing_id=req.service_listing_id,\n        start_datetime=datetime.fromisoformat(req.start_datetime),\n        end_datetime=datetime.fromisoformat(req.end_datetime),\n        reason=req.reason,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(s)\n    session.commit()\n    session.refresh(s)\n    resp = ServiceBlackoutResponse(\n        id=s.id,\n        service_listing_id=s.service_listing_id,\n        start_datetime=s.start_datetime.replace(microsecond=0).isoformat(),\n        end_datetime=s.end_datetime.replace(microsecond=0).isoformat(),\n        reason=s.reason\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/service_capacity\",\n    summary=\"Set service listing capacity for max dogs per night\",\n    description=\"Create or update boarding service capacity limit for a listing.\",\n    tags=[\"service_listings\", \"capacity\"],\n    operation_id=\"set_service_capacity\",\n    response_model=ServiceCapacityResponse,\n)\nasync def set_service_capacity(\n    req: ServiceCapacityCreateRequest\n) -> ServiceCapacityResponse:\n    session = SessionLocal()\n    cap = session.query(ServiceCapacity).filter(ServiceCapacity.service_listing_id == req.service_listing_id).first()\n    if cap:\n        cap.max_dogs_per_night = req.max_dogs_per_night\n        cap.updated_at = datetime.utcnow()\n    else:\n        cap = ServiceCapacity(\n            service_listing_id=req.service_listing_id,\n            max_dogs_per_night=req.max_dogs_per_night,\n            created_at=datetime.utcnow(),\n            updated_at=datetime.utcnow()\n        )\n        session.add(cap)\n    session.commit()\n    session.refresh(cap)\n    resp = ServiceCapacityResponse(\n        id=cap.id,\n        service_listing_id=cap.service_listing_id,\n        max_dogs_per_night=cap.max_dogs_per_night\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/bookings\",\n    summary=\"Request a new booking for pet and service listing\",\n    description=\"Create a new booking for a pet with specified listing, times, and message. Returns complete booking info.\",\n    tags=[\"bookings\"],\n    operation_id=\"create_booking\",\n    response_model=BookingResponse,\n)\nasync def create_booking(\n    req: BookingCreateRequest\n) -> BookingResponse:\n    session = SessionLocal()\n    owner_user_id = 1\n    sl = session.query(ServiceListing).filter(ServiceListing.id == req.service_listing_id).first()\n    sitter_user_id = sl.sitter_user_id if sl else 1\n    duration = req.duration_minutes\n    if not duration:\n        sd = datetime.fromisoformat(req.start_datetime)\n        ed = datetime.fromisoformat(req.end_datetime)\n        duration = int((ed - sd).total_seconds() // 60)\n    booking_code = next_booking_code(session)\n    b = Booking(\n        booking_code=booking_code,\n        service_listing_id=req.service_listing_id,\n        owner_user_id=owner_user_id,\n        sitter_user_id=sitter_user_id,\n        pet_id=req.pet_id,\n        status=\"pending\",\n        start_datetime=datetime.fromisoformat(req.start_datetime),\n        end_datetime=datetime.fromisoformat(req.end_datetime),\n        duration_minutes=duration,\n        owner_message=req.owner_message,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(b)\n    session.commit()\n    session.refresh(b)\n    resp = BookingResponse(\n        id=b.id,\n        booking_code=b.booking_code,\n        service_listing_id=b.service_listing_id,\n        owner_user_id=b.owner_user_id,\n        sitter_user_id=b.sitter_user_id,\n        pet_id=b.pet_id,\n        status=b.status,\n        start_datetime=b.start_datetime.replace(microsecond=0).isoformat(),\n        end_datetime=b.end_datetime.replace(microsecond=0).isoformat(),\n        duration_minutes=b.duration_minutes,\n        owner_message=b.owner_message\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/bookings/{booking_id}/accept\",\n    summary=\"Accept a pending booking as the selected sitter\",\n    description=\"Update a pending booking from status=pending to accepted by the assigned sitter.\",\n    tags=[\"bookings\", \"actions\"],\n    operation_id=\"accept_booking\",\n    response_model=BookingAcceptResponse,\n)\nasync def accept_booking(\n    booking_id: int = Path(..., description=\"Booking to accept\", example=333)\n) -> BookingAcceptResponse:\n    session = SessionLocal()\n    b = session.query(Booking).filter(Booking.id == booking_id).first()\n    b.status = \"accepted\"\n    b.updated_at = datetime.utcnow()\n    session.commit()\n    resp = BookingAcceptResponse(\n        id=b.id,\n        status=b.status\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/booking_pricing/{booking_id}/apply_promo\",\n    summary=\"Apply a promo code to a booking and get updated total\",\n    description=\"Apply a promo code and return recalculated amounts and platform fees for a booking.\",\n    tags=[\"bookings\", \"payments\"],\n    operation_id=\"apply_promo_code_booking\",\n    response_model=BookingApplyPromoCodeResponse,\n)\nasync def apply_promo_code_booking(\n    booking_id: int = Path(..., description=\"Booking to update\", example=333),\n    req: BookingApplyPromoCodeRequest = Body(...)\n) -> BookingApplyPromoCodeResponse:\n    session = SessionLocal()\n    bp = session.query(BookingPricing).filter(BookingPricing.booking_id == booking_id).first()\n    pc = session.query(PromoCode).filter(\n        PromoCode.code == req.promo_code,\n        PromoCode.active == 1\n    ).first()\n    promo_code_id = None\n    promo_discount_amount = 0.0\n    if pc:\n        promo_code_id = pc.id\n        promo_discount_amount = pc.discount_value\n    platform_fee_amount = bp.platform_fee_amount if bp else 0.0\n    base_amount = bp.base_amount if bp else 0.0\n    total_amount = base_amount - promo_discount_amount + platform_fee_amount\n    if bp:\n        bp.promo_code_id = promo_code_id\n        bp.promo_discount_amount = promo_discount_amount\n        bp.total_amount = total_amount\n        bp.updated_at = datetime.utcnow()\n    else:\n        bp = BookingPricing(\n            booking_id=booking_id,\n            currency=pc.currency if pc else \"USD\",\n            base_amount=base_amount,\n            promo_code_id=promo_code_id,\n            promo_discount_amount=promo_discount_amount,\n            platform_fee_amount=platform_fee_amount,\n            total_amount=total_amount,\n            created_at=datetime.utcnow(),\n            updated_at=datetime.utcnow()\n        )\n        session.add(bp)\n    session.commit()\n    session.refresh(bp)\n    resp = BookingApplyPromoCodeResponse(\n        booking_id=booking_id,\n        currency=bp.currency,\n        base_amount=bp.base_amount,\n        promo_code_id=bp.promo_code_id,\n        promo_discount_amount=bp.promo_discount_amount,\n        platform_fee_amount=bp.platform_fee_amount,\n        total_amount=bp.total_amount\n    )\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/bookings/{booking_id}\",\n    summary=\"Get details of a specific booking\",\n    description=\"View all details for a single booking, including dates, status, pet, and sitter.\",\n    tags=[\"bookings\"],\n    operation_id=\"get_booking\",\n    response_model=BookingGetResponse,\n)\nasync def get_booking(\n    booking_id: int = Path(..., description=\"Booking ID to fetch\", example=200)\n) -> BookingGetResponse:\n    session = SessionLocal()\n    b = session.query(Booking).filter(Booking.id == booking_id).first()\n    resp = BookingGetResponse(\n        id=b.id,\n        booking_code=b.booking_code,\n        pet_id=b.pet_id,\n        sitter_user_id=b.sitter_user_id,\n        owner_user_id=b.owner_user_id,\n        status=b.status,\n        start_datetime=b.start_datetime.replace(microsecond=0).isoformat(),\n        end_datetime=b.end_datetime.replace(microsecond=0).isoformat(),\n        owner_message=b.owner_message\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/bookings/{booking_id}/cancel\",\n    summary=\"Cancel a booking and optionally request a refund\",\n    description=\"Cancel the booking with a reason, and if eligible, request refund to original method.\",\n    tags=[\"bookings\", \"actions\"],\n    operation_id=\"cancel_booking\",\n    response_model=BookingCancelResponse,\n)\nasync def cancel_booking(\n    booking_id: int = Path(..., description=\"Booking ID to cancel\", example=456),\n    req: BookingCancelRequest = Body(...)\n) -> BookingCancelResponse:\n    session = SessionLocal()\n    b = session.query(Booking).filter(Booking.id == booking_id).first()\n    b.status = \"canceled\"\n    b.cancellation_reason_code = req.reason_code\n    b.updated_at = datetime.utcnow()\n    if req.request_refund is None:\n        refund_requested = True\n    else:\n        refund_requested = req.request_refund\n    if refund_requested:\n        rr = RefundRequest(\n            booking_id=booking_id,\n            requested_by_user_id=1,\n            requested_amount=None,\n            refund_to_original_method=1,\n            eligibility_status=\"unknown\",\n            status=\"requested\",\n            created_at=datetime.utcnow(),\n            updated_at=datetime.utcnow()\n        )\n        session.add(rr)\n    session.commit()\n    resp = BookingCancelResponse(\n        id=b.id,\n        status=b.status,\n        cancellation_reason_code=b.cancellation_reason_code,\n        refund_requested=bool(refund_requested)\n    )\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/message_threads\",\n    summary=\"List all message threads for current user\",\n    description=\"Fetch all owner- or sitter-involved message threads for the logged-in user.\",\n    tags=[\"messages\"],\n    operation_id=\"list_message_threads\",\n    response_model=MessageThreadsResponse,\n)\nasync def list_message_threads() -> MessageThreadsResponse:\n    session = SessionLocal()\n    user_id = 1\n    threads = session.query(MessageThread).filter(\n        ((MessageThread.owner_user_id == user_id) | (MessageThread.sitter_user_id == user_id))\n    ).all()\n    items = []\n    for t in threads:\n        items.append(MessageThreadsThreadItem(\n            id=t.id,\n            thread_code=t.thread_code,\n            booking_id=t.booking_id,\n            sitter_user_id=t.sitter_user_id,\n            owner_user_id=t.owner_user_id\n        ))\n    session.close()\n    return MessageThreadsResponse(threads=items)\n\n@app.post(\n    \"/api/message_threads/{thread_code}/messages\",\n    summary=\"Send a message in a thread as current user\",\n    description=\"Post a new message in the designated message thread. Use for owner/sitter chat with context.\",\n    tags=[\"messages\"],\n    operation_id=\"send_message\",\n    response_model=SendMessageResponse,\n)\nasync def send_message(\n    thread_code: str = Path(..., description=\"Thread code of the conversation\", example=\"MSG-88310\"),\n    req: SendMessageRequest = Body(...)\n) -> SendMessageResponse:\n    session = SessionLocal()\n    user_id = 1\n    thread = session.query(MessageThread).filter(MessageThread.thread_code == thread_code).first()\n    code = next_message_code(session)\n    m = Message(\n        message_code=code,\n        thread_id=thread.id,\n        sender_user_id=user_id,\n        body=req.body,\n        sent_at=datetime.utcnow(),\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(m)\n    session.commit()\n    session.refresh(m)\n    resp = SendMessageResponse(\n        id=m.id,\n        message_code=m.message_code,\n        thread_id=m.thread_id,\n        sender_user_id=m.sender_user_id,\n        body=m.body,\n        sent_at=m.sent_at.replace(microsecond=0).isoformat() + \"Z\"\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/visit_reports\",\n    summary=\"Create a visit report for a booking\",\n    description=\"Submit a report for a completed visit during a booking, including notes and photos metadata.\",\n    tags=[\"visit_reports\"],\n    operation_id=\"create_visit_report\",\n    response_model=VisitReportResponse,\n)\nasync def create_visit_report(\n    req: VisitReportCreateRequest\n) -> VisitReportResponse:\n    session = SessionLocal()\n    vr = VisitReport(\n        booking_id=req.booking_id,\n        report_datetime=datetime.fromisoformat(req.report_datetime),\n        potty_notes=req.potty_notes,\n        meal_notes=req.meal_notes,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(vr)\n    session.commit()\n    session.refresh(vr)\n    resp = VisitReportResponse(\n        id=vr.id,\n        booking_id=vr.booking_id,\n        report_datetime=vr.report_datetime.replace(microsecond=0).isoformat(),\n        potty_notes=vr.potty_notes,\n        meal_notes=vr.meal_notes\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/visit_report_photos\",\n    summary=\"Add photo metadata entry to a visit report\",\n    description=\"Attach a photo (metadata reference and caption) to a visit report. For real photo files, use storage_key.\",\n    tags=[\"visit_reports\", \"photos\"],\n    operation_id=\"add_visit_report_photo\",\n    response_model=VisitReportPhotoResponse,\n)\nasync def add_visit_report_photo(\n    req: VisitReportPhotoCreateRequest\n) -> VisitReportPhotoResponse:\n    session = SessionLocal()\n    vrp = VisitReportPhoto(\n        visit_report_id=req.visit_report_id,\n        taken_at=req.taken_at,\n        caption=req.caption,\n        storage_key=req.storage_key,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(vrp)\n    session.commit()\n    session.refresh(vrp)\n    resp = VisitReportPhotoResponse(\n        id=vrp.id,\n        visit_report_id=vrp.visit_report_id,\n        taken_at=vrp.taken_at,\n        caption=vrp.caption,\n        storage_key=vrp.storage_key\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/support_tickets\",\n    summary=\"Open a new support ticket for booking or fee issues\",\n    description=\"Create a support ticket for a fee dispute or booking problem, referencing optional booking and thread.\",\n    tags=[\"support\", \"disputes\"],\n    operation_id=\"create_support_ticket\",\n    response_model=SupportTicketResponse,\n)\nasync def create_support_ticket(\n    req: SupportTicketCreateRequest\n) -> SupportTicketResponse:\n    session = SessionLocal()\n    user_id = 1\n    code = next_support_ticket_code(session)\n    t = SupportTicket(\n        ticket_code=code,\n        created_by_user_id=user_id,\n        booking_id=req.booking_id,\n        related_thread_id=req.related_thread_id,\n        category=req.category,\n        subject=req.subject,\n        description=req.description,\n        status=\"open\",\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(t)\n    session.commit()\n    session.refresh(t)\n    resp = SupportTicketResponse(\n        id=t.id,\n        ticket_code=t.ticket_code,\n        category=t.category,\n        subject=t.subject,\n        description=t.description,\n        status=t.status,\n        booking_id=t.booking_id,\n        related_thread_id=t.related_thread_id\n    )\n    session.close()\n    return resp\n\nif __name__ == \"__main__\":\n    import uvicorn, os\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
{"scenario": "GoFundMe", "db_path": "./outputs/databases/gofundme.db", "full_code": "import os\nfrom fastapi import FastAPI, Query, Path, Body\nfrom typing import List, Optional, Dict, Any\nfrom pydantic import BaseModel, Field, ConfigDict\nfrom sqlalchemy import (\n    Column, Integer, String, Text, DateTime, ForeignKey, Float, Boolean,\n    create_engine, UniqueConstraint, Index, CheckConstraint, text, Date\n)\nfrom sqlalchemy.orm import (\n    declarative_base, sessionmaker, relationship\n)\nfrom sqlalchemy.sql import func\nimport datetime\nimport json\n\nDATABASE_PATH = os.environ.get(\"DATABASE_PATH\")\nif not DATABASE_PATH:\n    DATABASE_PATH = \"sqlite:///xxxx.db\"\n\nBase = declarative_base()\nengine = create_engine(DATABASE_PATH, connect_args={\"check_same_thread\": False})\nSessionLocal = sessionmaker(bind=engine, autocommit=False, autoflush=False)\n\nclass User(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, unique=True, nullable=False)\n    email = Column(String, unique=True, nullable=False, index=True)\n    full_name = Column(String)\n    profile_json = Column(Text)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n\nclass Category(Base):\n    __tablename__ = \"categories\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, unique=True, nullable=False, index=True)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n\nclass Campaign(Base):\n    __tablename__ = \"campaigns\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    category_id = Column(Integer, ForeignKey(\"categories.id\"), nullable=False)\n    title = Column(String, nullable=False)\n    beneficiary_name = Column(String, nullable=False)\n    location_city = Column(String, nullable=False)\n    location_region = Column(String, nullable=False)\n    location_country = Column(String, default=\"US\", nullable=False)\n    goal_amount_cents = Column(Integer, nullable=False)\n    currency_code = Column(String, default=\"USD\", nullable=False)\n    status = Column(String, default=\"active\", nullable=False)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"owner_user_id\", \"title\", name=\"uix_campaigns_owner_title\"),\n        Index(\"idx_campaigns_owner\", \"owner_user_id\"),\n        Index(\"idx_campaigns_category_location\", \"category_id\", \"location_city\", \"location_region\", \"status\"),\n        Index(\"idx_campaigns_status\", \"status\"),\n    )\n\nclass CampaignMedia(Base):\n    __tablename__ = \"campaign_media\"\n    id = Column(Integer, primary_key=True)\n    campaign_id = Column(Integer, ForeignKey(\"campaigns.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    filename = Column(String, nullable=False)\n    alt_text = Column(String)\n    sort_order = Column(Integer, default=0, nullable=False)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"campaign_id\", \"filename\", name=\"uix_campaign_media_filename\"),\n        Index(\"idx_campaign_media_campaign_sort\", \"campaign_id\", \"sort_order\", \"id\"),\n    )\n\nclass CampaignUpdate(Base):\n    __tablename__ = \"campaign_updates\"\n    id = Column(Integer, primary_key=True)\n    campaign_id = Column(Integer, ForeignKey(\"campaigns.id\", ondelete=\"CASCADE\"), nullable=False)\n    author_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    title = Column(String, nullable=False)\n    body = Column(Text, nullable=False)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    __table_args__ = (\n        Index(\"idx_campaign_updates_campaign_created\", \"campaign_id\", \"created_at\".replace('DESC', '')),\n    )\n\nclass DonationIntent(Base):\n    __tablename__ = \"donation_intents\"\n    id = Column(Integer, primary_key=True)\n    campaign_id = Column(Integer, ForeignKey(\"campaigns.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    donor_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"), nullable=True, index=True)\n    donor_name = Column(String, nullable=False)\n    message = Column(Text)\n    is_anonymous = Column(Integer, nullable=False, default=0)\n    kind = Column(String, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    amount_cents = Column(Integer, nullable=False)\n    start_date = Column(Date, nullable=True)\n    interval_unit = Column(String, nullable=True)\n    interval_count = Column(Integer, nullable=True)\n    status = Column(String, nullable=False, default=\"active\")\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    __table_args__ = (\n        Index(\"idx_donation_intents_campaign\", \"campaign_id\"),\n        Index(\"idx_donation_intents_donor_created\", \"donor_user_id\", \"created_at\"),\n        Index(\"idx_donation_intents_kind_status\", \"kind\", \"status\"),\n    )\n\nclass Donation(Base):\n    __tablename__ = \"donations\"\n    id = Column(Integer, primary_key=True)\n    donation_intent_id = Column(Integer, ForeignKey(\"donation_intents.id\", ondelete=\"SET NULL\"), nullable=True, index=True)\n    campaign_id = Column(Integer, ForeignKey(\"campaigns.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    donor_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"), nullable=True, index=True)\n    donor_name = Column(String, nullable=False)\n    message = Column(Text)\n    is_anonymous = Column(Integer, nullable=False, default=0)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    amount_cents = Column(Integer, nullable=False)\n    donated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    __table_args__ = (\n        Index(\"idx_donations_campaign_donated\", \"campaign_id\", \"donated_at\"),\n        Index(\"idx_donations_donor_donated\", \"donor_user_id\", \"donated_at\"),\n        Index(\"idx_donations_intent\", \"donation_intent_id\"),\n    )\n\nclass Receipt(Base):\n    __tablename__ = \"receipts\"\n    id = Column(Integer, primary_key=True)\n    donation_id = Column(Integer, ForeignKey(\"donations.id\", ondelete=\"CASCADE\"), unique=True, nullable=False)\n    receipt_number = Column(String, nullable=False, unique=True, index=True)\n    issued_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False, index=True)\n    total_amount_cents = Column(Integer, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n\nclass PayoutMethod(Base):\n    __tablename__ = \"payout_methods\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    type = Column(String, nullable=False)\n    bank_name = Column(String, nullable=False)\n    account_last4 = Column(String, nullable=False)\n    account_type = Column(String, nullable=False)\n    is_default = Column(Integer, nullable=False, default=0, index=True)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n\nclass CampaignPayoutSettings(Base):\n    __tablename__ = \"campaign_payout_settings\"\n    campaign_id = Column(Integer, ForeignKey(\"campaigns.id\", ondelete=\"CASCADE\"), primary_key=True)\n    default_payout_method_id = Column(Integer, ForeignKey(\"payout_methods.id\", ondelete=\"SET NULL\"), nullable=True, index=True)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n\nclass Payout(Base):\n    __tablename__ = \"payouts\"\n    id = Column(Integer, primary_key=True)\n    campaign_id = Column(Integer, ForeignKey(\"campaigns.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    payout_method_id = Column(Integer, ForeignKey(\"payout_methods.id\"), nullable=False, index=True)\n    amount_cents = Column(Integer, nullable=False)\n    currency_code = Column(String, nullable=False, default=\"USD\")\n    status = Column(String, nullable=False, default=\"pending\")\n    risk_level = Column(String, nullable=False, default=\"none\")\n    risk_flags_json = Column(Text)\n    verification_required = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    __table_args__ = (\n        Index(\"idx_payouts_campaign_created\", \"campaign_id\", \"created_at\"),\n        Index(\"idx_payouts_status\", \"status\"),\n        Index(\"idx_payouts_method\", \"payout_method_id\"),\n    )\n\nclass PayoutVerificationRequirement(Base):\n    __tablename__ = \"payout_verification_requirements\"\n    id = Column(Integer, primary_key=True)\n    payout_id = Column(Integer, ForeignKey(\"payouts.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    requirement_type = Column(String, nullable=False)\n    status = Column(String, nullable=False, default=\"required\")\n    notes = Column(Text)\n    created_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, server_default=func.current_timestamp(), nullable=False)\n    __table_args__ = (\n        Index(\"idx_payout_verification_payout\", \"payout_id\"),\n        Index(\"idx_payout_verification_status\", \"status\"),\n    )\n\nBase.metadata.create_all(engine)\n\napp = FastAPI(title=\"GoFundMe simplified\", version=\"1.0.0\")\n\n# Pydantic Models\n\nclass ImageMetadataItem(BaseModel):\n    filename: str = Field(..., description=\"Image filename\", example=\"maya-hospital.jpg\")\n    alt: str = Field(..., description=\"Alt text for image\", example=\"Maya smiling in a hospital bed\")\n\nclass CreateCampaignRequest(BaseModel):\n    title: str = Field(..., description=\"Unique campaign title for the current user\", example=\"Help Mayas Recovery\")\n    category_name: str = Field(..., description=\"Category name for the campaign\", example=\"Medical\")\n    goal_amount_usd: float = Field(..., description=\"Goal amount in USD\", example=12000.0)\n    beneficiary_name: str = Field(..., description=\"Beneficiary's name\", example=\"Maya Hernandez\")\n    location_city: str = Field(..., description=\"Campaign city\", example=\"Austin\")\n    location_region: str = Field(..., description=\"Campaign region/state\", example=\"TX\")\n    image_metadata: List[ImageMetadataItem] = Field(..., description=\"Array of image filename and alt text objects\", example=[{\"filename\":\"maya-hospital.jpg\",\"alt\":\"Maya smiling in a hospital bed\"},{\"filename\":\"family.jpg\",\"alt\":\"Maya with her family at home\"}])\n\nclass CampaignResponse(BaseModel):\n    campaign_id: int = Field(..., description=\"Newly created campaign identifier\", example=42)\n    title: str = Field(..., description=\"Campaign title\", example=\"Help Mayas Recovery\")\n    status: str = Field(..., description=\"Campaign status\", example=\"active\")\n    created_at: str = Field(..., description=\"Datetime of creation\", example=\"2026-01-18T12:34:56Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass UpdateCampaignGoalAndLocationRequest(BaseModel):\n    goal_amount_usd: Optional[float] = Field(None, description=\"New goal amount in USD\", example=15000.0)\n    location_city: Optional[str] = Field(None, description=\"Updated city location\", example=\"Round Rock\")\n    location_region: Optional[str] = Field(None, description=\"Updated region/state location\", example=\"TX\")\n\nclass UpdateCampaignGoalAndLocationResponse(BaseModel):\n    campaign_id: int = Field(..., description=\"Campaign identifier\", example=42)\n    title: str = Field(..., description=\"Campaign title\", example=\"Help Mayas Recovery\")\n    goal_amount_usd: float = Field(..., description=\"Updated goal in USD\", example=15000.0)\n    location_city: str = Field(..., description=\"Updated city\", example=\"Round Rock\")\n    location_region: str = Field(..., description=\"Updated region/state\", example=\"TX\")\n    updated_at: str = Field(..., description=\"Datetime campaign updated\", example=\"2026-02-02T10:15:18Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass CampaignUpdateRequest(BaseModel):\n    title: str = Field(..., description=\"Update title\", example=\"Surgery scheduled\")\n    body: str = Field(..., description=\"Update message/body text\", example=\"Mayas surgery is scheduled for March 5th; thank you for the supportyour donations are covering pre-op tests and travel.\")\n\nclass CampaignUpdateResponse(BaseModel):\n    update_id: int = Field(..., description=\"Identifier for the new update\", example=15)\n    campaign_id: int = Field(..., description=\"Related campaign ID\", example=42)\n    title: str = Field(..., description=\"Update title\", example=\"Surgery scheduled\")\n    body: str = Field(..., description=\"Update body\", example=\"Mayas surgery is scheduled for March 5th; thank you for the supportyour donations are covering pre-op tests and travel.\")\n    created_at: str = Field(..., description=\"Datetime update posted\", example=\"2026-02-03T05:15:10Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SearchCampaignsByCategoryLocationResponseItem(BaseModel):\n    campaign_id: int = Field(..., description=\"Campaign identifier\", example=13)\n    title: str = Field(..., description=\"Campaign title\", example=\"Rescue Dog Treatment\")\n    category_name: str = Field(..., description=\"Category name\", example=\"Animals\")\n    location_city: str = Field(..., description=\"City\", example=\"Seattle\")\n    location_region: str = Field(..., description=\"Region/state\", example=\"WA\")\n    goal_amount_usd: float = Field(..., description=\"Funding goal in USD\", example=5000.0)\n    amount_raised_usd: float = Field(..., description=\"Total donations raised in USD\", example=4200.0)\n    status: str = Field(..., description=\"Campaign status\", example=\"active\")\n\nclass SearchCampaignsByCategoryLocationResponse(BaseModel):\n    campaigns: List[SearchCampaignsByCategoryLocationResponseItem] = Field(..., description=\"Campaigns found\")\n\nclass CreateDonationIntentRequest(BaseModel):\n    campaign_title: str = Field(..., description=\"Target campaign by title\", example=\"Community Food Pantry Restock\")\n    donor_name: str = Field(..., description=\"Donor display name\", example=\"Alex Kim\")\n    message: Optional[str] = Field(None, description=\"Public message from donor\", example=\"Happy to helpthank you for feeding our neighbors!\")\n    amount_usd: float = Field(..., description=\"Amount to donate in USD\", example=75.0)\n    is_anonymous: bool = Field(..., description=\"If true, donor is anonymous\", example=False)\n\nclass CreateDonationIntentResponse(BaseModel):\n    donation_intent_id: int = Field(..., description=\"New donation intent ID\", example=54)\n    campaign_id: int = Field(..., description=\"Campaign identifier\", example=12)\n    donor_name: str = Field(..., description=\"Donor public name\", example=\"Alex Kim\")\n    amount_usd: float = Field(..., description=\"Donation amount in USD\", example=75.0)\n    kind: str = Field(..., description=\"One-time or recurring\", example=\"one_time\")\n    status: str = Field(..., description=\"Intent status\", example=\"active\")\n\nclass CreateRecurringDonationIntentRequest(BaseModel):\n    campaign_title: str = Field(..., description=\"Target campaign by title\", example=\"Wildfire Relief for Sonoma\")\n    donor_name: str = Field(..., description=\"Donor display name\", example=\"Jordan Patel\")\n    message: Optional[str] = Field(None, description=\"Public message from donor\", example=\"Stay strongsending continued support.\")\n    amount_usd: float = Field(..., description=\"Monthly pledge amount in USD\", example=20.0)\n    is_anonymous: bool = Field(..., description=\"If true, donor is anonymous\", example=True)\n    start_date: str = Field(..., description=\"Recurring donation start date (YYYY-MM-DD)\", example=\"2026-03-01\")\n    interval_unit: str = Field(..., description=\"Recurring interval unit\", example=\"month\")\n    interval_count: int = Field(..., description=\"How many intervals between donations\", example=1)\n\nclass CreateRecurringDonationIntentResponse(BaseModel):\n    donation_intent_id: int = Field(..., description=\"New recurring donation intent ID\", example=55)\n    campaign_id: int = Field(..., description=\"Campaign identifier\", example=14)\n    donor_name: str = Field(..., description=\"Donor public name\", example=\"Jordan Patel\")\n    amount_usd: float = Field(..., description=\"Donation amount in USD\", example=20.0)\n    kind: str = Field(..., description=\"Donation kind (recurring)\", example=\"recurring\")\n    status: str = Field(..., description=\"Intent status\", example=\"active\")\n    start_date: str = Field(..., description=\"Start date of recurrence\", example=\"2026-03-01\")\n    interval_unit: str = Field(..., description=\"Interval unit\", example=\"month\")\n    interval_count: int = Field(..., description=\"Interval count\", example=1)\n\nclass FetchMyDonationHistoryDonation(BaseModel):\n    donation_id: int = Field(..., description=\"Unique donation ID\", example=111)\n    campaign_title: str = Field(..., description=\"Title of the campaign donated to\", example=\"Community Food Pantry Restock\")\n    amount_usd: float = Field(..., description=\"Donation amount in USD\", example=75.0)\n    donated_at: str = Field(..., description=\"Datetime donation was made\", example=\"2026-01-20T16:26:00Z\")\n    kind: str = Field(..., description=\"Donation kind (one_time or recurring)\", example=\"one_time\")\n\nclass FetchMyDonationHistoryResponse(BaseModel):\n    donations: List[FetchMyDonationHistoryDonation] = Field(..., description=\"Donations by the authenticated user\")\n\nclass FetchDonationReceiptMetadataResponse(BaseModel):\n    receipt_id: int = Field(..., description=\"Unique receipt identifier\", example=75)\n    receipt_number: str = Field(..., description=\"Receipt number\", example=\"RCPT-20260120-111\")\n    issued_at: str = Field(..., description=\"Receipt issue datetime\", example=\"2026-01-20T18:00:00Z\")\n    total_usd: float = Field(..., description=\"Total receipt amount in USD\", example=75.0)\n\nclass CreateBankAccountPayoutMethodRequest(BaseModel):\n    bank_name: str = Field(..., description=\"Name of the bank\", example=\"Chase\")\n    account_last4: str = Field(..., description=\"Last 4 digits of account number\", example=\"1234\")\n    account_type: str = Field(..., description=\"Account type: checking/savings\", example=\"checking\")\n    is_default: Optional[bool] = Field(False, description=\"Set payout method as default\", example=True)\n\nclass CreateBankAccountPayoutMethodResponse(BaseModel):\n    payout_method_id: int = Field(..., description=\"New payout method identifier\", example=8)\n    bank_name: str = Field(..., description=\"Bank name\", example=\"Chase\")\n    account_last4: str = Field(..., description=\"Last 4 of account number\", example=\"1234\")\n    account_type: str = Field(..., description=\"Account type\", example=\"checking\")\n    is_default: bool = Field(..., description=\"Is this payout method default for user\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass SetCampaignDefaultPayoutMethodRequest(BaseModel):\n    payout_method_id: int = Field(..., description=\"Default payout method identifier\", example=8)\n\nclass SetCampaignDefaultPayoutMethodResponse(BaseModel):\n    campaign_id: int = Field(..., description=\"Campaign identifier\", example=42)\n    default_payout_method_id: int = Field(..., description=\"Default payout method ID\", example=8)\n    updated_at: str = Field(..., description=\"Datetime payout settings updated\", example=\"2026-01-19T11:15:23Z\")\n\nclass RiskFlagItem(BaseModel):\n    flag: str = Field(..., description=\"Risk, fraud, or AML flag\", example=\"large_withdrawal\")\n\nclass VerificationRequirementItem(BaseModel):\n    requirement_type: str = Field(..., description=\"Verification type needed\", example=\"identity_document\")\n    status: str = Field(..., description=\"Requirement status\", example=\"required\")\n    notes: str = Field(..., description=\"Additional notes\", example=\"Upload government ID\")\n\nclass CreateCampaignPayoutToDefaultRequest(BaseModel):\n    campaign_id: int = Field(..., description=\"Campaign identifier\", example=42)\n    amount_usd: float = Field(..., description=\"Amount to payout in USD\", example=2500.0)\n\nclass CreateCampaignPayoutToDefaultResponse(BaseModel):\n    payout_id: int = Field(..., description=\"New payout ID\", example=25)\n    campaign_id: int = Field(..., description=\"Campaign identifier\", example=42)\n    payout_method_id: int = Field(..., description=\"Payout method identifier\", example=8)\n    amount_usd: float = Field(..., description=\"Amount requested in USD\", example=2500.0)\n    status: str = Field(..., description=\"Payout status\", example=\"pending\")\n    risk_level: str = Field(..., description=\"Risk level classification\", example=\"low\")\n    risk_flags: List[RiskFlagItem] = Field(..., description=\"Risk/fraud flags\")\n    verification_required: bool = Field(..., description=\"Are verification docs required?\", example=True)\n    verification_requirements: List[VerificationRequirementItem] = Field(..., description=\"Verification requirements\")\n\n# Endpoint Implementations\n\n@app.post(\n    \"/api/campaigns\",\n    summary=\"Create a new fundraising campaign\",\n    description=\"Create a campaign with a title, category, goal, beneficiary, location, and images for the current user.\",\n    tags=[\"campaigns\"],\n    operation_id=\"create_campaign\",\n    response_model=CampaignResponse,\n)\nasync def create_campaign(\n    req: CreateCampaignRequest,\n):\n    session = SessionLocal()\n    user_id = 1\n    category = session.query(Category).filter(Category.name == req.category_name).first()\n    if not category:\n        category = Category(name=req.category_name)\n        session.add(category)\n        session.commit()\n        session.refresh(category)\n    campaign = Campaign(\n        owner_user_id=user_id,\n        category_id=category.id,\n        title=req.title,\n        beneficiary_name=req.beneficiary_name,\n        location_city=req.location_city,\n        location_region=req.location_region,\n        goal_amount_cents=int(round(req.goal_amount_usd * 100)),\n    )\n    session.add(campaign)\n    session.commit()\n    session.refresh(campaign)\n    for idx, item in enumerate(req.image_metadata):\n        media = CampaignMedia(\n            campaign_id=campaign.id,\n            filename=item.filename,\n            alt_text=item.alt,\n            sort_order=idx,\n        )\n        session.add(media)\n    session.commit()\n    resp = CampaignResponse(\n        campaign_id=campaign.id,\n        title=campaign.title,\n        status=campaign.status,\n        created_at=campaign.created_at.replace(microsecond=0).isoformat() + \"Z\",\n    )\n    session.close()\n    return resp\n\n@app.patch(\n    \"/api/campaigns/{campaign_id}\",\n    summary=\"Update goal amount and location of a campaign\",\n    description=\"Update a campaign's goal amount and location fields. Use for changing funding goals or event locations.\",\n    tags=[\"campaigns\"],\n    operation_id=\"update_campaign_goal_and_location\",\n    response_model=UpdateCampaignGoalAndLocationResponse,\n)\nasync def update_campaign_goal_and_location(\n    campaign_id: int = Path(..., description=\"Campaign identifier\", example=42),\n    req: UpdateCampaignGoalAndLocationRequest = Body(...),\n):\n    session = SessionLocal()\n    user_id = 1\n    campaign = session.query(Campaign).filter(Campaign.id == campaign_id, Campaign.owner_user_id == user_id).first()\n    if req.goal_amount_usd is not None:\n        campaign.goal_amount_cents = int(round(req.goal_amount_usd * 100))\n    if req.location_city is not None:\n        campaign.location_city = req.location_city\n    if req.location_region is not None:\n        campaign.location_region = req.location_region\n    campaign.updated_at = datetime.datetime.utcnow()\n    session.commit()\n    resp = UpdateCampaignGoalAndLocationResponse(\n        campaign_id=campaign.id,\n        title=campaign.title,\n        goal_amount_usd=campaign.goal_amount_cents / 100.0,\n        location_city=campaign.location_city,\n        location_region=campaign.location_region,\n        updated_at=campaign.updated_at.replace(microsecond=0).isoformat() + \"Z\",\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/campaigns/{campaign_id}/updates\",\n    summary=\"Post a campaign update\",\n    description=\"Add an update with a title and body to a campaign. Use for progress announcements or events.\",\n    tags=[\"campaigns\", \"campaign_updates\"],\n    operation_id=\"create_campaign_update\",\n    response_model=CampaignUpdateResponse,\n)\nasync def create_campaign_update(\n    campaign_id: int = Path(..., description=\"Campaign identifier\", example=42),\n    req: CampaignUpdateRequest = Body(...),\n):\n    session = SessionLocal()\n    user_id = 1\n    campaign = session.query(Campaign).filter(Campaign.id == campaign_id, Campaign.owner_user_id == user_id).first()\n    update = CampaignUpdate(\n        campaign_id=campaign_id,\n        author_user_id=user_id,\n        title=req.title,\n        body=req.body,\n    )\n    session.add(update)\n    session.commit()\n    session.refresh(update)\n    resp = CampaignUpdateResponse(\n        update_id=update.id,\n        campaign_id=update.campaign_id,\n        title=update.title,\n        body=update.body,\n        created_at=update.created_at.replace(microsecond=0).isoformat() + \"Z\",\n    )\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/campaigns/search\",\n    summary=\"Search campaigns by category and location\",\n    description=\"Find campaigns filtered by category name and city/region, sorted by amount raised descending.\",\n    tags=[\"campaigns\"],\n    operation_id=\"search_campaigns_by_category_location\",\n    response_model=SearchCampaignsByCategoryLocationResponse,\n)\nasync def search_campaigns_by_category_location(\n    category_name: str = Query(..., description=\"Campaign category name\", example=\"Animals\"),\n    location_city: str = Query(..., description=\"Campaign city\", example=\"Seattle\"),\n    location_region: str = Query(..., description=\"Campaign region/state\", example=\"WA\"),\n    top_n: Optional[int] = Query(None, description=\"Limit to top N campaigns\", example=5),\n):\n    session = SessionLocal()\n    category = session.query(Category).filter(Category.name == category_name).first()\n    campaigns = []\n    if category:\n        query = session.query(Campaign).filter(\n            Campaign.category_id == category.id,\n            Campaign.location_city == location_city,\n            Campaign.location_region == location_region,\n            Campaign.status == \"active\"\n        )\n        campaign_list = list(query)\n        result = []\n        for c in campaign_list:\n            donation_sum = session.query(func.coalesce(func.sum(Donation.amount_cents), 0)).filter(Donation.campaign_id == c.id).scalar()\n            result.append({\n                \"campaign\": c,\n                \"amount_raised\": donation_sum or 0,\n            })\n        result.sort(key=lambda x: x[\"amount_raised\"], reverse=True)\n        if top_n is not None:\n            result = result[:top_n]\n        for entry in result:\n            c = entry[\"campaign\"]\n            amount_raised = entry[\"amount_raised\"]\n            campaigns.append(SearchCampaignsByCategoryLocationResponseItem(\n                campaign_id=c.id,\n                title=c.title,\n                category_name=category_name,\n                location_city=c.location_city,\n                location_region=c.location_region,\n                goal_amount_usd=c.goal_amount_cents / 100.0,\n                amount_raised_usd=(amount_raised / 100.0) if amount_raised else 0.0,\n                status=c.status,\n            ))\n    resp = SearchCampaignsByCategoryLocationResponse(campaigns=campaigns)\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/donation_intents\",\n    summary=\"Create a one-time donation intent for a campaign\",\n    description=\"Create a donation intent specifying campaign, donor name, amount, public message, and anonymity.\",\n    tags=[\"donations\", \"donation_intents\"],\n    operation_id=\"create_one_time_donation_intent\",\n    response_model=CreateDonationIntentResponse,\n)\nasync def create_one_time_donation_intent(\n    req: CreateDonationIntentRequest,\n):\n    session = SessionLocal()\n    user_id = 1\n    campaign = session.query(Campaign).filter(Campaign.title == req.campaign_title).first()\n    donation_intent = DonationIntent(\n        campaign_id=campaign.id,\n        donor_user_id=user_id,\n        donor_name=req.donor_name,\n        message=req.message,\n        is_anonymous=1 if req.is_anonymous else 0,\n        kind=\"one_time\",\n        currency_code=\"USD\",\n        amount_cents=int(round(req.amount_usd * 100)),\n        status=\"active\",\n    )\n    session.add(donation_intent)\n    session.commit()\n    session.refresh(donation_intent)\n    resp = CreateDonationIntentResponse(\n        donation_intent_id=donation_intent.id,\n        campaign_id=campaign.id,\n        donor_name=donation_intent.donor_name,\n        amount_usd=donation_intent.amount_cents / 100.0,\n        kind=donation_intent.kind,\n        status=donation_intent.status,\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/donation_intents\",\n    summary=\"Create a recurring monthly donation intent for a campaign\",\n    description=\"Create a recurring donation intent including start date, interval info, donor details, and anonymity.\",\n    tags=[\"donations\", \"donation_intents\"],\n    operation_id=\"create_recurring_donation_intent\",\n    response_model=CreateRecurringDonationIntentResponse,\n)\nasync def create_recurring_donation_intent(\n    req: CreateRecurringDonationIntentRequest,\n):\n    session = SessionLocal()\n    user_id = 1\n    campaign = session.query(Campaign).filter(Campaign.title == req.campaign_title).first()\n    start_date_obj = datetime.datetime.strptime(req.start_date, \"%Y-%m-%d\").date()\n    donation_intent = DonationIntent(\n        campaign_id=campaign.id,\n        donor_user_id=user_id,\n        donor_name=req.donor_name,\n        message=req.message,\n        is_anonymous=1 if req.is_anonymous else 0,\n        kind=\"recurring\",\n        currency_code=\"USD\",\n        amount_cents=int(round(req.amount_usd * 100)),\n        start_date=start_date_obj,\n        interval_unit=req.interval_unit,\n        interval_count=req.interval_count,\n        status=\"active\",\n    )\n    session.add(donation_intent)\n    session.commit()\n    session.refresh(donation_intent)\n    resp = CreateRecurringDonationIntentResponse(\n        donation_intent_id=donation_intent.id,\n        campaign_id=campaign.id,\n        donor_name=donation_intent.donor_name,\n        amount_usd=donation_intent.amount_cents / 100.0,\n        kind=donation_intent.kind,\n        status=donation_intent.status,\n        start_date=donation_intent.start_date.isoformat(),\n        interval_unit=donation_intent.interval_unit,\n        interval_count=donation_intent.interval_count,\n    )\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/donations/history\",\n    summary=\"Fetch authenticated user's donation history for last 90 days\",\n    description=\"Get all donations made by the current user in the last 90 days, including campaign title, amount, date, and donation type.\",\n    tags=[\"donations\"],\n    operation_id=\"fetch_my_donation_history\",\n    response_model=FetchMyDonationHistoryResponse,\n)\nasync def fetch_my_donation_history():\n    session = SessionLocal()\n    user_id = 1\n    since = datetime.datetime.utcnow() - datetime.timedelta(days=90)\n    query = session.query(Donation).filter(\n        Donation.donor_user_id == user_id,\n        Donation.donated_at >= since\n    )\n    items = []\n    for donation in query.order_by(Donation.donated_at.desc()).all():\n        campaign = session.query(Campaign).filter(Campaign.id == donation.campaign_id).first()\n        d_intent = session.query(DonationIntent).filter(DonationIntent.id == donation.donation_intent_id).first() if donation.donation_intent_id else None\n        kind = d_intent.kind if d_intent else \"one_time\"\n        items.append(FetchMyDonationHistoryDonation(\n            donation_id=donation.id,\n            campaign_title=campaign.title,\n            amount_usd=donation.amount_cents / 100.0,\n            donated_at=donation.donated_at.replace(microsecond=0).isoformat() + \"Z\",\n            kind=kind,\n        ))\n    resp = FetchMyDonationHistoryResponse(donations=items)\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/receipts\",\n    summary=\"Generate donation receipt metadata\",\n    description=\"Fetch receipt metadata for a specific donation to a campaign by date and amount.\",\n    tags=[\"receipts\"],\n    operation_id=\"fetch_donation_receipt_metadata\",\n    response_model=FetchDonationReceiptMetadataResponse,\n)\nasync def fetch_donation_receipt_metadata(\n    campaign_title: str = Query(..., description=\"Title of campaign receiving the donation\", example=\"Community Food Pantry Restock\"),\n    donation_date: str = Query(..., description=\"Donation date, format YYYY-MM-DD\", example=\"2026-01-20\"),\n    amount_usd: float = Query(..., description=\"Donation amount in USD\", example=75.0),\n):\n    session = SessionLocal()\n    user_id = 1\n    campaign = session.query(Campaign).filter(Campaign.title == campaign_title).first()\n    date_lower = datetime.datetime.strptime(donation_date, \"%Y-%m-%d\")\n    date_upper = date_lower + datetime.timedelta(days=1)\n    donation = session.query(Donation).filter(\n        Donation.campaign_id == campaign.id,\n        Donation.donor_user_id == user_id,\n        Donation.amount_cents == int(round(amount_usd * 100)),\n        Donation.donated_at >= date_lower,\n        Donation.donated_at < date_upper,\n    ).order_by(Donation.donated_at.desc()).first()\n    receipt = session.query(Receipt).filter(Receipt.donation_id == donation.id).first()\n    resp = FetchDonationReceiptMetadataResponse(\n        receipt_id=receipt.id,\n        receipt_number=receipt.receipt_number,\n        issued_at=receipt.issued_at.replace(microsecond=0).isoformat() + \"Z\",\n        total_usd=receipt.total_amount_cents / 100.0,\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/payout_methods\",\n    summary=\"Add a new bank account payout method for user\",\n    description=\"Add a bank account payout method for the current user and return the details including default status.\",\n    tags=[\"payout_methods\"],\n    operation_id=\"create_bank_account_payout_method\",\n    response_model=CreateBankAccountPayoutMethodResponse,\n)\nasync def create_bank_account_payout_method(\n    req: CreateBankAccountPayoutMethodRequest,\n):\n    session = SessionLocal()\n    user_id = 1\n    is_default = bool(req.is_default)\n    if is_default:\n        session.query(PayoutMethod).filter(PayoutMethod.owner_user_id == user_id, PayoutMethod.is_default == 1).update({PayoutMethod.is_default:0})\n        session.commit()\n    payout_method = PayoutMethod(\n        owner_user_id=user_id,\n        type=\"bank_account\",\n        bank_name=req.bank_name,\n        account_last4=req.account_last4,\n        account_type=req.account_type,\n        is_default=1 if is_default else 0,\n    )\n    session.add(payout_method)\n    session.commit()\n    session.refresh(payout_method)\n    resp = CreateBankAccountPayoutMethodResponse(\n        payout_method_id=payout_method.id,\n        bank_name=payout_method.bank_name,\n        account_last4=payout_method.account_last4,\n        account_type=payout_method.account_type,\n        is_default=bool(payout_method.is_default),\n    )\n    session.close()\n    return resp\n\n@app.put(\n    \"/api/campaigns/{campaign_id}/payout_settings\",\n    summary=\"Set default payout method for campaign\",\n    description=\"Configure payout settings for a campaign by setting the default payout method for withdrawals.\",\n    tags=[\"payout_methods\", \"campaigns\"],\n    operation_id=\"set_campaign_default_payout_method\",\n    response_model=SetCampaignDefaultPayoutMethodResponse,\n)\nasync def set_campaign_default_payout_method(\n    campaign_id: int = Path(..., description=\"Campaign identifier\", example=42),\n    req: SetCampaignDefaultPayoutMethodRequest = Body(...),\n):\n    session = SessionLocal()\n    user_id = 1\n    campaign = session.query(Campaign).filter(Campaign.id == campaign_id, Campaign.owner_user_id == user_id).first()\n    s = session.query(CampaignPayoutSettings).filter(CampaignPayoutSettings.campaign_id == campaign_id).first()\n    t = datetime.datetime.utcnow()\n    if s:\n        s.default_payout_method_id = req.payout_method_id\n        s.updated_at = t\n    else:\n        s = CampaignPayoutSettings(\n            campaign_id=campaign_id,\n            default_payout_method_id=req.payout_method_id,\n            created_at=t,\n            updated_at=t,\n        )\n        session.add(s)\n    session.commit()\n    resp = SetCampaignDefaultPayoutMethodResponse(\n        campaign_id=campaign_id,\n        default_payout_method_id=req.payout_method_id,\n        updated_at=s.updated_at.replace(microsecond=0).isoformat() + \"Z\",\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/payouts\",\n    summary=\"Request a payout from a campaign to default bank account\",\n    description=\"Request a payout for a campaign to the default payout method. Returns payout status and any risk/verification requirements.\",\n    tags=[\"payouts\", \"campaigns\"],\n    operation_id=\"create_campaign_payout_to_default\",\n    response_model=CreateCampaignPayoutToDefaultResponse,\n)\nasync def create_campaign_payout_to_default(\n    req: CreateCampaignPayoutToDefaultRequest,\n):\n    session = SessionLocal()\n    user_id = 1\n    campaign = session.query(Campaign).filter(Campaign.id == req.campaign_id, Campaign.owner_user_id == user_id).first()\n    ps = session.query(CampaignPayoutSettings).filter(CampaignPayoutSettings.campaign_id == req.campaign_id).first()\n    payout_method_id = ps.default_payout_method_id\n    amount_cents = int(round(req.amount_usd * 100))\n    # Simulate risk\n    risk_level = \"low\"\n    risk_flags_list = []\n    verification_required = False\n    verification_requirements = []\n    if req.amount_usd >= 2000.0:\n        risk_level = \"medium\"\n        risk_flags_list.append(\"large_withdrawal\")\n        verification_required = True\n        v = PayoutVerificationRequirement(\n            requirement_type=\"identity_document\",\n            status=\"required\",\n            notes=\"Upload government ID\",\n            payout_id=None,\n        )\n        verification_requirements.append(v)\n    payout = Payout(\n        campaign_id=req.campaign_id,\n        payout_method_id=payout_method_id,\n        amount_cents=amount_cents,\n        status=\"pending\",\n        currency_code=\"USD\",\n        risk_level=risk_level,\n        risk_flags_json=json.dumps(risk_flags_list),\n        verification_required=1 if verification_required else 0,\n    )\n    session.add(payout)\n    session.commit()\n    session.refresh(payout)\n    vr_items = []\n    if verification_required:\n        v.payout_id = payout.id\n        session.add(v)\n        session.commit()\n        session.refresh(v)\n        vr_items.append(VerificationRequirementItem(requirement_type=v.requirement_type, status=v.status, notes=v.notes))\n    resp = CreateCampaignPayoutToDefaultResponse(\n        payout_id=payout.id,\n        campaign_id=req.campaign_id,\n        payout_method_id=payout_method_id,\n        amount_usd=amount_cents / 100.0,\n        status=payout.status,\n        risk_level=risk_level,\n        risk_flags=[RiskFlagItem(flag=f) for f in risk_flags_list],\n        verification_required=bool(payout.verification_required),\n        verification_requirements=vr_items,\n    )\n    session.close()\n    return resp\n\nif __name__ == \"__main__\":\n    import uvicorn\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
{"scenario": "DoorDash Drive (Delivery Tracking)", "db_path": "./outputs/databases/doordash_drive_delivery_tracking.db", "full_code": "import os\nfrom fastapi import FastAPI, Query, Path, Body\nfrom pydantic import BaseModel, Field, ConfigDict\nfrom typing import List, Optional, Dict\nfrom sqlalchemy import create_engine, Column, Integer, String, Text, Float, Boolean, DateTime, ForeignKey, UniqueConstraint, Index, CheckConstraint, Table\nfrom sqlalchemy.orm import declarative_base, relationship, sessionmaker\nfrom sqlalchemy.sql import func\n\nDATABASE_PATH = os.getenv(\"DATABASE_PATH\", \"sqlite:///xxxx.db\")\nengine = create_engine(DATABASE_PATH, connect_args={\"check_same_thread\": False})\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\nBase = declarative_base()\napp = FastAPI()\n\nclass User(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, unique=True, nullable=False)\n    email = Column(String, unique=True, nullable=False)\n    full_name = Column(String)\n    profile_json = Column(Text)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass Merchant(Base):\n    __tablename__ = \"merchants\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, unique=True, nullable=False)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass Address(Base):\n    __tablename__ = \"addresses\"\n    id = Column(Integer, primary_key=True)\n    line1 = Column(String, nullable=False)\n    line2 = Column(String)\n    city = Column(String, nullable=False)\n    state = Column(String, nullable=False)\n    postal_code = Column(String, nullable=False)\n    country = Column(String, nullable=False, default=\"US\")\n    formatted = Column(String)\n    lat = Column(Float)\n    lng = Column(Float)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass MerchantLocation(Base):\n    __tablename__ = \"merchant_locations\"\n    id = Column(Integer, primary_key=True)\n    merchant_id = Column(Integer, ForeignKey(\"merchants.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    pickup_address_id = Column(Integer, ForeignKey(\"addresses.id\", ondelete=\"SET NULL\"))\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    __table_args__ = (UniqueConstraint('merchant_id', 'name'),)\n\nclass Customer(Base):\n    __tablename__ = \"customers\"\n    id = Column(Integer, primary_key=True)\n    full_name = Column(String, nullable=False)\n    phone = Column(String)\n    email = Column(String)\n    default_address_id = Column(Integer, ForeignKey(\"addresses.id\", ondelete=\"SET NULL\"))\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass DeliveryOrder(Base):\n    __tablename__ = \"delivery_orders\"\n    id = Column(Integer, primary_key=True)\n    external_order_ref = Column(String, unique=True)\n    merchant_id = Column(Integer, ForeignKey(\"merchants.id\", ondelete=\"RESTRICT\"), nullable=False)\n    merchant_location_id = Column(Integer, ForeignKey(\"merchant_locations.id\", ondelete=\"SET NULL\"))\n    created_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    customer_id = Column(Integer, ForeignKey(\"customers.id\", ondelete=\"SET NULL\"))\n    pickup_address_id = Column(Integer, ForeignKey(\"addresses.id\", ondelete=\"RESTRICT\"), nullable=False)\n    dropoff_address_id = Column(Integer, ForeignKey(\"addresses.id\", ondelete=\"RESTRICT\"), nullable=False)\n    pickup_window_start = Column(DateTime)\n    pickup_window_end = Column(DateTime)\n    dropoff_window_start = Column(DateTime)\n    dropoff_window_end = Column(DateTime)\n    special_instructions = Column(Text)\n    current_status = Column(String, CheckConstraint(\"current_status IN ('created','scheduled','dispatched','assigned','confirmed','picked_up','en_route','delivered','canceled','failed')\"), nullable=False, default=\"created\")\n    latest_eta = Column(DateTime)\n    canceled_at = Column(DateTime)\n    cancel_reason = Column(Text)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass DeliveryOrderItem(Base):\n    __tablename__ = \"delivery_order_items\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    quantity = Column(Integer, CheckConstraint(\"quantity > 0\"), nullable=False)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass Driver(Base):\n    __tablename__ = \"drivers\"\n    id = Column(Integer, primary_key=True)\n    display_name = Column(String, nullable=False)\n    phone = Column(String)\n    is_active = Column(Integer, CheckConstraint(\"is_active IN (0,1)\"), default=1, nullable=False)\n    availability_status = Column(String, CheckConstraint(\"availability_status IN ('available','unavailable','on_delivery')\"), nullable=False, default=\"available\")\n    last_known_lat = Column(Float)\n    last_known_lng = Column(Float)\n    last_known_at = Column(DateTime)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass DispatchBatch(Base):\n    __tablename__ = \"dispatch_batches\"\n    id = Column(Integer, primary_key=True)\n    merchant_location_id = Column(Integer, ForeignKey(\"merchant_locations.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    pickup_window_start = Column(DateTime)\n    pickup_window_end = Column(DateTime)\n    created_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass DispatchBatchOrder(Base):\n    __tablename__ = \"dispatch_batch_orders\"\n    batch_id = Column(Integer, ForeignKey(\"dispatch_batches.id\", ondelete=\"CASCADE\"), primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), primary_key=True)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass OrderAssignment(Base):\n    __tablename__ = \"order_assignments\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    driver_id = Column(Integer, ForeignKey(\"drivers.id\", ondelete=\"RESTRICT\"), nullable=False)\n    assigned_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    assigned_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    pickup_time_planned = Column(DateTime)\n    dispatch_note = Column(Text)\n    unassigned_at = Column(DateTime)\n    unassigned_reason = Column(Text)\n    is_current = Column(Integer, CheckConstraint(\"is_current IN (0,1)\"), nullable=False, default=1)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass OrderStatusEvent(Base):\n    __tablename__ = \"order_status_events\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    status = Column(String, CheckConstraint(\"status IN ('created','scheduled','dispatched','assigned','confirmed','picked_up','en_route','delivered','canceled','failed')\"), nullable=False)\n    event_time = Column(DateTime, nullable=False)\n    eta = Column(DateTime)\n    notes = Column(Text)\n    created_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass OrderGpsPing(Base):\n    __tablename__ = \"order_gps_pings\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    driver_id = Column(Integer, ForeignKey(\"drivers.id\", ondelete=\"SET NULL\"))\n    ping_time = Column(DateTime, nullable=False)\n    lat = Column(Float, nullable=False)\n    lng = Column(Float, nullable=False)\n    accuracy_m = Column(Float)\n    source = Column(String)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass ProofOfDelivery(Base):\n    __tablename__ = \"proof_of_delivery\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), unique=True, nullable=False)\n    photo_url = Column(String)\n    photo_timestamp = Column(DateTime)\n    photo_notes = Column(Text)\n    recipient_signature_name = Column(String)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass Refund(Base):\n    __tablename__ = \"refunds\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    amount_cents = Column(Integer, CheckConstraint(\"amount_cents >= 0\"), nullable=False)\n    currency = Column(String, nullable=False, default=\"USD\")\n    reason = Column(Text)\n    issued_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    issued_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass InternalNote(Base):\n    __tablename__ = \"internal_notes\"\n    id = Column(Integer, primary_key=True)\n    entity_type = Column(String, CheckConstraint(\"entity_type IN ('order','batch','support_case')\"), nullable=False)\n    entity_id = Column(Integer, nullable=False)\n    author_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    note = Column(Text, nullable=False)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass SupportCase(Base):\n    __tablename__ = \"support_cases\"\n    id = Column(Integer, primary_key=True)\n    order_id = Column(Integer, ForeignKey(\"delivery_orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    channel = Column(String, CheckConstraint(\"channel IN ('chat','email','phone')\"), nullable=False)\n    customer_message = Column(Text, nullable=False)\n    priority = Column(String, CheckConstraint(\"priority IN ('low','medium','high','urgent')\"), nullable=False)\n    resolution_code = Column(String, CheckConstraint(\"resolution_code IN ('not_received','late_delivery','wrong_order','damaged','refund_request','other')\"))\n    status = Column(String, CheckConstraint(\"status IN ('open','in_progress','resolved','closed')\"), nullable=False, default=\"open\")\n    created_by_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    assigned_to_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"SET NULL\"))\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n    updated_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nclass SupportCaseNote(Base):\n    __tablename__ = \"support_case_notes\"\n    id = Column(Integer, primary_key=True)\n    case_id = Column(Integer, ForeignKey(\"support_cases.id\", ondelete=\"CASCADE\"), nullable=False)\n    author_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    note = Column(Text, nullable=False)\n    created_at = Column(DateTime, default=func.current_timestamp(), nullable=False)\n\nBase.metadata.create_all(engine)\n\nclass MerchantOut(BaseModel):\n    model_config = ConfigDict(from_attributes=True)\n    id: int = Field(..., description=\"Merchant's unique ID\", example=1)\n    name: str = Field(..., description=\"Merchant business name\", example=\"Bluebird Bakery\")\n    created_at: str = Field(..., description=\"Creation datetime (ISO8601)\", example=\"2024-06-11T08:10:00Z\")\n    updated_at: str = Field(..., description=\"Last update datetime (ISO8601)\", example=\"2024-06-11T09:00:00Z\")\n\nclass ListMerchantsResponse(BaseModel):\n    merchants: List[MerchantOut] = Field(..., description=\"List of merchants\", example=[{\"id\":1,\"name\":\"Bluebird Bakery\",\"created_at\":\"2024-06-11T08:10:00Z\",\"updated_at\":\"2024-06-11T09:00:00Z\"}])\n\n@app.get(\n    \"/api/merchants\",\n    summary=\"List all merchants with optional name filter\",\n    description=\"Retrieve all merchants, optionally filter by name. Use to lookup merchant IDs by name.\",\n    tags=[\"merchants\"],\n    operation_id=\"list_merchants\",\n    response_model=ListMerchantsResponse\n)\nasync def list_merchants(name: Optional[str] = Query(None, description=\"Filter merchants by exact name match\", example=\"Bluebird Bakery\")) -> ListMerchantsResponse:\n    session = SessionLocal()\n    query = session.query(Merchant)\n    if name is not None:\n        query = query.filter(Merchant.name == name)\n    merchants = query.all()\n    result = []\n    for m in merchants:\n        result.append(MerchantOut(\n            id=m.id,\n            name=m.name,\n            created_at=m.created_at.isoformat().replace(\"+00:00\",\"Z\") if m.created_at else \"\",\n            updated_at=m.updated_at.isoformat().replace(\"+00:00\",\"Z\") if m.updated_at else \"\"\n        ))\n    session.close()\n    return ListMerchantsResponse(merchants=result)\n\nclass MerchantLocationOut(BaseModel):\n    model_config = ConfigDict(from_attributes=True)\n    id: int = Field(..., description=\"Merchant location ID\", example=2)\n    merchant_id: int = Field(..., description=\"Associated merchant ID\", example=1)\n    name: str = Field(..., description=\"Location name\", example=\"Bluebird Bakery - Downtown\")\n    pickup_address_id: Optional[int] = Field(None, description=\"Pickup address ID\", example=5)\n\nclass ListMerchantLocationsResponse(BaseModel):\n    locations: List[MerchantLocationOut] = Field(..., description=\"List of merchant locations\", example=[{\"id\":2,\"merchant_id\":1,\"name\":\"Bluebird Bakery - Downtown\",\"pickup_address_id\":5}])\n\n@app.get(\n    \"/api/merchant-locations\",\n    summary=\"List merchant locations by merchant name or ID\",\n    description=\"Get all merchant locations for a given merchant name or merchant_id.\",\n    tags=[\"merchant_locations\"],\n    operation_id=\"list_merchant_locations\",\n    response_model=ListMerchantLocationsResponse\n)\nasync def list_merchant_locations(\n    merchant_id: Optional[int] = Query(None, description=\"Merchant ID to filter locations\", example=1),\n    merchant_name: Optional[str] = Query(None, description=\"Merchant name (exact)\", example=\"Bluebird Bakery\")\n) -> ListMerchantLocationsResponse:\n    session = SessionLocal()\n    mid = merchant_id\n    if merchant_name is not None and merchant_id is None:\n        merch = session.query(Merchant).filter(Merchant.name == merchant_name).first()\n        if merch:\n            mid = merch.id\n    query = session.query(MerchantLocation)\n    if mid is not None:\n        query = query.filter(MerchantLocation.merchant_id == mid)\n    locs = query.all()\n    result = []\n    for l in locs:\n        result.append(MerchantLocationOut(\n            id=l.id,\n            merchant_id=l.merchant_id,\n            name=l.name,\n            pickup_address_id=l.pickup_address_id\n        ))\n    session.close()\n    return ListMerchantLocationsResponse(locations=result)\n\nclass AddressCreate(BaseModel):\n    line1: str = Field(..., description=\"Street address line 1\", example=\"1200 Market St\")\n    line2: Optional[str] = Field(None, description=\"Street address line 2\", example=\"Suite 101\")\n    city: str = Field(..., description=\"City\", example=\"San Francisco\")\n    state: str = Field(..., description=\"State/Province\", example=\"CA\")\n    postal_code: str = Field(..., description=\"Postal code\", example=\"94102\")\n    country: Optional[str] = Field(None, description=\"Country code (default US)\", example=\"US\")\n    formatted: Optional[str] = Field(None, description=\"Pre-formatted address (optional)\", example=\"1200 Market St, San Francisco, CA 94102\")\n    lat: Optional[float] = Field(None, description=\"Latitude\", example=37.7763)\n    lng: Optional[float] = Field(None, description=\"Longitude\", example=-122.4177)\n\nclass AddressCreateResponse(BaseModel):\n    id: int = Field(..., description=\"New address ID\", example=5)\n\n@app.post(\n    \"/api/addresses\",\n    summary=\"Create a new address entry\",\n    description=\"Create an address; use for pickup and dropoff locations for orders.\",\n    tags=[\"addresses\"],\n    operation_id=\"create_address\",\n    response_model=AddressCreateResponse\n)\nasync def create_address(body: AddressCreate = Body(...)) -> AddressCreateResponse:\n    session = SessionLocal()\n    a = Address(\n        line1=body.line1,\n        line2=body.line2,\n        city=body.city,\n        state=body.state,\n        postal_code=body.postal_code,\n        country=body.country if body.country is not None else \"US\",\n        formatted=body.formatted,\n        lat=body.lat,\n        lng=body.lng\n    )\n    session.add(a)\n    session.commit()\n    session.refresh(a)\n    id_ = a.id\n    session.close()\n    return AddressCreateResponse(id=id_)\n\nclass DeliveryOrderCreate(BaseModel):\n    external_order_ref: Optional[str] = Field(None, description=\"External order reference for merchant\", example=\"BB-10482\")\n    merchant_id: int = Field(..., description=\"Merchant ID\", example=1)\n    merchant_location_id: Optional[int] = Field(None, description=\"Merchant location ID\", example=2)\n    customer_id: Optional[int] = Field(None, description=\"Customer ID (if available)\", example=12)\n    pickup_address_id: int = Field(..., description=\"Pickup address ID\", example=5)\n    dropoff_address_id: int = Field(..., description=\"Dropoff address ID\", example=6)\n    pickup_window_start: Optional[str] = Field(None, description=\"Pickup window start ISO8601\", example=\"2024-06-11T14:00:00-07:00\")\n    pickup_window_end: Optional[str] = Field(None, description=\"Pickup window end ISO8601\", example=\"2024-06-11T15:00:00-07:00\")\n    dropoff_window_start: Optional[str] = Field(None, description=\"Dropoff window start ISO8601\", example=\"2024-06-11T14:20:00-07:00\")\n    dropoff_window_end: Optional[str] = Field(None, description=\"Dropoff window end ISO8601\", example=\"2024-06-11T15:30:00-07:00\")\n    special_instructions: Optional[str] = Field(None, description=\"Special delivery instructions\", example=\"Call on arrival; leave at front desk if no answer\")\n\nclass DeliveryOrderCreateResponse(BaseModel):\n    id: int = Field(..., description=\"Delivery order ID\", example=101)\n\n@app.post(\n    \"/api/delivery-orders\",\n    summary=\"Create a new delivery order\",\n    description=\"Create a delivery order for a merchant, location, with pickup/dropoff information, delivery window, and instructions.\",\n    tags=[\"delivery_orders\"],\n    operation_id=\"create_delivery_order\",\n    response_model=DeliveryOrderCreateResponse\n)\nasync def create_delivery_order(body: DeliveryOrderCreate = Body(...)) -> DeliveryOrderCreateResponse:\n    session = SessionLocal()\n    o = DeliveryOrder(\n        external_order_ref=body.external_order_ref,\n        merchant_id=body.merchant_id,\n        merchant_location_id=body.merchant_location_id,\n        created_by_user_id=1,\n        customer_id=body.customer_id,\n        pickup_address_id=body.pickup_address_id,\n        dropoff_address_id=body.dropoff_address_id,\n        pickup_window_start=body.pickup_window_start,\n        pickup_window_end=body.pickup_window_end,\n        dropoff_window_start=body.dropoff_window_start,\n        dropoff_window_end=body.dropoff_window_end,\n        special_instructions=body.special_instructions,\n        current_status=\"created\"\n    )\n    session.add(o)\n    session.commit()\n    session.refresh(o)\n    id_ = o.id\n    session.close()\n    return DeliveryOrderCreateResponse(id=id_)\n\nclass DeliveryOrderItemCreate(BaseModel):\n    order_id: int = Field(..., description=\"Delivery order ID\", example=101)\n    name: str = Field(..., description=\"Item name\", example=\"Croissant\")\n    quantity: int = Field(..., description=\"Quantity of item\", example=6)\n\nclass DeliveryOrderItemCreateResponse(BaseModel):\n    id: int = Field(..., description=\"Delivery order item ID\", example=1)\n\n@app.post(\n    \"/api/delivery-order-items\",\n    summary=\"Add an item to a delivery order\",\n    description=\"Add a single item and quantity to an existing delivery order.\",\n    tags=[\"delivery_orders\", \"order_items\"],\n    operation_id=\"add_delivery_order_item\",\n    response_model=DeliveryOrderItemCreateResponse\n)\nasync def add_delivery_order_item(body: DeliveryOrderItemCreate = Body(...)) -> DeliveryOrderItemCreateResponse:\n    session = SessionLocal()\n    item = DeliveryOrderItem(\n        order_id=body.order_id,\n        name=body.name,\n        quantity=body.quantity\n    )\n    session.add(item)\n    session.commit()\n    session.refresh(item)\n    id_ = item.id\n    session.close()\n    return DeliveryOrderItemCreateResponse(id=id_)\n\nclass DeliveryOrderSummaryOut(BaseModel):\n    id: int = Field(..., description=\"Order ID\", example=101)\n    external_order_ref: Optional[str] = Field(None, description=\"Merchant's external order reference (if any)\", example=\"BB-10482\")\n    customer_full_name: Optional[str] = Field(None, description=\"Customer's full name\", example=\"Arjun Patel\")\n    current_status: str = Field(..., description=\"Latest status of the order\", example=\"en_route\")\n    latest_eta: Optional[str] = Field(None, description=\"Order's current ETA (ISO8601)\", example=\"2024-06-11T14:42:00-07:00\")\n\nclass ListDeliveryOrdersResponse(BaseModel):\n    orders: List[DeliveryOrderSummaryOut] = Field(..., description=\"Order summaries\", example=[{\"id\":101, \"external_order_ref\":\"BB-10482\",\"customer_full_name\":\"Arjun Patel\",\"current_status\":\"en_route\",\"latest_eta\":\"2024-06-11T14:42:00-07:00\"}])\n\n@app.get(\n    \"/api/delivery-orders\",\n    summary=\"List delivery orders for a merchant\",\n    description=\"Get all delivery orders for a merchant filtered by creation time, with key fields for status board.\",\n    tags=[\"delivery_orders\"],\n    operation_id=\"list_delivery_orders_by_merchant\",\n    response_model=ListDeliveryOrdersResponse\n)\nasync def list_delivery_orders_by_merchant(\n    merchant_id: int = Query(..., description=\"Merchant ID to filter orders\", example=1),\n    created_after: str = Query(..., description=\"ISO8601 datetime; orders created after this\", example=\"2024-06-10T15:00:00-07:00\")\n) -> ListDeliveryOrdersResponse:\n    session = SessionLocal()\n    ordersq = session.query(DeliveryOrder).filter(DeliveryOrder.merchant_id == merchant_id)\n    if created_after is not None:\n        ordersq = ordersq.filter(DeliveryOrder.created_at > created_after)\n    orders = ordersq.all()\n    cust_map = {}\n    cust_ids = [o.customer_id for o in orders if o.customer_id is not None]\n    if cust_ids:\n        for cust in session.query(Customer).filter(Customer.id.in_(cust_ids)):\n            cust_map[cust.id] = cust.full_name\n    result = []\n    for o in orders:\n        result.append(DeliveryOrderSummaryOut(\n            id=o.id,\n            external_order_ref=o.external_order_ref,\n            customer_full_name=cust_map.get(o.customer_id) if o.customer_id is not None else None,\n            current_status=o.current_status,\n            latest_eta=o.latest_eta.isoformat() if o.latest_eta else None\n        ))\n    session.close()\n    return ListDeliveryOrdersResponse(orders=result)\n\nclass DispatchBatchCreate(BaseModel):\n    merchant_location_id: int = Field(..., description=\"Merchant location ID\", example=2)\n    name: str = Field(..., description=\"Batch descriptive name\", example=\"Downtown Afternoon Run\")\n    pickup_window_start: Optional[str] = Field(None, description=\"Pickup window start (ISO8601)\", example=\"2024-06-11T13:30:00-07:00\")\n    pickup_window_end: Optional[str] = Field(None, description=\"Pickup window end (ISO8601)\", example=\"2024-06-11T14:00:00-07:00\")\n\nclass DispatchBatchCreateResponse(BaseModel):\n    id: int = Field(..., description=\"Dispatch batch ID\", example=10)\n\n@app.post(\n    \"/api/dispatch-batches\",\n    summary=\"Create a new dispatch batch for a location\",\n    description=\"Create a dispatch batch for a location and pickup time window.\",\n    tags=[\"dispatch_batches\"],\n    operation_id=\"create_dispatch_batch\",\n    response_model=DispatchBatchCreateResponse\n)\nasync def create_dispatch_batch(body: DispatchBatchCreate = Body(...)) -> DispatchBatchCreateResponse:\n    session = SessionLocal()\n    batch = DispatchBatch(\n        merchant_location_id=body.merchant_location_id,\n        name=body.name,\n        pickup_window_start=body.pickup_window_start,\n        pickup_window_end=body.pickup_window_end,\n        created_by_user_id=1\n    )\n    session.add(batch)\n    session.commit()\n    session.refresh(batch)\n    id_ = batch.id\n    session.close()\n    return DispatchBatchCreateResponse(id=id_)\n\nclass DispatchBatchOrderCreate(BaseModel):\n    batch_id: int = Field(..., description=\"Dispatch batch ID\", example=10)\n    order_id: int = Field(..., description=\"Delivery order ID to batch\", example=101)\n\nclass DispatchBatchOrderCreateResponse(BaseModel):\n    success: bool = Field(..., description=\"True if successful\", example=True)\n\n@app.post(\n    \"/api/dispatch-batch-orders\",\n    summary=\"Add delivery order to a dispatch batch\",\n    description=\"Add a delivery order to an existing dispatch batch for bulk dispatch.\",\n    tags=[\"dispatch_batches\"],\n    operation_id=\"add_order_to_dispatch_batch\",\n    response_model=DispatchBatchOrderCreateResponse\n)\nasync def add_order_to_dispatch_batch(body: DispatchBatchOrderCreate = Body(...)) -> DispatchBatchOrderCreateResponse:\n    session = SessionLocal()\n    dbo = DispatchBatchOrder(\n        batch_id=body.batch_id,\n        order_id=body.order_id\n    )\n    session.add(dbo)\n    session.commit()\n    session.close()\n    return DispatchBatchOrderCreateResponse(success=True)\n\nclass DriverOut(BaseModel):\n    model_config = ConfigDict(from_attributes=True)\n    id: int = Field(..., description=\"Driver ID\", example=7)\n    display_name: str = Field(..., description=\"Driver's display name\", example=\"Miguel R.\")\n    availability_status: str = Field(..., description=\"Driver availability status\", example=\"available\")\n    last_known_lat: Optional[float] = Field(None, description=\"Last known latitude\", example=37.7751)\n    last_known_lng: Optional[float] = Field(None, description=\"Last known longitude\", example=-122.4149)\n    last_known_at: Optional[str] = Field(None, description=\"Timestamp of last known location (ISO8601)\", example=\"2024-06-11T14:08:00-07:00\")\n\nclass ListDriversResponse(BaseModel):\n    drivers: List[DriverOut] = Field(..., description=\"List of drivers\", example=[{\"id\":7,\"display_name\":\"Miguel R.\",\"availability_status\":\"available\",\"last_known_lat\":37.7751,\"last_known_lng\":-122.4149,\"last_known_at\":\"2024-06-11T14:08:00-07:00\"}])\n\n@app.get(\n    \"/api/drivers\",\n    summary=\"List drivers with optional filters for availability or location\",\n    description=\"List all drivers and optionally filter by display_name, status, active, or location box.\",\n    tags=[\"drivers\"],\n    operation_id=\"list_drivers\",\n    response_model=ListDriversResponse\n)\nasync def list_drivers(\n    display_name: Optional[str] = Query(None, description=\"Filter drivers by display name (exact match)\", example=\"Miguel R.\"),\n    is_active: Optional[bool] = Query(None, description=\"Filter: Only active drivers if true\", example=True),\n    availability_status: Optional[str] = Query(None, description=\"Driver status: available, unavailable, on_delivery\", example=\"available\")\n) -> ListDriversResponse:\n    session = SessionLocal()\n    query = session.query(Driver)\n    if display_name is not None:\n        query = query.filter(Driver.display_name == display_name)\n    if is_active is not None:\n        query = query.filter(Driver.is_active == (1 if is_active else 0))\n    if availability_status is not None:\n        query = query.filter(Driver.availability_status == availability_status)\n    drivers = query.all()\n    result = []\n    for d in drivers:\n        result.append(DriverOut(\n            id=d.id,\n            display_name=d.display_name,\n            availability_status=d.availability_status,\n            last_known_lat=d.last_known_lat,\n            last_known_lng=d.last_known_lng,\n            last_known_at=d.last_known_at.isoformat() if d.last_known_at else None\n        ))\n    session.close()\n    return ListDriversResponse(drivers=result)\n\nclass NearbyDriverOut(BaseModel):\n    id: int = Field(..., description=\"Driver ID\", example=8)\n    display_name: str = Field(..., description=\"Driver display name\", example=\"Jamie C.\")\n    distance_miles: float = Field(..., description=\"Distance from the search point\", example=2.8)\n    last_known_lat: Optional[float] = Field(None, description=\"Driver's latest latitude\", example=37.7758)\n    last_known_lng: Optional[float] = Field(None, description=\"Driver's latest longitude\", example=-122.4125)\n\nclass ListNearbyDriversResponse(BaseModel):\n    drivers: List[NearbyDriverOut] = Field(..., description=\"List of nearby drivers\", example=[{\"id\":8,\"display_name\":\"Jamie C.\",\"distance_miles\":2.8,\"last_known_lat\":37.7758,\"last_known_lng\":-122.4125}])\n\ndef haversine(lat1, lng1, lat2, lng2):\n    from math import radians, sin, cos, sqrt, atan2\n    R = 3959.87433\n    dlat = radians(lat2 - lat1)\n    dlng = radians(lng2 - lng1)\n    a = sin(dlat / 2)**2 + cos(radians(lat1)) * cos(radians(lat2)) * sin(dlng / 2)**2\n    c = 2 * atan2(sqrt(a), sqrt(1 - a))\n    return R * c\n\n@app.get(\n    \"/api/drivers/nearby\",\n    summary=\"List available drivers near location\",\n    description=\"Get available, active drivers within a specified distance (miles) of a lat/lng point.\",\n    tags=[\"drivers\"],\n    operation_id=\"list_available_drivers_nearby\",\n    response_model=ListNearbyDriversResponse\n)\nasync def list_available_drivers_nearby(\n    lat: float = Query(..., description=\"Latitude of the center point\", example=37.7763),\n    lng: float = Query(..., description=\"Longitude of the center point\", example=-122.4177),\n    radius_miles: float = Query(..., description=\"Search radius in miles\", example=3.0)\n) -> ListNearbyDriversResponse:\n    session = SessionLocal()\n    q = session.query(Driver).filter(\n        Driver.is_active == 1,\n        Driver.availability_status == \"available\",\n        Driver.last_known_lat != None,\n        Driver.last_known_lng != None\n    )\n    result = []\n    for d in q.all():\n        if d.last_known_lat is not None and d.last_known_lng is not None:\n            dist = haversine(lat, lng, d.last_known_lat, d.last_known_lng)\n            if dist <= radius_miles:\n                result.append(NearbyDriverOut(\n                    id=d.id,\n                    display_name=d.display_name,\n                    distance_miles=round(dist,2),\n                    last_known_lat=d.last_known_lat,\n                    last_known_lng=d.last_known_lng\n                ))\n    session.close()\n    return ListNearbyDriversResponse(drivers=result)\n\nclass OrderAssignmentCreate(BaseModel):\n    order_id: int = Field(..., description=\"Order ID to assign\", example=101)\n    driver_id: int = Field(..., description=\"Driver ID to assign\", example=7)\n    pickup_time_planned: Optional[str] = Field(None, description=\"Planned pickup time (ISO8601)\", example=\"2024-06-11T14:10:00-07:00\")\n    dispatch_note: Optional[str] = Field(None, description=\"Note for assigned driver on dispatch\", example=\"Traffic on US-101; use surface streets\")\n\nclass OrderAssignmentCreateResponse(BaseModel):\n    assignment_id: int = Field(..., description=\"Primary key for the assignment\", example=77)\n\n@app.post(\n    \"/api/order-assignments\",\n    summary=\"Assign a driver to an order\",\n    description=\"Assign an available driver to an order, specifying planned pickup time and note.\",\n    tags=[\"order_assignments\"],\n    operation_id=\"assign_driver_to_order\",\n    response_model=OrderAssignmentCreateResponse\n)\nasync def assign_driver_to_order(body: OrderAssignmentCreate = Body(...)) -> OrderAssignmentCreateResponse:\n    session = SessionLocal()\n    assignment = OrderAssignment(\n        order_id=body.order_id,\n        driver_id=body.driver_id,\n        assigned_by_user_id=1,\n        pickup_time_planned=body.pickup_time_planned,\n        dispatch_note=body.dispatch_note,\n        is_current=1\n    )\n    session.add(assignment)\n    session.commit()\n    session.refresh(assignment)\n    aid = assignment.id\n    session.close()\n    return OrderAssignmentCreateResponse(assignment_id=aid)\n\nclass UnassignCurrentRequest(BaseModel):\n    unassigned_reason: str = Field(..., description=\"Reason for unassignment\", example=\"vehicle issue\")\n\nclass UnassignCurrentResponse(BaseModel):\n    success: bool = Field(..., description=\"True if the assignment was unassigned\", example=True)\n\n@app.post(\n    \"/api/order-assignments/{order_id}/unassign-current\",\n    summary=\"Unassign current driver from order\",\n    description=\"Unset current driver assignment for an order, providing the unassignment reason.\",\n    tags=[\"order_assignments\"],\n    operation_id=\"unassign_current_driver_from_order\",\n    response_model=UnassignCurrentResponse\n)\nasync def unassign_current_driver_from_order(\n    order_id: int = Path(..., description=\"Order ID to unassign\", example=101),\n    body: UnassignCurrentRequest = Body(...)\n) -> UnassignCurrentResponse:\n    session = SessionLocal()\n    a = session.query(OrderAssignment).filter(OrderAssignment.order_id == order_id, OrderAssignment.is_current == 1).first()\n    if a:\n        a.is_current = 0\n        a.unassigned_reason = body.unassigned_reason\n        from datetime import datetime, timezone\n        a.unassigned_at = datetime.now(timezone.utc)\n        session.commit()\n        success = True\n    else:\n        success = False\n    session.close()\n    return UnassignCurrentResponse(success=success)\n\nclass OrderStatusEventCreate(BaseModel):\n    order_id: int = Field(..., description=\"Delivery order ID\", example=101)\n    status: str = Field(..., description=\"Event status; must match schema constraint\", example=\"picked_up\")\n    event_time: str = Field(..., description=\"Event time (ISO8601)\", example=\"2024-06-11T14:18:00-07:00\")\n    eta: Optional[str] = Field(None, description=\"Order's updated ETA (if status is en_route)\", example=\"2024-06-11T14:42:00-07:00\")\n    notes: Optional[str] = Field(None, description=\"Event notes\", example=\"Order verified; 2 bags\")\n\nclass OrderStatusEventCreateResponse(BaseModel):\n    id: int = Field(..., description=\"New status event ID\", example=1)\n\n@app.post(\n    \"/api/order-status-events\",\n    summary=\"Create a status event for order timeline\",\n    description=\"Append a timeline status event for an order, such as picked_up, en_route, delivered, canceled, and notes.\",\n    tags=[\"order_status_events\"],\n    operation_id=\"append_order_status_event\",\n    response_model=OrderStatusEventCreateResponse\n)\nasync def append_order_status_event(body: OrderStatusEventCreate = Body(...)) -> OrderStatusEventCreateResponse:\n    session = SessionLocal()\n    evt = OrderStatusEvent(\n        order_id=body.order_id,\n        status=body.status,\n        event_time=body.event_time,\n        eta=body.eta,\n        notes=body.notes,\n        created_by_user_id=1\n    )\n    session.add(evt)\n    session.commit()\n    session.refresh(evt)\n    id_ = evt.id\n    session.close()\n    return OrderStatusEventCreateResponse(id=id_)\n\nclass PingPayload(BaseModel):\n    ping_time: str = Field(..., description=\"Ping timestamp (ISO8601)\", example=\"2024-06-11T14:20:00-07:00\")\n    lat: float = Field(..., description=\"Latitude\", example=37.7765)\n    lng: float = Field(..., description=\"Longitude\", example=-122.4172)\n    driver_id: Optional[int] = Field(None, description=\"Driver ID for ping (optional)\", example=8)\n\nclass BatchGpsPingsCreate(BaseModel):\n    order_id: int = Field(..., description=\"Order ID\", example=101)\n    pings: List[PingPayload] = Field(..., description=\"List of pings (lat, lng, timestamp, optional driver_id)\", example=[{\"ping_time\":\"2024-06-11T14:20:00-07:00\",\"lat\":37.7765,\"lng\":-122.4172},{\"ping_time\":\"2024-06-11T14:22:00-07:00\",\"lat\":37.7751,\"lng\":-122.4149}])\n\nclass BatchGpsPingsCreateResponse(BaseModel):\n    count: int = Field(..., description=\"How many GPS pings were written\", example=5)\n\n@app.post(\n    \"/api/order-gps-pings/batch\",\n    summary=\"Batch ingest GPS pings for an order\",\n    description=\"Write a batch of GPS pings for an order, generally from a driver app or agent tracking tool.\",\n    tags=[\"order_gps_pings\"],\n    operation_id=\"batch_create_order_gps_pings\",\n    response_model=BatchGpsPingsCreateResponse\n)\nasync def batch_create_order_gps_pings(body: BatchGpsPingsCreate = Body(...)) -> BatchGpsPingsCreateResponse:\n    session = SessionLocal()\n    cnt = 0\n    for ping in body.pings:\n        obj = OrderGpsPing(\n            order_id=body.order_id,\n            driver_id=ping.driver_id,\n            ping_time=ping.ping_time,\n            lat=ping.lat,\n            lng=ping.lng\n        )\n        session.add(obj)\n        cnt += 1\n    session.commit()\n    session.close()\n    return BatchGpsPingsCreateResponse(count=cnt)\n\nclass RecalculateOrderEtaResponse(BaseModel):\n    latest_eta: Optional[str] = Field(None, description=\"Updated ETA ISO8601\", example=\"2024-06-11T14:42:00-07:00\")\n\n@app.post(\n    \"/api/delivery-orders/{order_id}/synth-eta\",\n    summary=\"Recalculate synthesized ETA for an order\",\n    description=\"Re-evaluate or update the synthesized ETA for a delivery order based on latest GPS and timeline data.\",\n    tags=[\"order_gps_pings\", \"delivery_orders\"],\n    operation_id=\"recalculate_order_eta\",\n    response_model=RecalculateOrderEtaResponse\n)\nasync def recalculate_order_eta(\n    order_id: int = Path(..., description=\"Order ID to update ETA for\", example=101)\n) -> RecalculateOrderEtaResponse:\n    session = SessionLocal()\n    last_evt = session.query(OrderStatusEvent).filter(OrderStatusEvent.order_id == order_id, OrderStatusEvent.eta != None).order_by(OrderStatusEvent.event_time.desc()).first()\n    new_eta = last_evt.eta.isoformat() if last_evt and last_evt.eta else None\n    order = session.query(DeliveryOrder).filter(DeliveryOrder.id == order_id).first()\n    if order:\n        order.latest_eta = last_evt.eta if last_evt and last_evt.eta else None\n        session.commit()\n    session.close()\n    return RecalculateOrderEtaResponse(latest_eta=new_eta)\n\nclass ProofOfDeliveryCreate(BaseModel):\n    order_id: int = Field(..., description=\"Order ID\", example=101)\n    photo_url: Optional[str] = Field(None, description=\"Photo URL for POD\", example=\"https://cdn.example.com/pod/bb-10482-1.jpg\")\n    photo_timestamp: Optional[str] = Field(None, description=\"Photo timestamp (ISO8601)\", example=\"2024-06-11T14:46:00-07:00\")\n    photo_notes: Optional[str] = Field(None, description=\"Notes about the POD photo\", example=\"Left at front desk\")\n    recipient_signature_name: Optional[str] = Field(None, description=\"Name of person who signed (if available)\", example=\"A. Patel\")\n\nclass ProofOfDeliveryCreateResponse(BaseModel):\n    id: int = Field(..., description=\"Proof of delivery record ID\", example=22)\n\n@app.post(\n    \"/api/proof-of-delivery\",\n    summary=\"Attach proof of delivery for an order\",\n    description=\"Record POD and attach photo metadata and/or recipient signature for an order.\",\n    tags=[\"proof_of_delivery\"],\n    operation_id=\"attach_proof_of_delivery\",\n    response_model=ProofOfDeliveryCreateResponse\n)\nasync def attach_proof_of_delivery(body: ProofOfDeliveryCreate = Body(...)) -> ProofOfDeliveryCreateResponse:\n    session = SessionLocal()\n    pod = ProofOfDelivery(\n        order_id=body.order_id,\n        photo_url=body.photo_url,\n        photo_timestamp=body.photo_timestamp,\n        photo_notes=body.photo_notes,\n        recipient_signature_name=body.recipient_signature_name\n    )\n    session.add(pod)\n    session.commit()\n    session.refresh(pod)\n    id_ = pod.id\n    session.close()\n    return ProofOfDeliveryCreateResponse(id=id_)\n\nclass RefundCreate(BaseModel):\n    order_id: int = Field(..., description=\"Order to refund\", example=10501)\n    amount_cents: int = Field(..., description=\"Refund amount in cents (e.g., 3860 = $38.60)\", example=3860)\n    currency: Optional[str] = Field(None, description=\"Currency code; default USD\", example=\"USD\")\n    reason: Optional[str] = Field(None, description=\"Reason for refund\", example=\"store_closed\")\n\nclass RefundCreateResponse(BaseModel):\n    id: int = Field(..., description=\"Refund record ID\", example=4)\n\n@app.post(\n    \"/api/refunds\",\n    summary=\"Issue a refund for delivery order\",\n    description=\"Create a refund for an order with amount and reason; used for full/partial refunds.\",\n    tags=[\"refunds\"],\n    operation_id=\"issue_refund_for_order\",\n    response_model=RefundCreateResponse\n)\nasync def issue_refund_for_order(body: RefundCreate = Body(...)) -> RefundCreateResponse:\n    session = SessionLocal()\n    refund = Refund(\n        order_id=body.order_id,\n        amount_cents=body.amount_cents,\n        currency=body.currency if body.currency is not None else \"USD\",\n        reason=body.reason,\n        issued_by_user_id=1\n    )\n    session.add(refund)\n    session.commit()\n    session.refresh(refund)\n    id_ = refund.id\n    session.close()\n    return RefundCreateResponse(id=id_)\n\nclass InternalNoteCreate(BaseModel):\n    entity_type: str = Field(..., description=\"Entity type: order, batch, support_case\", example=\"order\")\n    entity_id: int = Field(..., description=\"ID of order, batch, or case\", example=10501)\n    note: str = Field(..., description=\"Note content\", example=\"Location closed early due to power outage\")\n\nclass InternalNoteCreateResponse(BaseModel):\n    id: int = Field(..., description=\"New note ID\", example=21)\n\n@app.post(\n    \"/api/internal-notes\",\n    summary=\"Add an internal note to an order/batch/case\",\n    description=\"Attach an internal note to an entity (order, batch, support case) with current user as author.\",\n    tags=[\"internal_notes\"],\n    operation_id=\"create_internal_note\",\n    response_model=InternalNoteCreateResponse\n)\nasync def create_internal_note(body: InternalNoteCreate = Body(...)) -> InternalNoteCreateResponse:\n    session = SessionLocal()\n    n = InternalNote(\n        entity_type=body.entity_type,\n        entity_id=body.entity_id,\n        author_user_id=1,\n        note=body.note\n    )\n    session.add(n)\n    session.commit()\n    session.refresh(n)\n    id_ = n.id\n    session.close()\n    return InternalNoteCreateResponse(id=id_)\n\nclass CancelDeliveryOrderRequest(BaseModel):\n    cancel_reason: str = Field(..., description=\"Predefined or freeform cancel reason\", example=\"store_closed\")\n    canceled_at: str = Field(..., description=\"Datetime canceled (ISO8601)\", example=\"2024-06-11T17:12:00-07:00\")\n\nclass CancelDeliveryOrderResponse(BaseModel):\n    success: bool = Field(..., description=\"True if successfully canceled\", example=True)\n\n@app.post(\n    \"/api/delivery-orders/{order_id}/cancel\",\n    summary=\"Cancel a delivery order\",\n    description=\"Set the order status to canceled, specifying cancel reason and time.\",\n    tags=[\"delivery_orders\"],\n    operation_id=\"cancel_delivery_order\",\n    response_model=CancelDeliveryOrderResponse\n)\nasync def cancel_delivery_order(\n    order_id: int = Path(..., description=\"Order to cancel\", example=10501),\n    body: CancelDeliveryOrderRequest = Body(...)\n) -> CancelDeliveryOrderResponse:\n    session = SessionLocal()\n    o = session.query(DeliveryOrder).filter(DeliveryOrder.id == order_id).first()\n    success = False\n    if o:\n        o.current_status = \"canceled\"\n        o.canceled_at = body.canceled_at\n        o.cancel_reason = body.cancel_reason\n        session.commit()\n        success = True\n    session.close()\n    return CancelDeliveryOrderResponse(success=success)\n\nclass SupportCaseCreate(BaseModel):\n    order_id: int = Field(..., description=\"Associated delivery order ID\", example=10490)\n    channel: str = Field(..., description=\"Contact channel (chat, email, phone)\", example=\"chat\")\n    customer_message: str = Field(..., description=\"Message from the customer\", example=\"Driver marked delivered but I didn't receive it at 901 Howard St Apt 12\")\n    priority: str = Field(..., description=\"Case priority (low, medium, high, urgent)\", example=\"high\")\n    resolution_code: Optional[str] = Field(None, description=\"Initial resolution code (if known)\", example=\"not_received\")\n\nclass SupportCaseCreateResponse(BaseModel):\n    id: int = Field(..., description=\"Support case ID\", example=20)\n\n@app.post(\n    \"/api/support-cases\",\n    summary=\"Create a support case for a delivery order\",\n    description=\"Open a support case for a delivery order with all required details and a customer message.\",\n    tags=[\"support_cases\"],\n    operation_id=\"create_support_case\",\n    response_model=SupportCaseCreateResponse\n)\nasync def create_support_case(body: SupportCaseCreate = Body(...)) -> SupportCaseCreateResponse:\n    session = SessionLocal()\n    sc = SupportCase(\n        order_id=body.order_id,\n        channel=body.channel,\n        customer_message=body.customer_message,\n        priority=body.priority,\n        resolution_code=body.resolution_code,\n        created_by_user_id=1,\n        status=\"open\"\n    )\n    session.add(sc)\n    session.commit()\n    session.refresh(sc)\n    id_ = sc.id\n    session.close()\n    return SupportCaseCreateResponse(id=id_)\n\nclass SupportCaseNoteCreate(BaseModel):\n    case_id: int = Field(..., description=\"Support case ID\", example=20)\n    note: str = Field(..., description=\"Note text\", example=\"Check GPS drop point and POD photo; contact driver within 10 minutes\")\n\nclass SupportCaseNoteCreateResponse(BaseModel):\n    id: int = Field(..., description=\"Support case note ID\", example=11)\n\n@app.post(\n    \"/api/support-case-notes\",\n    summary=\"Add note to a support case\",\n    description=\"Append an escalation or internal note to a support case as part of resolution workflow.\",\n    tags=[\"support_cases\", \"support_case_notes\"],\n    operation_id=\"add_support_case_note\",\n    response_model=SupportCaseNoteCreateResponse\n)\nasync def add_support_case_note(body: SupportCaseNoteCreate = Body(...)) -> SupportCaseNoteCreateResponse:\n    session = SessionLocal()\n    n = SupportCaseNote(\n        case_id=body.case_id,\n        author_user_id=1,\n        note=body.note\n    )\n    session.add(n)\n    session.commit()\n    session.refresh(n)\n    id_ = n.id\n    session.close()\n    return SupportCaseNoteCreateResponse(id=id_)\n\nif __name__ == \"__main__\":\n    import uvicorn, os\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
{"scenario": "Samsara (Fleet & Asset Maintenance Management)", "db_path": "./outputs/databases/samsara_fleet_asset_maintenance_management.db", "full_code": "import os\nfrom typing import List, Optional, Dict\nfrom datetime import datetime, date\nfrom fastapi import FastAPI, Body, Path\nfrom pydantic import BaseModel, Field, ConfigDict\nfrom sqlalchemy import (\n    create_engine, Column, Integer, String, Float, Boolean, DateTime, ForeignKey, Text, UniqueConstraint, CheckConstraint\n)\nfrom sqlalchemy.orm import declarative_base, sessionmaker, relationship\n\nDATABASE_PATH = os.getenv(\"DATABASE_PATH\")\nif not DATABASE_PATH:\n    DATABASE_PATH = \"sqlite:///xxxx.db\"\nengine = create_engine(DATABASE_PATH, connect_args={\"check_same_thread\": False})\nSessionLocal = sessionmaker(bind=engine, autoflush=False)\nBase = declarative_base()\n\nclass User(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, unique=True, nullable=False)\n    email = Column(String, unique=True, nullable=False)\n    full_name = Column(String)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass Driver(Base):\n    __tablename__ = \"drivers\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    employee_id = Column(String, nullable=False)\n    full_name = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"employee_id\"),\n    )\n\nclass Vehicle(Base):\n    __tablename__ = \"vehicles\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vin = Column(String, nullable=False)\n    name = Column(String, nullable=False)\n    license_plate = Column(String)\n    odometer_miles = Column(Integer, nullable=False, default=0)\n    engine_hours = Column(Float, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"vin\"),\n        UniqueConstraint(\"user_id\", \"name\"),\n        UniqueConstraint(\"user_id\", \"license_plate\"),\n        CheckConstraint(\"length(vin) BETWEEN 11 AND 17\"),\n        CheckConstraint(\"odometer_miles >= 0\"),\n        CheckConstraint(\"engine_hours >= 0\"),\n    )\n\nclass VehicleDriverAssignment(Base):\n    __tablename__ = \"vehicle_driver_assignments\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    driver_id = Column(Integer, ForeignKey(\"drivers.id\", ondelete=\"CASCADE\"), nullable=False)\n    effective_start_at = Column(String, nullable=False)\n    effective_end_at = Column(String)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"effective_end_at IS NULL OR effective_end_at > effective_start_at\"),\n    )\n\nclass Geofence(Base):\n    __tablename__ = \"geofences\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    type = Column(String, nullable=False)\n    center_lat = Column(Float)\n    center_lng = Column(Float)\n    radius_meters = Column(Float)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"name\"),\n        CheckConstraint(\"type IN ('circle')\"),\n        CheckConstraint(\"center_lat IS NULL OR (center_lat BETWEEN -90 AND 90)\"),\n        CheckConstraint(\"center_lng IS NULL OR (center_lng BETWEEN -180 AND 180)\"),\n        CheckConstraint(\"radius_meters IS NULL OR radius_meters > 0\"),\n    )\n\nclass GeofenceAlertRule(Base):\n    __tablename__ = \"geofence_alert_rules\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    geofence_id = Column(Integer, ForeignKey(\"geofences.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    alert_on_enter = Column(Integer, nullable=False, default=0)\n    alert_on_exit = Column(Integer, nullable=False, default=0)\n    enabled = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"geofence_id\", \"vehicle_id\"),\n        CheckConstraint(\"alert_on_enter IN (0,1)\"),\n        CheckConstraint(\"alert_on_exit IN (0,1)\"),\n        CheckConstraint(\"enabled IN (0,1)\"),\n    )\n\nclass VehicleSafetySetting(Base):\n    __tablename__ = \"vehicle_safety_settings\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    speeding_threshold_mph = Column(Float)\n    speeding_min_duration_seconds = Column(Integer)\n    idling_threshold_minutes = Column(Integer)\n    severity = Column(String, nullable=False)\n    enabled = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"vehicle_id\"),\n        CheckConstraint(\"severity IN ('low','medium','high')\"),\n        CheckConstraint(\"enabled IN (0,1)\"),\n        CheckConstraint(\"speeding_threshold_mph IS NULL OR speeding_threshold_mph >= 0\"),\n        CheckConstraint(\"speeding_min_duration_seconds IS NULL OR speeding_min_duration_seconds >= 0\"),\n        CheckConstraint(\"idling_threshold_minutes IS NULL OR idling_threshold_minutes >= 0\"),\n    )\n\nclass Trip(Base):\n    __tablename__ = \"trips\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    driver_id = Column(Integer, ForeignKey(\"drivers.id\", ondelete=\"SET NULL\"))\n    start_at = Column(String, nullable=False)\n    end_at = Column(String, nullable=False)\n    start_lat = Column(Float)\n    start_lng = Column(Float)\n    end_lat = Column(Float)\n    end_lng = Column(Float)\n    avg_speed_mph = Column(Float)\n    max_speed_mph = Column(Float)\n    speeding_event_count = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"end_at > start_at\"),\n        CheckConstraint(\"start_lat IS NULL OR (start_lat BETWEEN -90 AND 90)\"),\n        CheckConstraint(\"start_lng IS NULL OR (start_lng BETWEEN -180 AND 180)\"),\n        CheckConstraint(\"end_lat IS NULL OR (end_lat BETWEEN -90 AND 90)\"),\n        CheckConstraint(\"end_lng IS NULL OR (end_lng BETWEEN -180 AND 180)\"),\n        CheckConstraint(\"avg_speed_mph IS NULL OR avg_speed_mph >= 0\"),\n        CheckConstraint(\"max_speed_mph IS NULL OR max_speed_mph >= 0\"),\n        CheckConstraint(\"speeding_event_count >= 0\"),\n    )\n\nclass TripGPSPoint(Base):\n    __tablename__ = \"trip_gps_points\"\n    id = Column(Integer, primary_key=True)\n    trip_id = Column(Integer, ForeignKey(\"trips.id\", ondelete=\"CASCADE\"), nullable=False)\n    seq = Column(Integer, nullable=False)\n    recorded_at = Column(String)\n    lat = Column(Float, nullable=False)\n    lng = Column(Float, nullable=False)\n    speed_mph = Column(Float)\n    created_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"trip_id\", \"seq\"),\n        CheckConstraint(\"lat BETWEEN -90 AND 90\"),\n        CheckConstraint(\"lng BETWEEN -180 AND 180\"),\n        CheckConstraint(\"seq >= 0\"),\n        CheckConstraint(\"speed_mph IS NULL OR speed_mph >= 0\"),\n    )\n\nclass SensorReading(Base):\n    __tablename__ = \"sensor_readings\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    recorded_at = Column(String, nullable=False)\n    fuel_level_pct = Column(Float)\n    engine_temp_f = Column(Float)\n    created_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"fuel_level_pct IS NULL OR (fuel_level_pct BETWEEN 0 AND 100)\"),\n    )\n\nclass VehicleAlert(Base):\n    __tablename__ = \"vehicle_alerts\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    trip_id = Column(Integer, ForeignKey(\"trips.id\", ondelete=\"SET NULL\"))\n    type = Column(String, nullable=False)\n    severity = Column(String, nullable=False)\n    start_at = Column(String, nullable=False)\n    end_at = Column(String)\n    message = Column(Text)\n    created_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"type IN ('speeding','idling','engine_temp','geofence_enter','geofence_exit')\"),\n        CheckConstraint(\"severity IN ('low','medium','high')\"),\n        CheckConstraint(\"end_at IS NULL OR end_at > start_at\"),\n    )\n\nclass MaintenanceSchedule(Base):\n    __tablename__ = \"maintenance_schedules\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    interval_miles = Column(Integer)\n    interval_engine_hours = Column(Float)\n    next_due_odometer_miles = Column(Integer)\n    next_due_engine_hours = Column(Float)\n    due_soon_miles = Column(Integer, nullable=False, default=0)\n    due_soon_engine_hours = Column(Float, nullable=False, default=0)\n    enabled = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"interval_miles IS NULL OR interval_miles > 0\"),\n        CheckConstraint(\"interval_engine_hours IS NULL OR interval_engine_hours > 0\"),\n        CheckConstraint(\"next_due_odometer_miles IS NULL OR next_due_odometer_miles >= 0\"),\n        CheckConstraint(\"next_due_engine_hours IS NULL OR next_due_engine_hours >= 0\"),\n        CheckConstraint(\"due_soon_miles >= 0\"),\n        CheckConstraint(\"due_soon_engine_hours >= 0\"),\n        CheckConstraint(\"enabled IN (0,1)\"),\n    )\n\nclass Vendor(Base):\n    __tablename__ = \"vendors\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"name\"),\n    )\n\nclass WorkOrder(Base):\n    __tablename__ = \"work_orders\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    vendor_id = Column(Integer, ForeignKey(\"vendors.id\", ondelete=\"SET NULL\"))\n    title = Column(String, nullable=False)\n    priority = Column(String, nullable=False)\n    reported_issue = Column(String)\n    status = Column(String, nullable=False)\n    open_date = Column(String, nullable=False)\n    close_date = Column(String)\n    odometer_at_repair_miles = Column(Integer)\n    estimated_labor_cost = Column(Float)\n    estimated_parts_cost = Column(Float)\n    actual_labor_cost = Column(Float)\n    actual_parts_cost = Column(Float)\n    notes = Column(Text)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"priority IN ('low','medium','high','urgent')\"),\n        CheckConstraint(\"status IN ('open','closed')\"),\n        CheckConstraint(\"close_date IS NULL OR close_date >= open_date\"),\n        CheckConstraint(\"odometer_at_repair_miles IS NULL OR odometer_at_repair_miles >= 0\"),\n    )\n\nclass WorkOrderLineItem(Base):\n    __tablename__ = \"work_order_line_items\"\n    id = Column(Integer, primary_key=True)\n    work_order_id = Column(Integer, ForeignKey(\"work_orders.id\", ondelete=\"CASCADE\"), nullable=False)\n    description = Column(String, nullable=False)\n    part_number = Column(String)\n    quantity = Column(Float, nullable=False, default=1)\n    unit_cost = Column(Float, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"quantity > 0\"),\n        CheckConstraint(\"unit_cost >= 0\"),\n    )\n\nclass DVIR(Base):\n    __tablename__ = \"dvirs\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    vehicle_id = Column(Integer, ForeignKey(\"vehicles.id\", ondelete=\"CASCADE\"), nullable=False)\n    driver_id = Column(Integer, ForeignKey(\"drivers.id\", ondelete=\"CASCADE\"), nullable=False)\n    dvir_date = Column(String, nullable=False)\n    submitted_at = Column(String, nullable=False)\n    manager_ack_at = Column(String)\n    manager_ack_notes = Column(Text)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"user_id\", \"vehicle_id\", \"driver_id\", \"dvir_date\"),\n    )\n\nclass DVIRDefect(Base):\n    __tablename__ = \"dvir_defects\"\n    id = Column(Integer, primary_key=True)\n    dvir_id = Column(Integer, ForeignKey(\"dvirs.id\", ondelete=\"CASCADE\"), nullable=False)\n    description = Column(String, nullable=False)\n    severity = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"severity IN ('minor','major')\"),\n    )\n\nclass DVIRDefectRepair(Base):\n    __tablename__ = \"dvir_defect_repairs\"\n    id = Column(Integer, primary_key=True)\n    dvir_defect_id = Column(Integer, ForeignKey(\"dvir_defects.id\", ondelete=\"CASCADE\"), nullable=False)\n    vendor_id = Column(Integer, ForeignKey(\"vendors.id\", ondelete=\"SET NULL\"))\n    repaired_at = Column(String)\n    verified_at = Column(String)\n    cost = Column(Float)\n    notes = Column(Text)\n    created_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        CheckConstraint(\"cost IS NULL OR cost >= 0\"),\n    )\n\nBase.metadata.create_all(engine)\n\napp = FastAPI(\n    title=\"Samsara Fleet & Asset Maintenance Management API (Simplified MCP)\",\n    version=\"1.0.0\"\n)\n\nclass VehicleCreateRequest(BaseModel):\n    vin: str = Field(..., description=\"Vehicle Identification Number (11-17 chars)\", example=\"1FTFW1E50JFB12345\")\n    name: str = Field(..., description=\"Human-readable vehicle name\", example=\"Truck-12\")\n    license_plate: Optional[str] = Field(None, description=\"License plate number\", example=\"CA-8XK219\")\n    odometer_miles: Optional[int] = Field(None, description=\"Current odometer in miles\", example=48210)\n    engine_hours: Optional[float] = Field(None, description=\"Current engine hours\", example=2150.0)\n\nclass VehicleResponse(BaseModel):\n    id: int = Field(..., description=\"Unique vehicle identifier\", example=15)\n    vin: str = Field(..., description=\"Vehicle Identification Number\", example=\"1FTFW1E50JFB12345\")\n    name: str = Field(..., description=\"Vehicle name\", example=\"Truck-12\")\n    license_plate: Optional[str] = Field(None, description=\"License plate number\", example=\"CA-8XK219\")\n    odometer_miles: int = Field(..., description=\"Current odometer in miles\", example=48210)\n    engine_hours: float = Field(..., description=\"Current engine hours\", example=2150.0)\n    created_at: str = Field(..., description=\"Creation timestamp\", example=\"2026-02-17T09:13:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass VehiclesListResponse(BaseModel):\n    vehicles: List[VehicleResponse] = Field(..., description=\"List of vehicles\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass DriverResponse(BaseModel):\n    id: int = Field(..., description=\"Driver identifier\", example=4)\n    employee_id: str = Field(..., description=\"Employee unique id\", example=\"D-1042\")\n    full_name: str = Field(..., description=\"Driver full name\", example=\"Maria Lopez\")\n    created_at: str = Field(..., description=\"Created timestamp\", example=\"2026-02-14T17:21:00Z\")\n    updated_at: str = Field(..., description=\"Last updated timestamp\", example=\"2026-02-14T17:21:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass DriversListResponse(BaseModel):\n    drivers: List[DriverResponse] = Field(..., description=\"List of drivers\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass VehicleDriverAssignmentCreateRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Vehicle id to assign the driver to\", example=15)\n    driver_id: int = Field(..., description=\"Driver id to be assigned\", example=4)\n    effective_start_at: str = Field(..., description=\"Assignment effective start (ISO8601)\", example=\"2026-02-18T08:00:00-08:00\")\n    effective_end_at: Optional[str] = Field(None, description=\"Assignment effective end (ISO8601), null for ongoing\", example=None)\n\nclass VehicleDriverAssignmentResponse(BaseModel):\n    id: int = Field(..., description=\"Assignment identifier\", example=2)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    driver_id: int = Field(..., description=\"Driver id\", example=4)\n    effective_start_at: str = Field(..., description=\"Start time (ISO8601)\", example=\"2026-02-18T08:00:00-08:00\")\n    effective_end_at: Optional[str] = Field(None, description=\"End time (ISO8601), null if ongoing\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass VehicleDriverAssignmentsListResponse(BaseModel):\n    assignments: List[VehicleDriverAssignmentResponse] = Field(..., description=\"List of assignments\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass GeofenceCreateRequest(BaseModel):\n    name: str = Field(..., description=\"Geofence name (unique per user)\", example=\"Oakland Yard\")\n    center_lat: float = Field(..., description=\"Latitude of center\", example=37.8044)\n    center_lng: float = Field(..., description=\"Longitude of center\", example=-122.2711)\n    radius_meters: float = Field(..., description=\"Radius in meters\", example=300.0)\n\nclass GeofenceResponse(BaseModel):\n    id: int = Field(..., description=\"Geofence identifier\", example=5)\n    name: str = Field(..., description=\"Geofence name\", example=\"Oakland Yard\")\n    type: str = Field(..., description=\"Type (always 'circle')\", example=\"circle\")\n    center_lat: float = Field(..., description=\"Latitude\", example=37.8044)\n    center_lng: float = Field(..., description=\"Longitude\", example=-122.2711)\n    radius_meters: float = Field(..., description=\"Radius in meters\", example=300.0)\n    created_at: str = Field(..., description=\"Creation timestamp\", example=\"2026-02-17T10:00:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass GeofenceAlertRuleCreateRequest(BaseModel):\n    geofence_id: int = Field(..., description=\"Geofence id\", example=5)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    alert_on_enter: Optional[bool] = Field(None, description=\"Enable enter alert\", example=True)\n    alert_on_exit: Optional[bool] = Field(None, description=\"Enable exit alert\", example=True)\n    enabled: Optional[bool] = Field(None, description=\"Is this alert rule enabled\", example=True)\n\nclass GeofenceAlertRuleResponse(BaseModel):\n    id: int = Field(..., description=\"Geofence alert rule id\", example=12)\n    geofence_id: int = Field(..., description=\"Geofence id\", example=5)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    alert_on_enter: bool = Field(..., description=\"Alert on entering geofence\", example=True)\n    alert_on_exit: bool = Field(..., description=\"Alert on exiting geofence\", example=True)\n    enabled: bool = Field(..., description=\"Current state (enabled/disabled)\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass VehicleSafetySettingsCreateRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    speeding_threshold_mph: Optional[float] = Field(None, description=\"Speed limit to trigger speeding event\", example=70.0)\n    speeding_min_duration_seconds: Optional[int] = Field(None, description=\"Duration speeding must exceed threshold (seconds)\", example=30)\n    idling_threshold_minutes: Optional[int] = Field(None, description=\"Max idling allowed (minutes)\", example=8)\n    severity: str = Field(..., description=\"Severity (low/medium/high)\", example=\"medium\")\n    enabled: Optional[bool] = Field(None, description=\"Settings enabled/disabled\", example=True)\n\nclass VehicleSafetySettingsResponse(BaseModel):\n    id: int = Field(..., description=\"Safety settings id\", example=6)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    speeding_threshold_mph: Optional[float] = Field(None, description=\"Speeding threshold\", example=70.0)\n    speeding_min_duration_seconds: Optional[int] = Field(None, description=\"Duration to trigger (secs)\", example=30)\n    idling_threshold_minutes: Optional[int] = Field(None, description=\"Idling max (minutes)\", example=8)\n    severity: str = Field(..., description=\"Severity\", example=\"medium\")\n    enabled: bool = Field(..., description=\"Enabled\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass TripCreateRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    driver_id: Optional[int] = Field(None, description=\"Driver id (if any)\", example=4)\n    start_at: str = Field(..., description=\"Trip start time (ISO8601)\", example=\"2026-02-17T06:10:00-08:00\")\n    end_at: str = Field(..., description=\"Trip end time (ISO8601), must be > start_at\", example=\"2026-02-17T08:05:00-08:00\")\n    start_lat: Optional[float] = Field(None, description=\"Start latitude\", example=37.3382)\n    start_lng: Optional[float] = Field(None, description=\"Start longitude\", example=-121.8863)\n    end_lat: Optional[float] = Field(None, description=\"End latitude\", example=37.8044)\n    end_lng: Optional[float] = Field(None, description=\"End longitude\", example=-122.2711)\n    avg_speed_mph: Optional[float] = Field(None, description=\"Average speed (mph)\", example=52.0)\n    max_speed_mph: Optional[float] = Field(None, description=\"Maximum speed (mph)\", example=78.0)\n    speeding_event_count: Optional[int] = Field(None, description=\"Number of speeding events during trip\", example=2)\n\nclass TripResponse(BaseModel):\n    id: int = Field(..., description=\"Trip identifier\", example=21)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    driver_id: Optional[int] = Field(None, description=\"Driver id\", example=4)\n    start_at: str = Field(..., description=\"Trip start\", example=\"2026-02-17T06:10:00-08:00\")\n    end_at: str = Field(..., description=\"Trip end\", example=\"2026-02-17T08:05:00-08:00\")\n    start_lat: Optional[float] = Field(None, description=\"Start latitude\", example=37.3382)\n    start_lng: Optional[float] = Field(None, description=\"Start longitude\", example=-121.8863)\n    end_lat: Optional[float] = Field(None, description=\"End latitude\", example=37.8044)\n    end_lng: Optional[float] = Field(None, description=\"End longitude\", example=-122.2711)\n    avg_speed_mph: Optional[float] = Field(None, description=\"Average speed\", example=52.0)\n    max_speed_mph: Optional[float] = Field(None, description=\"Max speed\", example=78.0)\n    speeding_event_count: int = Field(..., description=\"Speeding event count\", example=2)\n    model_config = ConfigDict(from_attributes=True)\n\nclass TripGPSPointItem(BaseModel):\n    seq: int = Field(..., description=\"Sequence index\", example=0)\n    recorded_at: Optional[str] = Field(None, description=\"Recorded timestamp\", example=\"2026-02-17T06:10:00-08:00\")\n    lat: float = Field(..., description=\"Latitude\", example=37.3382)\n    lng: float = Field(..., description=\"Longitude\", example=-121.8863)\n    speed_mph: Optional[float] = Field(None, description=\"Speed at point\", example=0.0)\n\nclass TripGPSPointsBulkRequest(BaseModel):\n    trip_id: int = Field(..., description=\"Trip id\", example=21)\n    points: List[TripGPSPointItem] = Field(..., description=\"Array of GPS points\", example=None)\n\nclass TripGPSPointsBulkResponse(BaseModel):\n    inserted: int = Field(..., description=\"Number of points inserted\", example=18)\n    point_ids: List[int] = Field(..., description=\"Inserted GPS point id\", example=[101])\n    model_config = ConfigDict(from_attributes=True)\n\nclass SensorReadingBulkItem(BaseModel):\n    recorded_at: str = Field(..., description=\"Timestamp\", example=\"2026-02-17T06:10:00-08:00\")\n    fuel_level_pct: Optional[float] = Field(None, description=\"Fuel percent\", example=62.0)\n    engine_temp_f: Optional[float] = Field(None, description=\"Engine temp\", example=188.0)\n\nclass SensorReadingsBulkRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    readings: List[SensorReadingBulkItem] = Field(..., description=\"Readings array\", example=None)\n\nclass SensorReadingsBulkResponse(BaseModel):\n    inserted: int = Field(..., description=\"Number of sensor readings inserted\", example=24)\n    reading_ids: List[int] = Field(..., description=\"Inserted reading id\", example=[301])\n    model_config = ConfigDict(from_attributes=True)\n\nclass VehicleAlertCreateRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    trip_id: Optional[int] = Field(None, description=\"Trip id associated with alert (if any)\", example=21)\n    type: str = Field(..., description=\"Alert type (speeding, idling, engine_temp, geofence_enter, geofence_exit)\", example=\"engine_temp\")\n    severity: str = Field(..., description=\"Alert severity (low, medium, high)\", example=\"medium\")\n    start_at: str = Field(..., description=\"Alert start timestamp (ISO8601)\", example=\"2026-02-17T07:45:00-08:00\")\n    end_at: Optional[str] = Field(None, description=\"Alert end (ISO8601), null if ongoing\", example=\"2026-02-17T07:55:00-08:00\")\n    message: Optional[str] = Field(None, description=\"Detailed alert message/context\", example=\"Engine temp exceeded 210F for 10 minutes\")\n\nclass VehicleAlertResponse(BaseModel):\n    id: int = Field(..., description=\"Alert id\", example=80)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    trip_id: Optional[int] = Field(None, description=\"Trip id\", example=21)\n    type: str = Field(..., description=\"Alert type\", example=\"engine_temp\")\n    severity: str = Field(..., description=\"Alert severity\", example=\"medium\")\n    start_at: str = Field(..., description=\"Alert start\", example=\"2026-02-17T07:45:00-08:00\")\n    end_at: Optional[str] = Field(None, description=\"Alert end\", example=\"2026-02-17T07:55:00-08:00\")\n    message: Optional[str] = Field(None, description=\"Details\", example=\"Engine temp exceeded 210F for 10 minutes\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass MaintenanceScheduleCreateRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    name: str = Field(..., description=\"Schedule name\", example=\"Oil Change\")\n    interval_miles: Optional[int] = Field(None, description=\"Interval in miles between events\", example=7500)\n    interval_engine_hours: Optional[float] = Field(None, description=\"Interval in engine hours between events\", example=250.0)\n    next_due_odometer_miles: Optional[int] = Field(None, description=\"Next due at odometer reading\", example=52500)\n    next_due_engine_hours: Optional[float] = Field(None, description=\"Next due at engine hours\", example=2350.0)\n    due_soon_miles: Optional[int] = Field(None, description=\"Miles before due to trigger notification\", example=500)\n    due_soon_engine_hours: Optional[float] = Field(None, description=\"Engine hours before due to trigger notification\", example=20.0)\n    enabled: Optional[bool] = Field(None, description=\"Is schedule enabled\", example=True)\n\nclass MaintenanceScheduleResponse(BaseModel):\n    id: int = Field(..., description=\"Schedule id\", example=7)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    name: str = Field(..., description=\"Schedule name\", example=\"Oil Change\")\n    interval_miles: Optional[int] = Field(None, description=\"Interval in miles\", example=7500)\n    interval_engine_hours: Optional[float] = Field(None, description=\"Interval in hours\", example=250.0)\n    next_due_odometer_miles: Optional[int] = Field(None, description=\"Next due at miles\", example=52500)\n    next_due_engine_hours: Optional[float] = Field(None, description=\"Next due at engine hours\", example=2350.0)\n    due_soon_miles: int = Field(..., description=\"Due soon miles trigger\", example=500)\n    due_soon_engine_hours: float = Field(..., description=\"Due soon engine hours trigger\", example=20.0)\n    enabled: bool = Field(..., description=\"Schedule enabled\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass VendorCreateRequest(BaseModel):\n    name: str = Field(..., description=\"Vendor name\", example=\"Bay Area Fleet Service\")\n\nclass VendorResponse(BaseModel):\n    id: int = Field(..., description=\"Vendor id\", example=3)\n    name: str = Field(..., description=\"Vendor name\", example=\"Bay Area Fleet Service\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass WorkOrderCreateRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Vehicle id for repair\", example=15)\n    vendor_id: Optional[int] = Field(None, description=\"Assigned vendor id\", example=3)\n    title: str = Field(..., description=\"Work order title\", example=\"Front brake pads replacement\")\n    priority: str = Field(..., description=\"Priority (low, medium, high, urgent)\", example=\"high\")\n    reported_issue: str = Field(..., description=\"Issue reported/diagnosed\", example=\"squealing when braking\")\n    open_date: str = Field(..., description=\"Work order initial open date (YYYY-MM-DD)\", example=\"2026-02-16\")\n    estimated_labor_cost: Optional[float] = Field(None, description=\"Expected labor charge\", example=420.0)\n    estimated_parts_cost: Optional[float] = Field(None, description=\"Estimated parts cost\", example=180.0)\n\nclass WorkOrderResponse(BaseModel):\n    id: int = Field(..., description=\"Work order id\", example=10)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    vendor_id: Optional[int] = Field(None, description=\"Vendor id\", example=3)\n    title: str = Field(..., description=\"Work order title\", example=\"Front brake pads replacement\")\n    priority: str = Field(..., description=\"Priority\", example=\"high\")\n    reported_issue: Optional[str] = Field(None, description=\"Reported issue\", example=\"squealing when braking\")\n    status: str = Field(..., description=\"Work order state ('open')\", example=\"open\")\n    open_date: str = Field(..., description=\"Date opened\", example=\"2026-02-16\")\n    estimated_labor_cost: Optional[float] = Field(None, description=\"Est. labor cost\", example=420.0)\n    estimated_parts_cost: Optional[float] = Field(None, description=\"Est. parts cost\", example=180.0)\n    model_config = ConfigDict(from_attributes=True)\n\nclass WorkOrderLineItemCreateRequest(BaseModel):\n    work_order_id: int = Field(..., description=\"Work order id\", example=10)\n    description: str = Field(..., description=\"Part/service line description\", example=\"Brake pads set\")\n    part_number: Optional[str] = Field(None, description=\"Part number or SKU (if known)\", example=\"BP-4421\")\n    quantity: float = Field(..., description=\"Used quantity\", example=1)\n    unit_cost: float = Field(..., description=\"Unit price for this line item\", example=165.0)\n\nclass WorkOrderLineItemResponse(BaseModel):\n    id: int = Field(..., description=\"Line item id\", example=130)\n    work_order_id: int = Field(..., description=\"Work order id\", example=10)\n    description: str = Field(..., description=\"Description\", example=\"Brake pads set\")\n    part_number: Optional[str] = Field(None, description=\"Part number\", example=\"BP-4421\")\n    quantity: float = Field(..., description=\"Qty used\", example=1)\n    unit_cost: float = Field(..., description=\"Unit cost\", example=165.0)\n    model_config = ConfigDict(from_attributes=True)\n\nclass WorkOrderCloseRequest(BaseModel):\n    status: str = Field(..., description=\"New status ('closed')\", example=\"closed\")\n    actual_labor_cost: Optional[float] = Field(None, description=\"Final labor cost\", example=395.0)\n    odometer_at_repair_miles: Optional[int] = Field(None, description=\"Odometer at completion\", example=49020)\n    close_date: str = Field(..., description=\"Repair completion date\", example=\"2026-02-18\")\n    notes: Optional[str] = Field(None, description=\"Completion notes\", example=\"test drive OK\")\n\nclass WorkOrderCloseResponse(BaseModel):\n    id: int = Field(..., description=\"Work order id\", example=10)\n    status: str = Field(..., description=\"Status after update\", example=\"closed\")\n    actual_labor_cost: Optional[float] = Field(None, description=\"Final labor\", example=395.0)\n    odometer_at_repair_miles: Optional[int] = Field(None, description=\"Odometer\", example=49020)\n    close_date: str = Field(..., description=\"Completion date\", example=\"2026-02-18\")\n    notes: Optional[str] = Field(None, description=\"Notes\", example=\"test drive OK\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass DVIRCreateRequest(BaseModel):\n    vehicle_id: int = Field(..., description=\"Inspected vehicle id\", example=15)\n    driver_id: int = Field(..., description=\"Reporting driver id\", example=4)\n    dvir_date: str = Field(..., description=\"Inspection date (YYYY-MM-DD)\", example=\"2026-02-18\")\n    submitted_at: str = Field(..., description=\"Submission datetime (ISO8601)\", example=\"2026-02-18T09:00:00-08:00\")\n\nclass DVIRResponse(BaseModel):\n    id: int = Field(..., description=\"DVIR id\", example=32)\n    vehicle_id: int = Field(..., description=\"Vehicle id\", example=15)\n    driver_id: int = Field(..., description=\"Driver id\", example=4)\n    dvir_date: str = Field(..., description=\"Inspection date\", example=\"2026-02-18\")\n    submitted_at: str = Field(..., description=\"Submitted at\", example=\"2026-02-18T09:00:00-08:00\")\n    manager_ack_at: Optional[str] = Field(None, description=\"Manager acknowledged at (nullable)\", example=None)\n    manager_ack_notes: Optional[str] = Field(None, description=\"Manager notes (nullable)\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass DVIRDefectCreateRequest(BaseModel):\n    dvir_id: int = Field(..., description=\"DVIR id this defect is linked to\", example=32)\n    description: str = Field(..., description=\"Defect description\", example=\"left headlight out\")\n    severity: str = Field(..., description=\"Defect severity (minor/major)\", example=\"major\")\n\nclass DVIRDefectResponse(BaseModel):\n    id: int = Field(..., description=\"Defect id\", example=212)\n    dvir_id: int = Field(..., description=\"DVIR id\", example=32)\n    description: str = Field(..., description=\"Defect description\", example=\"left headlight out\")\n    severity: str = Field(..., description=\"Severity\", example=\"major\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass DVIRManagerAckRequest(BaseModel):\n    manager_ack_at: str = Field(..., description=\"Acknowledged datetime (ISO8601)\", example=\"2026-02-18T11:00:00-08:00\")\n    manager_ack_notes: str = Field(..., description=\"Notes describing acknowledgment\", example=\"maintenance scheduled\")\n\nclass DVIRManagerAckResponse(BaseModel):\n    id: int = Field(..., description=\"DVIR id\", example=32)\n    manager_ack_at: str = Field(..., description=\"Acknowledged at\", example=\"2026-02-18T11:00:00-08:00\")\n    manager_ack_notes: str = Field(..., description=\"Notes\", example=\"maintenance scheduled\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass DVIRDefectRepairCreateRequest(BaseModel):\n    dvir_defect_id: int = Field(..., description=\"DVIR defect id\", example=212)\n    vendor_id: Optional[int] = Field(None, description=\"Vendor who performed/verified\", example=3)\n    repaired_at: Optional[str] = Field(None, description=\"Repair time (ISO8601, or null if not tracked)\", example=\"2026-02-18T13:00:00-08:00\")\n    verified_at: Optional[str] = Field(None, description=\"When defect was verified as complete\", example=\"2026-02-18T13:15:00-08:00\")\n    cost: Optional[float] = Field(None, description=\"Repair cost\", example=48.0)\n    notes: Optional[str] = Field(None, description=\"Additional notes/detail\", example=\"Headlight replaced by vendor tech.\")\n\nclass DVIRDefectRepairResponse(BaseModel):\n    id: int = Field(..., description=\"Defect repair id\", example=55)\n    dvir_defect_id: int = Field(..., description=\"DVIR defect id\", example=212)\n    vendor_id: Optional[int] = Field(None, description=\"Vendor id\", example=3)\n    repaired_at: Optional[str] = Field(None, description=\"Repair time\", example=\"2026-02-18T13:00:00-08:00\")\n    verified_at: Optional[str] = Field(None, description=\"Verified completion time\", example=\"2026-02-18T13:15:00-08:00\")\n    cost: Optional[float] = Field(None, description=\"Repair cost\", example=48.0)\n    notes: Optional[str] = Field(None, description=\"Notes\", example=\"Headlight replaced by vendor tech.\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/vehicles\",\n    summary=\"Create a new vehicle asset\",\n    description=\"Create a vehicle with VIN, name, license plate, odometer, and engine hours.\",\n    tags=[\"vehicles\"],\n    operation_id=\"create_vehicle\",\n    response_model=VehicleResponse\n)\nasync def create_vehicle(body: VehicleCreateRequest):\n    session = SessionLocal()\n    data = body\n    odometer_miles = data.odometer_miles if data.odometer_miles is not None else 0\n    engine_hours = data.engine_hours if data.engine_hours is not None else 0.0\n    obj = Vehicle(\n        user_id=1,\n        vin=data.vin,\n        name=data.name,\n        license_plate=data.license_plate,\n        odometer_miles=odometer_miles,\n        engine_hours=engine_hours,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = VehicleResponse(\n        id=obj.id,\n        vin=obj.vin,\n        name=obj.name,\n        license_plate=obj.license_plate,\n        odometer_miles=obj.odometer_miles,\n        engine_hours=obj.engine_hours,\n        created_at=obj.created_at.isoformat() + \"Z\"\n    )\n    session.close()\n    return ret\n\n@app.get(\n    \"/api/vehicles\",\n    summary=\"List all vehicles\",\n    description=\"Retrieve all vehicle assets for the current user.\",\n    tags=[\"vehicles\"],\n    operation_id=\"list_vehicles\",\n    response_model=VehiclesListResponse\n)\nasync def list_vehicles():\n    session = SessionLocal()\n    objs = session.query(Vehicle).filter(Vehicle.user_id == 1).all()\n    items = []\n    for obj in objs:\n        items.append(\n            VehicleResponse(\n                id=obj.id,\n                vin=obj.vin,\n                name=obj.name,\n                license_plate=obj.license_plate,\n                odometer_miles=obj.odometer_miles,\n                engine_hours=obj.engine_hours,\n                created_at=obj.created_at.isoformat() + \"Z\"\n            )\n        )\n    session.close()\n    return VehiclesListResponse(vehicles=items)\n\n@app.get(\n    \"/api/vehicles/{vehicle_id}\",\n    summary=\"Get vehicle by ID\",\n    description=\"Retrieve the details of a specific vehicle asset by its ID.\",\n    tags=[\"vehicles\"],\n    operation_id=\"get_vehicle\",\n    response_model=VehicleResponse\n)\nasync def get_vehicle(vehicle_id: int = Path(..., description=\"Unique vehicle identifier\", examples={\"example\": {\"value\": 15}})):\n    session = SessionLocal()\n    obj = session.query(Vehicle).filter(Vehicle.user_id == 1, Vehicle.id == vehicle_id).first()\n    ret = VehicleResponse(\n        id=obj.id,\n        vin=obj.vin,\n        name=obj.name,\n        license_plate=obj.license_plate,\n        odometer_miles=obj.odometer_miles,\n        engine_hours=obj.engine_hours,\n        created_at=obj.created_at.isoformat() + \"Z\"\n    )\n    session.close()\n    return ret\n\n@app.get(\n    \"/api/drivers\",\n    summary=\"List all drivers\",\n    description=\"Retrieve all drivers for the current user.\",\n    tags=[\"drivers\"],\n    operation_id=\"list_drivers\",\n    response_model=DriversListResponse\n)\nasync def list_drivers():\n    session = SessionLocal()\n    objs = session.query(Driver).filter(Driver.user_id == 1).all()\n    items = []\n    for obj in objs:\n        items.append(\n            DriverResponse(\n                id=obj.id,\n                employee_id=obj.employee_id,\n                full_name=obj.full_name,\n                created_at=obj.created_at.isoformat() + \"Z\",\n                updated_at=obj.updated_at.isoformat() + \"Z\"\n            )\n        )\n    session.close()\n    return DriversListResponse(drivers=items)\n\n@app.get(\n    \"/api/drivers/{driver_id}\",\n    summary=\"Get driver by ID\",\n    description=\"Retrieve the details of a driver by driver_id.\",\n    tags=[\"drivers\"],\n    operation_id=\"get_driver\",\n    response_model=DriverResponse\n)\nasync def get_driver(driver_id: int = Path(..., description=\"Driver identifier\", examples={\"example\": {\"value\": 4}})):\n    session = SessionLocal()\n    obj = session.query(Driver).filter(Driver.user_id == 1, Driver.id == driver_id).first()\n    ret = DriverResponse(\n        id=obj.id,\n        employee_id=obj.employee_id,\n        full_name=obj.full_name,\n        created_at=obj.created_at.isoformat() + \"Z\",\n        updated_at=obj.updated_at.isoformat() + \"Z\"\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/vehicle_driver_assignments\",\n    summary=\"Assign a driver to a vehicle\",\n    description=\"Create a driver assignment for a vehicle with effective start and optional end date.\",\n    tags=[\"vehicle_driver_assignments\"],\n    operation_id=\"assign_driver_to_vehicle\",\n    response_model=VehicleDriverAssignmentResponse\n)\nasync def assign_driver_to_vehicle(body: VehicleDriverAssignmentCreateRequest):\n    session = SessionLocal()\n    data = body\n    obj = VehicleDriverAssignment(\n        user_id=1,\n        vehicle_id=data.vehicle_id,\n        driver_id=data.driver_id,\n        effective_start_at=data.effective_start_at,\n        effective_end_at=data.effective_end_at,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = VehicleDriverAssignmentResponse(\n        id=obj.id,\n        vehicle_id=obj.vehicle_id,\n        driver_id=obj.driver_id,\n        effective_start_at=obj.effective_start_at,\n        effective_end_at=obj.effective_end_at\n    )\n    session.close()\n    return ret\n\n@app.get(\n    \"/api/vehicle_driver_assignments\",\n    summary=\"List all vehicle-driver assignments\",\n    description=\"List all driver assignments to vehicles for the current user.\",\n    tags=[\"vehicle_driver_assignments\"],\n    operation_id=\"list_vehicle_driver_assignments\",\n    response_model=VehicleDriverAssignmentsListResponse\n)\nasync def list_vehicle_driver_assignments():\n    session = SessionLocal()\n    objs = session.query(VehicleDriverAssignment).filter(VehicleDriverAssignment.user_id == 1).all()\n    items = []\n    for obj in objs:\n        items.append(\n            VehicleDriverAssignmentResponse(\n                id=obj.id,\n                vehicle_id=obj.vehicle_id,\n                driver_id=obj.driver_id,\n                effective_start_at=obj.effective_start_at,\n                effective_end_at=obj.effective_end_at\n            )\n        )\n    session.close()\n    return VehicleDriverAssignmentsListResponse(assignments=items)\n\n@app.post(\n    \"/api/geofences\",\n    summary=\"Create a new geofence (circular zone)\",\n    description=\"Define a new circular geofence with center, radius, and name.\",\n    tags=[\"geofences\"],\n    operation_id=\"create_geofence_circle\",\n    response_model=GeofenceResponse\n)\nasync def create_geofence_circle(body: GeofenceCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = Geofence(\n        user_id=1,\n        name=body.name,\n        type=\"circle\",\n        center_lat=body.center_lat,\n        center_lng=body.center_lng,\n        radius_meters=body.radius_meters,\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = GeofenceResponse(\n        id=obj.id,\n        name=obj.name,\n        type=obj.type,\n        center_lat=obj.center_lat,\n        center_lng=obj.center_lng,\n        radius_meters=obj.radius_meters,\n        created_at=obj.created_at.isoformat() + \"Z\"\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/geofence_alert_rules\",\n    summary=\"Enable geofence alerts for a vehicle\",\n    description=\"Create a geofence alert rule for a vehicle to alert on enter/exit.\",\n    tags=[\"geofences\", \"geofence_alert_rules\"],\n    operation_id=\"create_geofence_alert_rule\",\n    response_model=GeofenceAlertRuleResponse\n)\nasync def create_geofence_alert_rule(body: GeofenceAlertRuleCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    alert_on_enter = body.alert_on_enter if body.alert_on_enter is not None else True\n    alert_on_exit = body.alert_on_exit if body.alert_on_exit is not None else True\n    enabled = body.enabled if body.enabled is not None else True\n    obj = GeofenceAlertRule(\n        user_id=1,\n        geofence_id=body.geofence_id,\n        vehicle_id=body.vehicle_id,\n        alert_on_enter=int(alert_on_enter),\n        alert_on_exit=int(alert_on_exit),\n        enabled=int(enabled),\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = GeofenceAlertRuleResponse(\n        id=obj.id,\n        geofence_id=obj.geofence_id,\n        vehicle_id=obj.vehicle_id,\n        alert_on_enter=bool(obj.alert_on_enter),\n        alert_on_exit=bool(obj.alert_on_exit),\n        enabled=bool(obj.enabled)\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/vehicle_safety_settings\",\n    summary=\"Create safety settings for a vehicle\",\n    description=\"Set speeding threshold, duration, idling limit, and alert severity for a vehicle.\",\n    tags=[\"vehicle_safety_settings\", \"vehicles\"],\n    operation_id=\"create_vehicle_safety_settings\",\n    response_model=VehicleSafetySettingsResponse\n)\nasync def create_vehicle_safety_settings(body: VehicleSafetySettingsCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    enabled = body.enabled if body.enabled is not None else True\n    obj = VehicleSafetySetting(\n        user_id=1,\n        vehicle_id=body.vehicle_id,\n        speeding_threshold_mph=body.speeding_threshold_mph,\n        speeding_min_duration_seconds=body.speeding_min_duration_seconds,\n        idling_threshold_minutes=body.idling_threshold_minutes,\n        severity=body.severity,\n        enabled=int(enabled),\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = VehicleSafetySettingsResponse(\n        id=obj.id,\n        vehicle_id=obj.vehicle_id,\n        speeding_threshold_mph=obj.speeding_threshold_mph,\n        speeding_min_duration_seconds=obj.speeding_min_duration_seconds,\n        idling_threshold_minutes=obj.idling_threshold_minutes,\n        severity=obj.severity,\n        enabled=bool(obj.enabled)\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/trips\",\n    summary=\"Create a new trip for a vehicle\",\n    description=\"Record a completed trip for a vehicle including driver, times, locations, events, and speeds.\",\n    tags=[\"trips\"],\n    operation_id=\"create_trip\",\n    response_model=TripResponse\n)\nasync def create_trip(body: TripCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    count = body.speeding_event_count if body.speeding_event_count is not None else 0\n    obj = Trip(\n        user_id=1,\n        vehicle_id=body.vehicle_id,\n        driver_id=body.driver_id,\n        start_at=body.start_at,\n        end_at=body.end_at,\n        start_lat=body.start_lat,\n        start_lng=body.start_lng,\n        end_lat=body.end_lat,\n        end_lng=body.end_lng,\n        avg_speed_mph=body.avg_speed_mph,\n        max_speed_mph=body.max_speed_mph,\n        speeding_event_count=count,\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = TripResponse(\n        id=obj.id,\n        vehicle_id=obj.vehicle_id,\n        driver_id=obj.driver_id,\n        start_at=obj.start_at,\n        end_at=obj.end_at,\n        start_lat=obj.start_lat,\n        start_lng=obj.start_lng,\n        end_lat=obj.end_lat,\n        end_lng=obj.end_lng,\n        avg_speed_mph=obj.avg_speed_mph,\n        max_speed_mph=obj.max_speed_mph,\n        speeding_event_count=obj.speeding_event_count\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/trip_gps_points/bulk\",\n    summary=\"Bulk insert trip GPS trace points\",\n    description=\"Insert array of GPS trace points for a trip, typically after creating trip record.\",\n    tags=[\"trip_gps_points\", \"trips\"],\n    operation_id=\"bulk_insert_gps_points\",\n    response_model=TripGPSPointsBulkResponse\n)\nasync def bulk_insert_gps_points(body: TripGPSPointsBulkRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    point_ids = []\n    for p in body.points:\n        obj = TripGPSPoint(\n            trip_id=body.trip_id,\n            seq=p.seq,\n            recorded_at=p.recorded_at,\n            lat=p.lat,\n            lng=p.lng,\n            speed_mph=p.speed_mph,\n            created_at=now\n        )\n        session.add(obj)\n        session.flush()\n        point_ids.append(obj.id)\n    session.commit()\n    session.close()\n    return TripGPSPointsBulkResponse(\n        inserted=len(point_ids),\n        point_ids=point_ids\n    )\n\n@app.post(\n    \"/api/sensor_readings/bulk\",\n    summary=\"Bulk add sensor readings for a vehicle\",\n    description=\"Insert multiple time-series sensor readings for a vehicle including fuel and engine temp.\",\n    tags=[\"sensor_readings\", \"vehicles\"],\n    operation_id=\"bulk_insert_sensor_readings\",\n    response_model=SensorReadingsBulkResponse\n)\nasync def bulk_insert_sensor_readings(body: SensorReadingsBulkRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    reading_ids = []\n    for rd in body.readings:\n        obj = SensorReading(\n            user_id=1,\n            vehicle_id=body.vehicle_id,\n            recorded_at=rd.recorded_at,\n            fuel_level_pct=rd.fuel_level_pct,\n            engine_temp_f=rd.engine_temp_f,\n            created_at=now\n        )\n        session.add(obj)\n        session.flush()\n        reading_ids.append(obj.id)\n    session.commit()\n    session.close()\n    return SensorReadingsBulkResponse(\n        inserted=len(reading_ids),\n        reading_ids=reading_ids\n    )\n\n@app.post(\n    \"/api/vehicle_alerts\",\n    summary=\"Create a vehicle alert\",\n    description=\"Log an alert event for a vehicle (e.g. engine temp exceeded or speeding detected).\",\n    tags=[\"vehicle_alerts\", \"vehicles\"],\n    operation_id=\"create_vehicle_alert\",\n    response_model=VehicleAlertResponse\n)\nasync def create_vehicle_alert(body: VehicleAlertCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = VehicleAlert(\n        user_id=1,\n        vehicle_id=body.vehicle_id,\n        trip_id=body.trip_id,\n        type=body.type,\n        severity=body.severity,\n        start_at=body.start_at,\n        end_at=body.end_at,\n        message=body.message,\n        created_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = VehicleAlertResponse(\n        id=obj.id,\n        vehicle_id=obj.vehicle_id,\n        trip_id=obj.trip_id,\n        type=obj.type,\n        severity=obj.severity,\n        start_at=obj.start_at,\n        end_at=obj.end_at,\n        message=obj.message\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/maintenance_schedules\",\n    summary=\"Create a preventive maintenance schedule\",\n    description=\"Define a recurring maintenance schedule for a vehicle by name, intervals, and due triggers.\",\n    tags=[\"maintenance_schedules\", \"vehicles\"],\n    operation_id=\"create_maintenance_schedule\",\n    response_model=MaintenanceScheduleResponse\n)\nasync def create_maintenance_schedule(body: MaintenanceScheduleCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = MaintenanceSchedule(\n        user_id=1,\n        vehicle_id=body.vehicle_id,\n        name=body.name,\n        interval_miles=body.interval_miles,\n        interval_engine_hours=body.interval_engine_hours,\n        next_due_odometer_miles=body.next_due_odometer_miles,\n        next_due_engine_hours=body.next_due_engine_hours,\n        due_soon_miles=body.due_soon_miles if body.due_soon_miles is not None else 0,\n        due_soon_engine_hours=body.due_soon_engine_hours if body.due_soon_engine_hours is not None else 0.0,\n        enabled=int(body.enabled) if body.enabled is not None else 1,\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = MaintenanceScheduleResponse(\n        id=obj.id,\n        vehicle_id=obj.vehicle_id,\n        name=obj.name,\n        interval_miles=obj.interval_miles,\n        interval_engine_hours=obj.interval_engine_hours,\n        next_due_odometer_miles=obj.next_due_odometer_miles,\n        next_due_engine_hours=obj.next_due_engine_hours,\n        due_soon_miles=obj.due_soon_miles,\n        due_soon_engine_hours=obj.due_soon_engine_hours,\n        enabled=bool(obj.enabled)\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/vendors\",\n    summary=\"Create a new vendor\",\n    description=\"Add a new vendor to be used in work orders or defect repairs.\",\n    tags=[\"vendors\"],\n    operation_id=\"create_vendor\",\n    response_model=VendorResponse\n)\nasync def create_vendor(body: VendorCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = Vendor(\n        user_id=1,\n        name=body.name,\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = VendorResponse(\n        id=obj.id,\n        name=obj.name\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/work_orders\",\n    summary=\"Create a work order for a vehicle\",\n    description=\"Open a work order with title, issue, priority, vendor, estimate, and dates.\",\n    tags=[\"work_orders\", \"vehicles\"],\n    operation_id=\"create_work_order\",\n    response_model=WorkOrderResponse\n)\nasync def create_work_order(body: WorkOrderCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = WorkOrder(\n        user_id=1,\n        vehicle_id=body.vehicle_id,\n        vendor_id=body.vendor_id,\n        title=body.title,\n        priority=body.priority,\n        reported_issue=body.reported_issue,\n        status=\"open\",\n        open_date=body.open_date,\n        estimated_labor_cost=body.estimated_labor_cost,\n        estimated_parts_cost=body.estimated_parts_cost,\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = WorkOrderResponse(\n        id=obj.id,\n        vehicle_id=obj.vehicle_id,\n        vendor_id=obj.vendor_id,\n        title=obj.title,\n        priority=obj.priority,\n        reported_issue=obj.reported_issue,\n        status=obj.status,\n        open_date=obj.open_date,\n        estimated_labor_cost=obj.estimated_labor_cost,\n        estimated_parts_cost=obj.estimated_parts_cost\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/work_order_line_items\",\n    summary=\"Add a line item to a work order\",\n    description=\"Add a part or service line (with qty & cost) to the work order.\",\n    tags=[\"work_order_line_items\", \"work_orders\"],\n    operation_id=\"add_work_order_line_item\",\n    response_model=WorkOrderLineItemResponse\n)\nasync def add_work_order_line_item(body: WorkOrderLineItemCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = WorkOrderLineItem(\n        work_order_id=body.work_order_id,\n        description=body.description,\n        part_number=body.part_number,\n        quantity=body.quantity,\n        unit_cost=body.unit_cost,\n        created_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = WorkOrderLineItemResponse(\n        id=obj.id,\n        work_order_id=obj.work_order_id,\n        description=obj.description,\n        part_number=obj.part_number,\n        quantity=obj.quantity,\n        unit_cost=obj.unit_cost\n    )\n    session.close()\n    return ret\n\n@app.patch(\n    \"/api/work_orders/{work_order_id}\",\n    summary=\"Update and close work order\",\n    description=\"Set work order status to closed with actual labor/parts costs, odometer, date, and notes.\",\n    tags=[\"work_orders\"],\n    operation_id=\"close_work_order\",\n    response_model=WorkOrderCloseResponse\n)\nasync def close_work_order(\n    work_order_id: int = Path(..., description=\"Work order to close\", examples={\"example\": {\"value\": 10}}),\n    body: WorkOrderCloseRequest = Body(...)\n):\n    session = SessionLocal()\n    obj = session.query(WorkOrder).filter(WorkOrder.user_id == 1, WorkOrder.id == work_order_id).first()\n    obj.status = body.status\n    obj.actual_labor_cost = body.actual_labor_cost\n    obj.odometer_at_repair_miles = body.odometer_at_repair_miles\n    obj.close_date = body.close_date\n    obj.notes = body.notes\n    obj.updated_at = datetime.utcnow()\n    session.commit()\n    ret = WorkOrderCloseResponse(\n        id=obj.id,\n        status=obj.status,\n        actual_labor_cost=obj.actual_labor_cost,\n        odometer_at_repair_miles=obj.odometer_at_repair_miles,\n        close_date=obj.close_date,\n        notes=obj.notes\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/dvirs\",\n    summary=\"Submit a DVIR for a vehicle and driver\",\n    description=\"Submit a new Driver Vehicle Inspection Report (DVIR) for a date, vehicle, and driver.\",\n    tags=[\"dvirs\", \"vehicles\", \"drivers\"],\n    operation_id=\"create_dvir\",\n    response_model=DVIRResponse\n)\nasync def create_dvir(body: DVIRCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = DVIR(\n        user_id=1,\n        vehicle_id=body.vehicle_id,\n        driver_id=body.driver_id,\n        dvir_date=body.dvir_date,\n        submitted_at=body.submitted_at,\n        created_at=now,\n        updated_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = DVIRResponse(\n        id=obj.id,\n        vehicle_id=obj.vehicle_id,\n        driver_id=obj.driver_id,\n        dvir_date=obj.dvir_date,\n        submitted_at=obj.submitted_at,\n        manager_ack_at=obj.manager_ack_at,\n        manager_ack_notes=obj.manager_ack_notes\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/dvir_defects\",\n    summary=\"Add a defect to a DVIR\",\n    description=\"Add a noted defect to a specific DVIR with severity.\",\n    tags=[\"dvir_defects\", \"dvirs\"],\n    operation_id=\"add_dvir_defect\",\n    response_model=DVIRDefectResponse\n)\nasync def add_dvir_defect(body: DVIRDefectCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = DVIRDefect(\n        dvir_id=body.dvir_id,\n        description=body.description,\n        severity=body.severity,\n        created_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = DVIRDefectResponse(\n        id=obj.id,\n        dvir_id=obj.dvir_id,\n        description=obj.description,\n        severity=obj.severity\n    )\n    session.close()\n    return ret\n\n@app.patch(\n    \"/api/dvirs/{dvir_id}/manager_ack\",\n    summary=\"Acknowledge a DVIR (manager notes)\",\n    description=\"Add manager acknowledgment to a DVIR with timestamp and notes.\",\n    tags=[\"dvirs\"],\n    operation_id=\"manager_ack_dvir\",\n    response_model=DVIRManagerAckResponse\n)\nasync def manager_ack_dvir(\n    dvir_id: int = Path(..., description=\"DVIR id to acknowledge\", examples={\"example\": {\"value\": 32}}),\n    body: DVIRManagerAckRequest = Body(...)\n):\n    session = SessionLocal()\n    obj = session.query(DVIR).filter(DVIR.user_id == 1, DVIR.id == dvir_id).first()\n    obj.manager_ack_at = body.manager_ack_at\n    obj.manager_ack_notes = body.manager_ack_notes\n    obj.updated_at = datetime.utcnow()\n    session.commit()\n    ret = DVIRManagerAckResponse(\n        id=obj.id,\n        manager_ack_at=obj.manager_ack_at,\n        manager_ack_notes=obj.manager_ack_notes\n    )\n    session.close()\n    return ret\n\n@app.post(\n    \"/api/dvir_defect_repairs\",\n    summary=\"Log DVIR defect repair and verification\",\n    description=\"Record repair for a DVIR defect with vendor, repair/verification timestamps, cost, and notes.\",\n    tags=[\"dvir_defect_repairs\", \"dvir_defects\"],\n    operation_id=\"add_dvir_defect_repair\",\n    response_model=DVIRDefectRepairResponse\n)\nasync def add_dvir_defect_repair(body: DVIRDefectRepairCreateRequest):\n    session = SessionLocal()\n    now = datetime.utcnow()\n    obj = DVIRDefectRepair(\n        dvir_defect_id=body.dvir_defect_id,\n        vendor_id=body.vendor_id,\n        repaired_at=body.repaired_at,\n        verified_at=body.verified_at,\n        cost=body.cost,\n        notes=body.notes,\n        created_at=now\n    )\n    session.add(obj)\n    session.commit()\n    session.refresh(obj)\n    ret = DVIRDefectRepairResponse(\n        id=obj.id,\n        dvir_defect_id=obj.dvir_defect_id,\n        vendor_id=obj.vendor_id,\n        repaired_at=obj.repaired_at,\n        verified_at=obj.verified_at,\n        cost=obj.cost,\n        notes=obj.notes\n    )\n    session.close()\n    return ret\n\nif __name__ == \"__main__\":\n    import uvicorn\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
{"scenario": "Fortnite Item Shop", "db_path": "./outputs/databases/fortnite_item_shop.db", "full_code": "import os\nfrom datetime import datetime, timedelta, timezone\nfrom typing import List, Optional, Dict\n\nfrom fastapi import FastAPI, Query, Body\nfrom pydantic import BaseModel, Field, ConfigDict\n\nfrom sqlalchemy import (\n    Column, Integer, String, DateTime, Boolean, ForeignKey, Text, UniqueConstraint, Float, CheckConstraint, Table, create_engine, func, Index\n)\nfrom sqlalchemy.orm import declarative_base, relationship, sessionmaker, Session\n\nDATABASE_PATH = os.getenv(\"DATABASE_PATH\", \"sqlite:///xxxx.db\")\nengine = create_engine(DATABASE_PATH, future=True)\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\nBase = declarative_base()\n\nclass User(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, nullable=False, unique=True)\n    email = Column(String, nullable=False, unique=True)\n    profile_json = Column(Text)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Friend(Base):\n    __tablename__ = \"friends\"\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), primary_key=True)\n    friend_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), primary_key=True)\n    status = Column(String, nullable=False, default=\"accepted\")\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Region(Base):\n    __tablename__ = \"regions\"\n    id = Column(Integer, primary_key=True)\n    code = Column(String, nullable=False, unique=True)\n    name = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Item(Base):\n    __tablename__ = \"items\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, nullable=False, unique=True)\n    category = Column(String, nullable=False)\n    rarity = Column(String, nullable=False)\n    description = Column(Text)\n    set_name = Column(String)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass ItemVariant(Base):\n    __tablename__ = \"item_variants\"\n    id = Column(Integer, primary_key=True)\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"CASCADE\"), nullable=False)\n    variant_name = Column(String, nullable=False)\n    variant_type = Column(String)\n    sort_order = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass ItemImage(Base):\n    __tablename__ = \"item_images\"\n    id = Column(Integer, primary_key=True)\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"CASCADE\"), nullable=False)\n    image_type = Column(String, nullable=False)\n    url = Column(String, nullable=False)\n    width = Column(Integer)\n    height = Column(Integer)\n    sort_order = Column(Integer, nullable=False, default=0)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Bundle(Base):\n    __tablename__ = \"bundles\"\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"CASCADE\"), primary_key=True)\n\nclass BundleItem(Base):\n    __tablename__ = \"bundle_items\"\n    bundle_item_id = Column(Integer, ForeignKey(\"bundles.item_id\", ondelete=\"CASCADE\"), primary_key=True)\n    child_item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"RESTRICT\"), primary_key=True)\n    quantity = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nclass ShopOffer(Base):\n    __tablename__ = \"shop_offers\"\n    id = Column(Integer, primary_key=True)\n    region_id = Column(Integer, ForeignKey(\"regions.id\", ondelete=\"RESTRICT\"), nullable=False)\n    offered_item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"RESTRICT\"), nullable=False)\n    title_override = Column(String)\n    price_vbucks = Column(Integer, nullable=False)\n    starts_at = Column(DateTime, nullable=False)\n    ends_at = Column(DateTime, nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Wishlist(Base):\n    __tablename__ = \"wishlists\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, unique=True)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass WishlistItem(Base):\n    __tablename__ = \"wishlist_items\"\n    id = Column(Integer, primary_key=True)\n    wishlist_id = Column(Integer, ForeignKey(\"wishlists.id\", ondelete=\"CASCADE\"), nullable=False)\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"CASCADE\"), nullable=False)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nclass PriceAlertRule(Base):\n    __tablename__ = \"price_alert_rules\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"CASCADE\"), nullable=False)\n    region_id = Column(Integer, ForeignKey(\"regions.id\", ondelete=\"RESTRICT\"), nullable=False)\n    max_price_vbucks = Column(Integer, nullable=False)\n    is_active = Column(Boolean, nullable=False, default=True)\n    last_triggered_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Wallet(Base):\n    __tablename__ = \"wallets\"\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), primary_key=True)\n    balance_vbucks = Column(Integer, nullable=False, default=0)\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass WalletLedger(Base):\n    __tablename__ = \"wallet_ledger\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    entry_type = Column(String, nullable=False)\n    amount_vbucks = Column(Integer, nullable=False)\n    balance_after_vbucks = Column(Integer, nullable=False)\n    reference_type = Column(String)\n    reference_id = Column(Integer)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nclass ParentalControl(Base):\n    __tablename__ = \"parental_controls\"\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), primary_key=True)\n    spend_limit_vbucks = Column(Integer, nullable=False, default=0)\n    spend_remaining_vbucks = Column(Integer, nullable=False, default=0)\n    period = Column(String, nullable=False, default=\"unknown\")\n    resets_at = Column(DateTime)\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass Entitlement(Base):\n    __tablename__ = \"entitlements\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"RESTRICT\"), nullable=False)\n    source_type = Column(String, nullable=False)\n    source_id = Column(Integer, nullable=False)\n    acquired_at = Column(DateTime, nullable=False, default=func.now())\n    revoked_at = Column(DateTime)\n\nclass PurchaseReceipt(Base):\n    __tablename__ = \"purchase_receipts\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    offer_id = Column(Integer, ForeignKey(\"shop_offers.id\", ondelete=\"RESTRICT\"), nullable=False)\n    region_id = Column(Integer, ForeignKey(\"regions.id\", ondelete=\"RESTRICT\"), nullable=False)\n    total_charged_vbucks = Column(Integer, nullable=False)\n    purchased_at = Column(DateTime, nullable=False, default=func.now())\n    status = Column(String, nullable=False, default=\"completed\")\n    failure_code = Column(String)\n    failure_message = Column(String)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass PurchaseReceiptItem(Base):\n    __tablename__ = \"purchase_receipt_items\"\n    id = Column(Integer, primary_key=True)\n    receipt_id = Column(Integer, ForeignKey(\"purchase_receipts.id\", ondelete=\"CASCADE\"), nullable=False)\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"RESTRICT\"), nullable=False)\n    quantity = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nclass GiftTransaction(Base):\n    __tablename__ = \"gift_transactions\"\n    id = Column(Integer, primary_key=True)\n    sender_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    recipient_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"RESTRICT\"), nullable=False)\n    offer_id = Column(Integer, ForeignKey(\"shop_offers.id\", ondelete=\"RESTRICT\"), nullable=False)\n    region_id = Column(Integer, ForeignKey(\"regions.id\", ondelete=\"RESTRICT\"), nullable=False)\n    message = Column(Text)\n    total_charged_vbucks = Column(Integer, nullable=False)\n    status = Column(String, nullable=False, default='pending')\n    created_at = Column(DateTime, nullable=False, default=func.now())\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass GiftTransactionItem(Base):\n    __tablename__ = \"gift_transaction_items\"\n    id = Column(Integer, primary_key=True)\n    gift_transaction_id = Column(Integer, ForeignKey(\"gift_transactions.id\", ondelete=\"CASCADE\"), nullable=False)\n    item_id = Column(Integer, ForeignKey(\"items.id\", ondelete=\"RESTRICT\"), nullable=False)\n    quantity = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nclass RefundToken(Base):\n    __tablename__ = \"refund_tokens\"\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), primary_key=True)\n    tokens_remaining = Column(Integer, nullable=False, default=0)\n    updated_at = Column(DateTime, nullable=False, default=func.now())\n\nclass RefundTransaction(Base):\n    __tablename__ = \"refund_transactions\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    purchase_receipt_id = Column(Integer, ForeignKey(\"purchase_receipts.id\", ondelete=\"RESTRICT\"), nullable=False)\n    token_used = Column(Boolean, nullable=False, default=True)\n    vbucks_restored = Column(Integer, nullable=False)\n    status = Column(String, nullable=False, default=\"completed\")\n    failure_code = Column(String)\n    failure_message = Column(String)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nclass RefundTransactionEntitlement(Base):\n    __tablename__ = \"refund_transaction_entitlements\"\n    refund_transaction_id = Column(Integer, ForeignKey(\"refund_transactions.id\", ondelete=\"CASCADE\"), primary_key=True)\n    entitlement_id = Column(Integer, ForeignKey(\"entitlements.id\", ondelete=\"RESTRICT\"), primary_key=True)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nclass ComplianceError(Base):\n    __tablename__ = \"compliance_errors\"\n    id = Column(Integer, primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    action_type = Column(String, nullable=False)\n    offer_id = Column(Integer, ForeignKey(\"shop_offers.id\", ondelete=\"SET NULL\"))\n    attempted_total_vbucks = Column(Integer)\n    rule_code = Column(String, nullable=False)\n    rule_description = Column(String, nullable=False)\n    context_json = Column(Text)\n    created_at = Column(DateTime, nullable=False, default=func.now())\n\nBase.metadata.create_all(engine)\n\napp = FastAPI(title=\"Fortnite Item Shop API\", version=\"1.0\")\n\nclass _ShopOfferActiveOfferItem(BaseModel):\n    offer_id: int = Field(..., description=\"shop_offers.id\", example=101)\n    name: str = Field(..., description=\"items.name or bundle name\", example=\"Galaxy Scout\")\n    rarity: str = Field(..., description=\"items.rarity\", example=\"Epic\")\n    category: str = Field(..., description=\"items.category\", example=\"Outfit\")\n    price_vbucks: int = Field(..., description=\"shop_offers.price_vbucks\", example=1200)\n    time_remaining_seconds: int = Field(..., description=\"Seconds till shop_offers.ends_at\", example=3600)\n    model_config = ConfigDict(from_attributes=True)\n\nclass ShopOffersActiveResponse(BaseModel):\n    offers: List[_ShopOfferActiveOfferItem] = Field(..., description=\"List of shop offers\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass _ShopOffersFilterItem(BaseModel):\n    offer_id: int = Field(..., description=\"shop_offers.id\", example=113)\n    name: str = Field(..., description=\"items.name\", example=\"Shadow Ops\")\n    price_vbucks: int = Field(..., description=\"shop_offers.price_vbucks\", example=800)\n    model_config = ConfigDict(from_attributes=True)\n\nclass ShopOffersFilterResponse(BaseModel):\n    offers: List[_ShopOffersFilterItem] = Field(..., description=\"Filtered shop offers\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass ShopOffersOfferByNameResponse(BaseModel):\n    offer_id: Optional[int] = Field(None, description=\"Shop offer id for named item/bundle, or null if not found\", example=109)\n    price_vbucks: Optional[int] = Field(None, description=\"shop_offers.price_vbucks\", example=500)\n    model_config = ConfigDict(from_attributes=True)\n\nclass _ItemPreviewVariant(BaseModel):\n    variant_name: str = Field(..., description=\"item_variants.variant_name\", example=\"Red Glow\")\n    variant_type: Optional[str] = Field(None, description=\"item_variants.variant_type\", example=\"Style\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass _ItemPreviewImage(BaseModel):\n    image_type: str = Field(..., description=\"item_images.image_type\", example=\"icon\")\n    url: str = Field(..., description=\"item_images.url\", example=\"https://cdn.fortnite.com/crimson_strike_icon.png\")\n    width: Optional[int] = Field(None, description=\"item_images.width\", example=512)\n    height: Optional[int] = Field(None, description=\"item_images.height\", example=512)\n    model_config = ConfigDict(from_attributes=True)\n\nclass _ItemPreviewItem(BaseModel):\n    id: int = Field(..., description=\"items.id\", example=208)\n    name: str = Field(..., description=\"items.name\", example=\"Crimson Strike\")\n    description: Optional[str] = Field(None, description=\"items.description\", example=\"A bold crimson streak!\")\n    rarity: str = Field(..., description=\"items.rarity\", example=\"Rare\")\n    set_name: Optional[str] = Field(None, description=\"items.set_name\", example=\"Strike Set\")\n    included_variants: List[_ItemPreviewVariant] = Field(..., description=\"All variants\", example=None)\n    image_urls: List[_ItemPreviewImage] = Field(..., description=\"Images\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass ItemsPreviewMetadataResponse(BaseModel):\n    item: _ItemPreviewItem = Field(..., description=\"Complete item preview\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass PurchasesRequest(BaseModel):\n    offer_id: int = Field(..., description=\"shop_offers.id to purchase\", example=121)\n    model_config = ConfigDict(from_attributes=True)\n\nclass _EntitlementInfo(BaseModel):\n    entitlement_id: int = Field(..., description=\"entitlements.id\", example=3012)\n    item_id: int = Field(..., description=\"items.id\", example=211)\n    item_name: str = Field(..., description=\"items.name\", example=\"Nebula Wrap\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass PurchasesResponse(BaseModel):\n    receipt_id: int = Field(..., description=\"purchase_receipts.id\", example=501)\n    total_charged_vbucks: int = Field(..., description=\"Total deducted V-Bucks\", example=500)\n    wallet_balance_vbucks: int = Field(..., description=\"Wallet balance after purchase\", example=1250)\n    entitlements: List[_EntitlementInfo] = Field(..., description=\"New entitlements\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass GiftsRequest(BaseModel):\n    offer_id: int = Field(..., description=\"shop_offers.id of the item to gift\", example=130)\n    friend_username: str = Field(..., description=\"Recipient friend's username\", example=\"PlayerTwo42\")\n    message: Optional[str] = Field(None, description=\"Gift message, optional\", example=\"Happy drops! Enjoy this emote.\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass GiftsResponse(BaseModel):\n    gift_transaction_id: int = Field(..., description=\"gift_transactions.id\", example=520)\n    delivery_status: str = Field(..., description=\"gift_transactions.status\", example=\"delivered\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass WishlistsItemsRequest(BaseModel):\n    item_names: List[str] = Field(..., description=\"Names of the items to add to wishlist\", example=[\"Galaxy Scout\", \"Star Wand\"])\n    model_config = ConfigDict(from_attributes=True)\n\nclass _WishlistItemInfo(BaseModel):\n    item_id: int = Field(..., description=\"items.id on wishlist\", example=210)\n    item_name: str = Field(..., description=\"items.name\", example=\"Galaxy Scout\")\n    is_in_shop: bool = Field(..., description=\"True if item is currently in NA-East shop_offers\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass WishlistsItemsResponse(BaseModel):\n    wishlist_items: List[_WishlistItemInfo] = Field(..., description=\"Wishlist Items\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass CompliancePurchaseCheckRequest(BaseModel):\n    offer_id: int = Field(..., description=\"shop_offers.id of offer to check\", example=140)\n    model_config = ConfigDict(from_attributes=True)\n\nclass _ComplianceErrorDetails(BaseModel):\n    rule_code: str = Field(..., description=\"Rule code that blocked\", example=\"SPEND_LIMIT_EXCEEDED\")\n    rule_description: str = Field(..., description=\"Human readable description\", example=\"Spending limit exceeded by 100 V-Bucks\")\n    context_json: str = Field(..., description=\"More context about the compliance error\", example='{\"spend_remaining_vbucks\":500,\"bundle_cost_vbucks\":600}')\n    model_config = ConfigDict(from_attributes=True)\n\nclass CompliancePurchaseCheckResponse(BaseModel):\n    blocked: bool = Field(..., description=\"True if purchase is blocked\", example=True)\n    error_details: Optional[_ComplianceErrorDetails] = Field(None, description=\"Error details if blocked\", example=None)\n    model_config = ConfigDict(from_attributes=True)\n\nclass RefundsRecentPurchaseResponse(BaseModel):\n    refund_transaction_id: int = Field(..., description=\"refund_transactions.id\", example=602)\n    tokens_remaining: int = Field(..., description=\"refund_tokens.tokens_remaining now\", example=1)\n    updated_wallet_balance_vbucks: int = Field(..., description=\"Wallet balance after refund\", example=1500)\n    model_config = ConfigDict(from_attributes=True)\n\nclass PriceAlertsRulesRequest(BaseModel):\n    item_name: str = Field(..., description=\"items.name for alert\", example=\"Star Wand\")\n    max_price_vbucks: int = Field(..., description=\"Maximum alert price (V-Bucks)\", example=800)\n    model_config = ConfigDict(from_attributes=True)\n\nclass PriceAlertsRulesResponse(BaseModel):\n    rule_id: int = Field(..., description=\"price_alert_rules.id\", example=710)\n    item_id: int = Field(..., description=\"items.id\", example=212)\n    region_id: int = Field(..., description=\"regions.id (always NA-East)\", example=1)\n    max_price_vbucks: int = Field(..., description=\"Maximum price threshold for alert\", example=800)\n    is_active: bool = Field(..., description=\"Whether alert rule is active\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass UserStatsPurchaseSummaryResponse(BaseModel):\n    total_vbucks_spent: int = Field(..., description=\"Total V-Bucks spent (completed purchases and gifts)\", example=8300)\n    purchase_count: int = Field(..., description=\"Number of completed purchase_receipts\", example=10)\n    gift_count: int = Field(..., description=\"Number of gifts sent via gift_transactions\", example=3)\n    category_breakdown: Dict[str, int] = Field(..., description=\"Category breakdown\", example={\"Outfit\": 4, \"Emote\": 3, \"Wrap\": 2, \"Bundle\": 4})\n    model_config = ConfigDict(from_attributes=True)\n\n@app.get(\n    \"/api/shop_offers/active\",\n    summary=\"List all current Shop offers for NA-East\",\n    description=\"Get all shop_offers valid now for region NA-East with item/bundle name, rarity, category, price, time remaining.\",\n    tags=[\"shop_offers\"],\n    operation_id=\"list_active_shop_offers_na_east\",\n    response_model=ShopOffersActiveResponse,\n)\nasync def list_active_shop_offers_na_east() -> ShopOffersActiveResponse:\n    session = SessionLocal()\n    now = datetime.now(timezone.utc)\n    region = session.query(Region).filter(Region.code == \"NA-East\").first()\n    offers = []\n    if region:\n        q = session.query(ShopOffer, Item).join(Item, ShopOffer.offered_item_id == Item.id)\n        q = q.filter(ShopOffer.region_id == region.id)\n        q = q.filter(ShopOffer.starts_at <= now, ShopOffer.ends_at > now)\n        shop_offers = q.all()\n        for offer, item in shop_offers:\n            bundles = session.query(Bundle).filter(Bundle.item_id == item.id).first()\n            offer_name = item.name\n            if bundles:\n                offer_name = item.name\n            offers.append(\n                _ShopOfferActiveOfferItem(\n                    offer_id=offer.id,\n                    name=offer_name,\n                    rarity=item.rarity,\n                    category=item.category,\n                    price_vbucks=offer.price_vbucks,\n                    time_remaining_seconds=int((offer.ends_at - now).total_seconds()) if offer.ends_at else 0,\n                )\n            )\n    session.close()\n    return ShopOffersActiveResponse(offers=offers)\n\n@app.get(\n    \"/api/shop_offers/filter\",\n    summary=\"Filter current shop for Outfits Epic/Legendary, sort, return cheapest 3\",\n    description=\"Return cheapest 3 Outfits in NA-East, rarity Epic/Legendary, sorted by price ascending, with offer id, name, and price.\",\n    tags=[\"shop_offers\"],\n    operation_id=\"filter_shop_offers_outfit_epic_legendary_cheapest\",\n    response_model=ShopOffersFilterResponse,\n)\nasync def filter_shop_offers_outfit_epic_legendary_cheapest() -> ShopOffersFilterResponse:\n    session = SessionLocal()\n    now = datetime.now(timezone.utc)\n    region = session.query(Region).filter(Region.code == \"NA-East\").first()\n    offers = []\n    if region:\n        q = session.query(ShopOffer, Item).join(Item, ShopOffer.offered_item_id == Item.id)\n        q = q.filter(ShopOffer.region_id == region.id)\n        q = q.filter(ShopOffer.starts_at <= now, ShopOffer.ends_at > now)\n        q = q.filter(Item.category == \"Outfit\")\n        q = q.filter(Item.rarity.in_([\"Epic\", \"Legendary\"]))\n        q = q.order_by(ShopOffer.price_vbucks.asc())\n        q = q.limit(3)\n        shop_offers = q.all()\n        for offer, item in shop_offers:\n            offers.append(\n                _ShopOffersFilterItem(\n                    offer_id=offer.id,\n                    name=item.name,\n                    price_vbucks=offer.price_vbucks\n                )\n            )\n    session.close()\n    return ShopOffersFilterResponse(offers=offers)\n\n@app.get(\n    \"/api/shop_offers/offer_by_name\",\n    summary=\"Fetch Shop offer ID by item/bundle name in NA-East region\",\n    description=\"Get current shop_offers.id for given item/bundle name in region NA-East. Use for downstream purchase/gift actions.\",\n    tags=[\"shop_offers\"],\n    operation_id=\"get_offer_id_by_name_na_east\",\n    response_model=ShopOffersOfferByNameResponse,\n)\nasync def get_offer_id_by_name_na_east(\n    name: str = Query(..., description=\"Item or bundle name\", example=\"Crimson Strike\")\n) -> ShopOffersOfferByNameResponse:\n    session = SessionLocal()\n    now = datetime.now(timezone.utc)\n    region = session.query(Region).filter(Region.code == \"NA-East\").first()\n    offer_id_val = None\n    price_vbucks_val = None\n    if region:\n        item = session.query(Item).filter(Item.name == name).first()\n        if item:\n            offer = session.query(ShopOffer).filter(\n                ShopOffer.region_id == region.id,\n                ShopOffer.offered_item_id == item.id,\n                ShopOffer.starts_at <= now,\n                ShopOffer.ends_at > now\n            ).first()\n            if offer:\n                offer_id_val = offer.id\n                price_vbucks_val = offer.price_vbucks\n    session.close()\n    return ShopOffersOfferByNameResponse(\n        offer_id=offer_id_val,\n        price_vbucks=price_vbucks_val\n    )\n\n@app.get(\n    \"/api/items/preview_metadata\",\n    summary=\"Fetch full preview metadata for item/bundle by name\",\n    description=\"Get description, rarity, set_name, all variants, and image URLs for named item or bundle in the database.\",\n    tags=[\"items\"],\n    operation_id=\"get_item_preview_metadata_by_name\",\n    response_model=ItemsPreviewMetadataResponse\n)\nasync def get_item_preview_metadata_by_name(\n    name: str = Query(..., description=\"Item or bundle name\", example=\"Crimson Strike\")\n) -> ItemsPreviewMetadataResponse:\n    session = SessionLocal()\n    item = session.query(Item).filter(Item.name == name).first()\n    if not item:\n        session.close()\n        return ItemsPreviewMetadataResponse(\n            item=_ItemPreviewItem(\n                id=0,\n                name=\"\",\n                description=None,\n                rarity=\"\",\n                set_name=None,\n                included_variants=[],\n                image_urls=[]\n            )\n        )\n    variants = session.query(ItemVariant).filter(ItemVariant.item_id == item.id).order_by(ItemVariant.sort_order).all()\n    images = session.query(ItemImage).filter(ItemImage.item_id == item.id).order_by(ItemImage.sort_order).all()\n    variant_models = [\n        _ItemPreviewVariant(variant_name=v.variant_name, variant_type=v.variant_type) for v in variants\n    ]\n    image_models = [\n        _ItemPreviewImage(\n            image_type=img.image_type,\n            url=img.url,\n            width=img.width,\n            height=img.height\n        ) for img in images\n    ]\n    preview = _ItemPreviewItem(\n        id=item.id,\n        name=item.name,\n        description=item.description,\n        rarity=item.rarity,\n        set_name=item.set_name,\n        included_variants=variant_models,\n        image_urls=image_models\n    )\n    session.close()\n    return ItemsPreviewMetadataResponse(item=preview)\n\n@app.post(\n    \"/api/purchases\",\n    summary=\"Purchase a shop offer using V-Bucks wallet\",\n    description=\"Buy a shop_offers item for user_id=1 from V-Bucks, return receipt, post-purchase balance, new entitlement item id(s).\",\n    tags=[\"purchases\"],\n    operation_id=\"purchase_shop_offer\",\n    response_model=PurchasesResponse\n)\nasync def purchase_shop_offer(\n    request: PurchasesRequest = Body(...)\n) -> PurchasesResponse:\n    session = SessionLocal()\n    # Required: user_id=1\n    user_id = 1\n    offer = session.query(ShopOffer).filter(ShopOffer.id == request.offer_id).first()\n    wallet = session.query(Wallet).filter(Wallet.user_id == user_id).first()\n    region_id = offer.region_id if offer else None\n    if offer and wallet and wallet.balance_vbucks >= offer.price_vbucks:\n        wallet.balance_vbucks -= offer.price_vbucks\n        session.add(wallet)\n        session.commit()\n        new_receipt = PurchaseReceipt(\n            user_id=user_id,\n            offer_id=offer.id,\n            region_id=region_id,\n            total_charged_vbucks=offer.price_vbucks,\n            status='completed'\n        )\n        session.add(new_receipt)\n        session.commit()\n        # If bundle, grant contents, if not, just offered item\n        bundle = session.query(Bundle).filter(Bundle.item_id == offer.offered_item_id).first()\n        entitlements = []\n        if bundle:\n            children = session.query(BundleItem).filter(BundleItem.bundle_item_id == bundle.item_id).all()\n            for child in children:\n                ent = Entitlement(\n                    user_id=user_id,\n                    item_id=child.child_item_id,\n                    source_type=\"purchase\",\n                    source_id=new_receipt.id\n                )\n                session.add(ent)\n                session.commit()\n                pritem = PurchaseReceiptItem(\n                    receipt_id=new_receipt.id,\n                    item_id=child.child_item_id,\n                    quantity=child.quantity\n                )\n                session.add(pritem)\n                session.commit()\n                itemobj = session.query(Item).filter(Item.id == child.child_item_id).first()\n                entitlements.append(\n                    _EntitlementInfo(\n                        entitlement_id=ent.id,\n                        item_id=child.child_item_id,\n                        item_name=itemobj.name if itemobj else \"\"\n                    )\n                )\n        else:\n            ent = Entitlement(\n                user_id=user_id,\n                item_id=offer.offered_item_id,\n                source_type=\"purchase\",\n                source_id=new_receipt.id\n            )\n            session.add(ent)\n            session.commit()\n            pritem = PurchaseReceiptItem(\n                receipt_id=new_receipt.id,\n                item_id=offer.offered_item_id,\n                quantity=1\n            )\n            session.add(pritem)\n            session.commit()\n            itemobj = session.query(Item).filter(Item.id == offer.offered_item_id).first()\n            entitlements.append(\n                _EntitlementInfo(\n                    entitlement_id=ent.id,\n                    item_id=offer.offered_item_id,\n                    item_name=itemobj.name if itemobj else \"\"\n                )\n            )\n        ledger = WalletLedger(\n            user_id=user_id,\n            entry_type=\"purchase\",\n            amount_vbucks=-offer.price_vbucks,\n            balance_after_vbucks=wallet.balance_vbucks,\n            reference_type=\"purchase_receipt\",\n            reference_id=new_receipt.id\n        )\n        session.add(ledger)\n        session.commit()\n        wallet_balance = wallet.balance_vbucks\n        response = PurchasesResponse(\n            receipt_id=new_receipt.id,\n            total_charged_vbucks=offer.price_vbucks,\n            wallet_balance_vbucks=wallet_balance,\n            entitlements=entitlements\n        )\n        session.close()\n        return response\n    session.close()\n    return PurchasesResponse(\n        receipt_id=0,\n        total_charged_vbucks=0,\n        wallet_balance_vbucks=wallet.balance_vbucks if wallet else 0,\n        entitlements=[]\n    )\n\n@app.post(\n    \"/api/gifts\",\n    summary=\"Gift a shop offer to a friend with custom message\",\n    description=\"Gift a shop_offers item to a friend, deduct V-Bucks, create gift_transaction, return transaction id and delivery status.\",\n    tags=[\"gifts\"],\n    operation_id=\"gift_shop_offer_to_friend\",\n    response_model=GiftsResponse\n)\nasync def gift_shop_offer_to_friend(\n    request: GiftsRequest = Body(...)\n) -> GiftsResponse:\n    session = SessionLocal()\n    sender_user_id = 1\n    offer = session.query(ShopOffer).filter(ShopOffer.id == request.offer_id).first()\n    wallet = session.query(Wallet).filter(Wallet.user_id == sender_user_id).first()\n    recipient = session.query(User).filter(User.username == request.friend_username).first()\n    region_id = offer.region_id if offer else None\n    gift_status = \"failed\"\n    gift_tx_id = 0\n    if recipient and offer and wallet and wallet.balance_vbucks >= offer.price_vbucks:\n        # Only allow gifting to accepted friends\n        f = session.query(Friend).filter(\n            Friend.user_id == sender_user_id,\n            Friend.friend_user_id == recipient.id,\n            Friend.status == 'accepted'\n        ).first()\n        if f:\n            wallet.balance_vbucks -= offer.price_vbucks\n            session.add(wallet)\n            session.commit()\n            gift_tx = GiftTransaction(\n                sender_user_id=sender_user_id,\n                recipient_user_id=recipient.id,\n                offer_id=offer.id,\n                region_id=region_id,\n                message=request.message,\n                total_charged_vbucks=offer.price_vbucks,\n                status='delivered'\n            )\n            session.add(gift_tx)\n            session.commit()\n            # If bundle, gift bundle children, else just item\n            bundle = session.query(Bundle).filter(Bundle.item_id == offer.offered_item_id).first()\n            if bundle:\n                children = session.query(BundleItem).filter(BundleItem.bundle_item_id == bundle.item_id).all()\n                for child in children:\n                    ent = Entitlement(\n                        user_id=recipient.id,\n                        item_id=child.child_item_id,\n                        source_type=\"gift\",\n                        source_id=gift_tx.id\n                    )\n                    session.add(ent)\n                    session.commit()\n                    gti = GiftTransactionItem(\n                        gift_transaction_id=gift_tx.id,\n                        item_id=child.child_item_id,\n                        quantity=child.quantity\n                    )\n                    session.add(gti)\n                    session.commit()\n            else:\n                ent = Entitlement(\n                    user_id=recipient.id,\n                    item_id=offer.offered_item_id,\n                    source_type=\"gift\",\n                    source_id=gift_tx.id\n                )\n                session.add(ent)\n                session.commit()\n                gti = GiftTransactionItem(\n                    gift_transaction_id=gift_tx.id,\n                    item_id=offer.offered_item_id,\n                    quantity=1\n                )\n                session.add(gti)\n                session.commit()\n            ledger = WalletLedger(\n                user_id=sender_user_id,\n                entry_type=\"gift\",\n                amount_vbucks=-offer.price_vbucks,\n                balance_after_vbucks=wallet.balance_vbucks,\n                reference_type=\"gift_transaction\",\n                reference_id=gift_tx.id\n            )\n            session.add(ledger)\n            session.commit()\n            gift_status = gift_tx.status\n            gift_tx_id = gift_tx.id\n    session.close()\n    return GiftsResponse(\n        gift_transaction_id=gift_tx_id,\n        delivery_status=gift_status\n    )\n\n@app.post(\n    \"/api/wishlists/items\",\n    summary=\"Add one or more items to authenticated user wishlist\",\n    description=\"Add specified items to the user's wishlist, then return updated wishlist with item ids, names, and shop presence.\",\n    tags=[\"wishlists\"],\n    operation_id=\"add_items_to_wishlist\",\n    response_model=WishlistsItemsResponse\n)\nasync def add_items_to_wishlist(\n    request: WishlistsItemsRequest = Body(...)\n) -> WishlistsItemsResponse:\n    session = SessionLocal()\n    user_id = 1\n    wishlist = session.query(Wishlist).filter(Wishlist.user_id == user_id).first()\n    if not wishlist:\n        wishlist = Wishlist(user_id=user_id)\n        session.add(wishlist)\n        session.commit()\n    for name in request.item_names:\n        itemobj = session.query(Item).filter(Item.name == name).first()\n        if itemobj:\n            wi = session.query(WishlistItem).filter(WishlistItem.wishlist_id == wishlist.id, WishlistItem.item_id == itemobj.id).first()\n            if not wi:\n                wishitem = WishlistItem(wishlist_id=wishlist.id, item_id=itemobj.id)\n                session.add(wishitem)\n                session.commit()\n    region = session.query(Region).filter(Region.code == \"NA-East\").first()\n    now = datetime.now(timezone.utc)\n    updated_items = []\n    wishlist_items = session.query(WishlistItem, Item).join(Item, WishlistItem.item_id == Item.id).filter(WishlistItem.wishlist_id == wishlist.id).all()\n    for wi, item in wishlist_items:\n        in_shop = False\n        if region:\n            shop_offer = session.query(ShopOffer).filter(\n                ShopOffer.region_id == region.id,\n                ShopOffer.offered_item_id == item.id,\n                ShopOffer.starts_at <= now,\n                ShopOffer.ends_at > now\n            ).first()\n            if shop_offer:\n                in_shop = True\n        updated_items.append(\n            _WishlistItemInfo(\n                item_id=item.id,\n                item_name=item.name,\n                is_in_shop=in_shop\n            )\n        )\n    session.close()\n    return WishlistsItemsResponse(\n        wishlist_items=updated_items\n    )\n\n@app.post(\n    \"/api/compliance/purchase_check\",\n    summary=\"Check purchase against parental spending limits and report errors\",\n    description=\"Checks purchase offer id against parental_controls for user_id=1, returns first blocking rule/error if present.\",\n    tags=[\"compliance\"],\n    operation_id=\"check_purchase_compliance\",\n    response_model=CompliancePurchaseCheckResponse\n)\nasync def check_purchase_compliance(\n    request: CompliancePurchaseCheckRequest = Body(...)\n) -> CompliancePurchaseCheckResponse:\n    session = SessionLocal()\n    user_id = 1\n    offer = session.query(ShopOffer).filter(ShopOffer.id == request.offer_id).first()\n    price = offer.price_vbucks if offer else 0\n    pc = session.query(ParentalControl).filter(ParentalControl.user_id == user_id).first()\n    blocked = False\n    details = None\n    if pc and price > pc.spend_remaining_vbucks:\n        blocked = True\n        context = f'{{\"spend_remaining_vbucks\":{pc.spend_remaining_vbucks},\"bundle_cost_vbucks\":{price}}}'\n        comp_error = session.query(ComplianceError).filter(ComplianceError.user_id == user_id, ComplianceError.offer_id == request.offer_id).order_by(ComplianceError.created_at.desc()).first()\n        details = _ComplianceErrorDetails(\n            rule_code=\"SPEND_LIMIT_EXCEEDED\",\n            rule_description=f\"Spending limit exceeded by {price - pc.spend_remaining_vbucks} V-Bucks\",\n            context_json=context\n        )\n        if not comp_error:\n            ce = ComplianceError(\n                user_id=user_id,\n                action_type=\"purchase\",\n                offer_id=request.offer_id,\n                attempted_total_vbucks=price,\n                rule_code=\"SPEND_LIMIT_EXCEEDED\",\n                rule_description=f\"Spending limit exceeded by {price - pc.spend_remaining_vbucks} V-Bucks\",\n                context_json=context\n            )\n            session.add(ce)\n            session.commit()\n    session.close()\n    return CompliancePurchaseCheckResponse(\n        blocked=blocked,\n        error_details=details\n    )\n\n@app.post(\n    \"/api/refunds/recent_purchase\",\n    summary=\"Refund the most recent eligible purchase using one refund token\",\n    description=\"Refunds most recent purchase_receipt not yet refunded, reverses entitlements, restores V-Bucks, returns refund id, tokens left, new balance.\",\n    tags=[\"refunds\"],\n    operation_id=\"refund_most_recent_eligible_purchase\",\n    response_model=RefundsRecentPurchaseResponse\n)\nasync def refund_most_recent_eligible_purchase() -> RefundsRecentPurchaseResponse:\n    session = SessionLocal()\n    user_id = 1\n    tokens = session.query(RefundToken).filter(RefundToken.user_id == user_id).first()\n    if not tokens or tokens.tokens_remaining < 1:\n        session.close()\n        return RefundsRecentPurchaseResponse(\n            refund_transaction_id=0,\n            tokens_remaining=tokens.tokens_remaining if tokens else 0,\n            updated_wallet_balance_vbucks=0\n        )\n    receipt = session.query(PurchaseReceipt).filter(\n        PurchaseReceipt.user_id == user_id,\n        PurchaseReceipt.status == 'completed'\n    ).order_by(PurchaseReceipt.purchased_at.desc()).first()\n    if not receipt:\n        session.close()\n        return RefundsRecentPurchaseResponse(\n            refund_transaction_id=0,\n            tokens_remaining=tokens.tokens_remaining if tokens else 0,\n            updated_wallet_balance_vbucks=0\n        )\n    already_refunded = session.query(RefundTransaction).filter(RefundTransaction.purchase_receipt_id == receipt.id).first()\n    if already_refunded:\n        session.close()\n        return RefundsRecentPurchaseResponse(\n            refund_transaction_id=already_refunded.id,\n            tokens_remaining=tokens.tokens_remaining,\n            updated_wallet_balance_vbucks=session.query(Wallet).filter(Wallet.user_id == user_id).first().balance_vbucks if session.query(Wallet).filter(Wallet.user_id == user_id).first() else 0\n        )\n    rt = RefundTransaction(\n        user_id=user_id,\n        purchase_receipt_id=receipt.id,\n        token_used=True,\n        vbucks_restored=receipt.total_charged_vbucks,\n        status=\"completed\"\n    )\n    session.add(rt)\n    tokens.tokens_remaining -= 1\n    session.add(tokens)\n    # Refund vbucks to wallet\n    wallet = session.query(Wallet).filter(Wallet.user_id == user_id).first()\n    if wallet:\n        wallet.balance_vbucks += receipt.total_charged_vbucks\n        session.add(wallet)\n    session.commit()\n    # Revoke entitlements given by that purchase\n    entitlements = session.query(Entitlement).filter(\n        Entitlement.user_id == user_id,\n        Entitlement.source_type == \"purchase\",\n        Entitlement.source_id == receipt.id,\n        Entitlement.revoked_at == None\n    ).all()\n    for entitlement in entitlements:\n        entitlement.revoked_at = datetime.now(timezone.utc)\n        session.add(entitlement)\n        # Record entitlements\n        rte = RefundTransactionEntitlement(refund_transaction_id=rt.id, entitlement_id=entitlement.id)\n        session.add(rte)\n    receipt.status = \"refunded\"\n    session.add(receipt)\n    # Log ledger\n    ledger = WalletLedger(\n        user_id=user_id,\n        entry_type=\"refund\",\n        amount_vbucks=receipt.total_charged_vbucks,\n        balance_after_vbucks=wallet.balance_vbucks if wallet else 0,\n        reference_type=\"refund_transaction\",\n        reference_id=rt.id\n    )\n    session.add(ledger)\n    session.commit()\n    updated_balance = wallet.balance_vbucks if wallet else 0\n    session.close()\n    return RefundsRecentPurchaseResponse(\n        refund_transaction_id=rt.id,\n        tokens_remaining=tokens.tokens_remaining,\n        updated_wallet_balance_vbucks=updated_balance\n    )\n\n@app.post(\n    \"/api/price_alert_rules\",\n    summary=\"Create a price alert rule for a wishlist item\",\n    description=\"Adds a new price_alert_rules row for user_id=1 for given item at price, returns rule id and parameters.\",\n    tags=[\"price_alerts\"],\n    operation_id=\"create_price_alert_rule_for_item\",\n    response_model=PriceAlertsRulesResponse\n)\nasync def create_price_alert_rule_for_item(\n    request: PriceAlertsRulesRequest = Body(...)\n) -> PriceAlertsRulesResponse:\n    session = SessionLocal()\n    user_id = 1\n    item = session.query(Item).filter(Item.name == request.item_name).first()\n    region = session.query(Region).filter(Region.code == \"NA-East\").first()\n    if not item or not region:\n        session.close()\n        return PriceAlertsRulesResponse(\n            rule_id=0,\n            item_id=0,\n            region_id=0,\n            max_price_vbucks=request.max_price_vbucks,\n            is_active=True\n        )\n    rule = session.query(PriceAlertRule).filter(\n        PriceAlertRule.user_id == user_id,\n        PriceAlertRule.item_id == item.id,\n        PriceAlertRule.region_id == region.id,\n        PriceAlertRule.max_price_vbucks == request.max_price_vbucks,\n    ).first()\n    if not rule:\n        rule = PriceAlertRule(\n            user_id=user_id,\n            item_id=item.id,\n            region_id=region.id,\n            max_price_vbucks=request.max_price_vbucks,\n            is_active=True\n        )\n        session.add(rule)\n        session.commit()\n    session.close()\n    return PriceAlertsRulesResponse(\n        rule_id=rule.id,\n        item_id=item.id,\n        region_id=region.id,\n        max_price_vbucks=rule.max_price_vbucks,\n        is_active=bool(rule.is_active)\n    )\n\n@app.get(\n    \"/api/user_stats/purchase_summary\",\n    summary=\"Generate purchase history summary for last 30 days\",\n    description=\"Returns V-Bucks spent, num purchases, gifts sent, and category breakdown for user_id=1 in last 30 days.\",\n    tags=[\"user_stats\"],\n    operation_id=\"get_personal_purchase_summary_last_30_days\",\n    response_model=UserStatsPurchaseSummaryResponse\n)\nasync def get_personal_purchase_summary_last_30_days() -> UserStatsPurchaseSummaryResponse:\n    session = SessionLocal()\n    user_id = 1\n    period_start = datetime.now(timezone.utc) - timedelta(days=30)\n    purchase_q = session.query(PurchaseReceipt).filter(\n        PurchaseReceipt.user_id == user_id,\n        PurchaseReceipt.status == \"completed\",\n        PurchaseReceipt.purchased_at >= period_start\n    )\n    purchase_count = purchase_q.count()\n    total_vbucks_spent = sum([pr.total_charged_vbucks for pr in purchase_q])\n    # Gifts sent\n    gift_q = session.query(GiftTransaction).filter(\n        GiftTransaction.sender_user_id == user_id,\n        GiftTransaction.status == \"delivered\",\n        GiftTransaction.created_at >= period_start\n    )\n    gift_count = gift_q.count()\n    gift_vbucks_spent = sum([gt.total_charged_vbucks for gt in gift_q])\n    # category breakdown: collect items from both purchases and gifts\n    cat_counts: Dict[str, int] = {}\n    pr_items = session.query(PurchaseReceiptItem, Item).join(Item, PurchaseReceiptItem.item_id == Item.id).join(PurchaseReceipt,\n        PurchaseReceiptItem.receipt_id == PurchaseReceipt.id\n    ).filter(PurchaseReceipt.user_id == user_id, PurchaseReceipt.status == \"completed\", PurchaseReceipt.purchased_at >= period_start)\n    for _, item in pr_items:\n        cat_counts[item.category] = cat_counts.get(item.category, 0) + 1\n    gift_items = session.query(GiftTransactionItem, Item).join(Item, GiftTransactionItem.item_id == Item.id).join(GiftTransaction,\n        GiftTransactionItem.gift_transaction_id == GiftTransaction.id\n    ).filter(GiftTransaction.sender_user_id == user_id, GiftTransaction.status == \"delivered\", GiftTransaction.created_at >= period_start)\n    for _, item in gift_items:\n        cat_counts[item.category] = cat_counts.get(item.category, 0) + 1\n    session.close()\n    return UserStatsPurchaseSummaryResponse(\n        total_vbucks_spent=total_vbucks_spent + gift_vbucks_spent,\n        purchase_count=purchase_count,\n        gift_count=gift_count,\n        category_breakdown=cat_counts\n    )\n\nif __name__ == \"__main__\":\n    import uvicorn, os\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
{"scenario": "DocuSign (E-Signature & Agreement Workflow)", "db_path": "./outputs/databases/docusign_e_signature_agreement_workflow.db", "full_code": "import os\nfrom typing import List, Optional, Dict\nfrom datetime import datetime\nfrom base64 import b64decode, b64encode\n\nfrom fastapi import FastAPI, Body, Query, Path\nfrom pydantic import BaseModel, Field, ConfigDict\n\nfrom sqlalchemy import (\n    create_engine, Column, Integer, String, Boolean, DateTime,\n    ForeignKey, Text, Float, BLOB, UniqueConstraint, CheckConstraint\n)\nfrom sqlalchemy.orm import declarative_base, relationship, sessionmaker\n\ndb_path = os.getenv(\"DATABASE_PATH\", \"sqlite:///xxxx.db\")\nengine = create_engine(db_path, connect_args={\"check_same_thread\": False} if db_path.startswith(\"sqlite\") else {})\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)\nBase = declarative_base()\n\nclass Users(Base):\n    __tablename__ = \"users\"\n    id = Column(Integer, primary_key=True)\n    username = Column(String, unique=True)\n    email = Column(String, unique=True, nullable=False, index=True)\n    full_name = Column(String)\n    profile_json = Column(Text)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass Documents(Base):\n    __tablename__ = \"documents\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    filename = Column(String, nullable=False)\n    mime_type = Column(String, nullable=False, default=\"application/pdf\")\n    storage_mode = Column(String, nullable=False, default=\"upload\")\n    content_blob = Column(BLOB)\n    content_sha256 = Column(String)\n    page_count = Column(Integer)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass Envelopes(Base):\n    __tablename__ = \"envelopes\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False)\n    title = Column(String, nullable=False, index=True)\n    subject = Column(String)\n    email_message = Column(String)\n    status = Column(String, nullable=False)\n    source_type = Column(String, nullable=False)\n    template_id = Column(Integer, ForeignKey(\"templates.id\", ondelete=\"SET NULL\"))\n    sent_at = Column(DateTime)\n    completed_at = Column(DateTime)\n    voided_at = Column(DateTime)\n    void_reason = Column(String)\n    expires_at = Column(DateTime)\n    reminder_enabled = Column(Boolean, nullable=False, default=False)\n    reminder_interval_days = Column(Integer)\n    reminder_next_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass EnvelopeDocuments(Base):\n    __tablename__ = \"envelope_documents\"\n    id = Column(Integer, primary_key=True)\n    envelope_id = Column(Integer, ForeignKey(\"envelopes.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    document_id = Column(Integer, ForeignKey(\"documents.id\", ondelete=\"RESTRICT\"), nullable=False, index=True)\n    doc_order = Column(Integer, nullable=False, default=1)\n    display_name = Column(String)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"envelope_id\", \"doc_order\"),\n        UniqueConstraint(\"envelope_id\", \"document_id\"),\n    )\n\nclass EnvelopeRecipients(Base):\n    __tablename__ = \"envelope_recipients\"\n    id = Column(Integer, primary_key=True)\n    envelope_id = Column(Integer, ForeignKey(\"envelopes.id\", ondelete=\"CASCADE\"), nullable=False)\n    role = Column(String, nullable=False)\n    routing_order = Column(Integer, nullable=False, default=1)\n    name = Column(String, nullable=False)\n    email = Column(String, nullable=False, index=True)\n    status = Column(String, nullable=False, default=\"Created\")\n    sms_phone = Column(String)\n    auth_method = Column(String)\n    auth_required = Column(Boolean, nullable=False, default=False)\n    delivered_at = Column(DateTime)\n    acted_at = Column(DateTime)\n    completed_at = Column(DateTime)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"envelope_id\", \"email\"),\n    )\n\nclass AuditEvents(Base):\n    __tablename__ = \"audit_events\"\n    id = Column(Integer, primary_key=True)\n    envelope_id = Column(Integer, ForeignKey(\"envelopes.id\", ondelete=\"CASCADE\"), nullable=False)\n    recipient_id = Column(Integer, ForeignKey(\"envelope_recipients.id\", ondelete=\"SET NULL\"))\n    event_type = Column(String, nullable=False)\n    event_at = Column(DateTime, nullable=False, index=True)\n    ip_address = Column(String)\n    user_agent = Column(String)\n    details_json = Column(Text)\n    created_at = Column(DateTime, nullable=False)\n\nclass EnvelopeArtifacts(Base):\n    __tablename__ = \"envelope_artifacts\"\n    id = Column(Integer, primary_key=True)\n    envelope_id = Column(Integer, ForeignKey(\"envelopes.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    artifact_type = Column(String, nullable=False)\n    certificate_id = Column(String)\n    content_blob = Column(BLOB)\n    content_sha256 = Column(String)\n    content_mime_type = Column(String)\n    created_at = Column(DateTime, nullable=False)\n\nclass Tabs(Base):\n    __tablename__ = \"tabs\"\n    id = Column(Integer, primary_key=True)\n    envelope_id = Column(Integer, ForeignKey(\"envelopes.id\", ondelete=\"CASCADE\"), nullable=False)\n    document_id = Column(Integer, ForeignKey(\"documents.id\", ondelete=\"SET NULL\"))\n    recipient_id = Column(Integer, ForeignKey(\"envelope_recipients.id\", ondelete=\"CASCADE\"), nullable=False)\n    tab_type = Column(String, nullable=False)\n    label = Column(String)\n    required = Column(Boolean, nullable=False, default=False)\n    anchor_text = Column(String)\n    anchor_offset_x = Column(Integer)\n    anchor_offset_y = Column(Integer)\n    page_number = Column(Integer)\n    x_position = Column(Float)\n    y_position = Column(Float)\n    width = Column(Float)\n    height = Column(Float)\n    max_length = Column(Integer)\n    default_value = Column(String)\n    value_text = Column(String)\n    checked = Column(Boolean)\n    group_id = Column(Integer, ForeignKey(\"tab_groups.id\", ondelete=\"CASCADE\"))\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass TabGroups(Base):\n    __tablename__ = \"tab_groups\"\n    id = Column(Integer, primary_key=True)\n    envelope_id = Column(Integer, ForeignKey(\"envelopes.id\", ondelete=\"CASCADE\"), nullable=False)\n    recipient_id = Column(Integer, ForeignKey(\"envelope_recipients.id\", ondelete=\"SET NULL\"))\n    name = Column(String, nullable=False)\n    group_type = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"envelope_id\", \"name\"),\n    )\n\nclass Templates(Base):\n    __tablename__ = \"templates\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    name = Column(String, nullable=False, index=True)\n    description = Column(String)\n    is_active = Column(Boolean, nullable=False, default=True)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"owner_user_id\", \"name\"),\n    )\n\nclass TemplateRoles(Base):\n    __tablename__ = \"template_roles\"\n    id = Column(Integer, primary_key=True)\n    template_id = Column(Integer, ForeignKey(\"templates.id\", ondelete=\"CASCADE\"), nullable=False)\n    role_name = Column(String, nullable=False)\n    role_type = Column(String, nullable=False)\n    routing_order = Column(Integer, nullable=False, default=1)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (UniqueConstraint(\"template_id\", \"role_name\"),)\n\nclass TemplateDocuments(Base):\n    __tablename__ = \"template_documents\"\n    id = Column(Integer, primary_key=True)\n    template_id = Column(Integer, ForeignKey(\"templates.id\", ondelete=\"CASCADE\"), nullable=False)\n    document_id = Column(Integer, ForeignKey(\"documents.id\", ondelete=\"RESTRICT\"), nullable=False)\n    doc_order = Column(Integer, nullable=False, default=1)\n    display_name = Column(String)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"template_id\", \"doc_order\"),\n        UniqueConstraint(\"template_id\", \"document_id\"),\n    )\n\nclass ReusableTabs(Base):\n    __tablename__ = \"reusable_tabs\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    name = Column(String, nullable=False, index=True)\n    tab_type = Column(String, nullable=False)\n    required = Column(Boolean, nullable=False, default=False)\n    max_length = Column(Integer)\n    default_value = Column(String)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"owner_user_id\", \"name\"),\n    )\n\nclass TemplateTabs(Base):\n    __tablename__ = \"template_tabs\"\n    id = Column(Integer, primary_key=True)\n    template_id = Column(Integer, ForeignKey(\"templates.id\", ondelete=\"CASCADE\"), nullable=False)\n    document_id = Column(Integer, ForeignKey(\"documents.id\", ondelete=\"SET NULL\"))\n    role_id = Column(Integer, ForeignKey(\"template_roles.id\", ondelete=\"CASCADE\"), nullable=False)\n    reusable_tab_id = Column(Integer, ForeignKey(\"reusable_tabs.id\", ondelete=\"SET NULL\"))\n    tab_type = Column(String, nullable=False)\n    label = Column(String)\n    required = Column(Boolean, nullable=False, default=False)\n    anchor_text = Column(String)\n    anchor_offset_x = Column(Integer)\n    anchor_offset_y = Column(Integer)\n    page_number = Column(Integer)\n    x_position = Column(Float)\n    y_position = Column(Float)\n    width = Column(Float)\n    height = Column(Float)\n    max_length = Column(Integer)\n    default_value = Column(String)\n    checked = Column(Boolean)\n    group_id = Column(Integer, ForeignKey(\"template_tab_groups.id\", ondelete=\"CASCADE\"))\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass TemplateTabGroups(Base):\n    __tablename__ = \"template_tab_groups\"\n    id = Column(Integer, primary_key=True)\n    template_id = Column(Integer, ForeignKey(\"templates.id\", ondelete=\"CASCADE\"), nullable=False)\n    role_id = Column(Integer, ForeignKey(\"template_roles.id\", ondelete=\"CASCADE\"), nullable=False)\n    name = Column(String, nullable=False)\n    group_type = Column(String, nullable=False)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"template_id\", \"role_id\", \"name\"),\n    )\n\nclass PermissionSets(Base):\n    __tablename__ = \"permission_sets\"\n    id = Column(Integer, primary_key=True)\n    name = Column(String, nullable=False, unique=True, index=True)\n    description = Column(String)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass UserGroups(Base):\n    __tablename__ = \"user_groups\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    name = Column(String, nullable=False)\n    permission_set_id = Column(Integer, ForeignKey(\"permission_sets.id\", ondelete=\"RESTRICT\"), nullable=False, index=True)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n    __table_args__ = (\n        UniqueConstraint(\"owner_user_id\", \"name\"),\n    )\n\nclass GroupMembers(Base):\n    __tablename__ = \"group_members\"\n    group_id = Column(Integer, ForeignKey(\"user_groups.id\", ondelete=\"CASCADE\"), primary_key=True)\n    user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), primary_key=True, index=True)\n    created_at = Column(DateTime, nullable=False)\n\nclass ConnectSubscriptions(Base):\n    __tablename__ = \"connect_subscriptions\"\n    id = Column(Integer, primary_key=True)\n    owner_user_id = Column(Integer, ForeignKey(\"users.id\", ondelete=\"CASCADE\"), nullable=False, index=True)\n    name = Column(String)\n    endpoint_url = Column(String, nullable=False, index=True)\n    content_type = Column(String, nullable=False, default=\"application/json\")\n    enabled = Column(Boolean, nullable=False, default=True)\n    include_recipient_status = Column(Boolean, nullable=False, default=False)\n    include_document_status = Column(Boolean, nullable=False, default=False)\n    created_at = Column(DateTime, nullable=False)\n    updated_at = Column(DateTime, nullable=False)\n\nclass ConnectSubscriptionEvents(Base):\n    __tablename__ = \"connect_subscription_events\"\n    subscription_id = Column(Integer, ForeignKey(\"connect_subscriptions.id\", ondelete=\"CASCADE\"), primary_key=True)\n    event_type = Column(String, primary_key=True)\n    created_at = Column(DateTime, nullable=False)\n\nBase.metadata.create_all(engine)\n\napp = FastAPI(\n    title=\"DocuSign Simulation API\",\n    description=\"DocuSign-like E-Signature & Agreement Workflow API.\",\n    version=\"1.0.0\"\n)\n\nclass CreateEnvelopeRequest(BaseModel):\n    title: str = Field(..., description=\"Envelope title\", example=\"NDA - Acme Vendor - Feb 2026\")\n    subject: Optional[str] = Field(None, description=\"Email subject for envelope notification\", example=\"Please sign: Mutual NDA\")\n    email_message: Optional[str] = Field(None, description=\"Custom email body message\", example=\"Hi Alice, please sign by Friday so we can proceed.\")\n    status: str = Field(..., description=\"Initial envelope status\", example=\"Created\")\n    source_type: str = Field(..., description=\"Source type for envelope\", example=\"template\")\n    template_id: Optional[int] = Field(None, description=\"Template to use for envelope\", example=2)\n    expires_at: Optional[str] = Field(None, description=\"Envelope expiration date/time (ISO8601)\", example=\"2026-02-12T23:59:59Z\")\n    reminder_enabled: Optional[bool] = Field(None, description=\"Enable reminders\", example=True)\n    reminder_interval_days: Optional[int] = Field(None, description=\"Reminder interval in days\", example=2)\n\nclass CreateEnvelopeResponse(BaseModel):\n    envelope_id: int = Field(..., description=\"Unique envelope identifier\", example=10)\n    status: str = Field(..., description=\"Envelope current status\", example=\"Created\")\n    title: str = Field(..., description=\"Envelope title\", example=\"NDA - Acme Vendor - Feb 2026\")\n    owner_user_id: int = Field(..., description=\"Envelope owner (always user_id=1)\", example=1)\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddEnvelopeDocumentRequest(BaseModel):\n    filename: str = Field(..., description=\"Document filename\", example=\"Consulting_SOW_Q2_2026.pdf\")\n    mime_type: Optional[str] = Field(None, description=\"MIME type of document\", example=\"application/pdf\")\n    content_blob: Optional[str] = Field(None, description=\"Base64-encoded document binary content\", example=\"<base64>\")\n    storage_mode: Optional[str] = Field(None, description=\"Storage mode\", example=\"upload\")\n\nclass AddEnvelopeDocumentResponse(BaseModel):\n    document_id: int = Field(..., description=\"Unique document identifier\", example=40)\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=20)\n    doc_order: int = Field(..., description=\"Document order within envelope\", example=1)\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddEnvelopeRecipientRequest(BaseModel):\n    role: str = Field(..., description=\"Recipient role\", example=\"Signer\")\n    routing_order: int = Field(..., description=\"Order for signing/approval\", example=1)\n    name: str = Field(..., description=\"Recipient full name\", example=\"Alice Nguyen\")\n    email: str = Field(..., description=\"Recipient email address\", example=\"alice.nguyen@example.com\")\n    auth_method: Optional[str] = Field(None, description=\"Authentication method\", example=\"sms\")\n    auth_required: Optional[bool] = Field(None, description=\"Require authentication for recipient\", example=True)\n    sms_phone: Optional[str] = Field(None, description=\"SMS phone for recipient authentication\", example=\"+1-415-555-0199\")\n\nclass AddEnvelopeRecipientResponse(BaseModel):\n    recipient_id: int = Field(..., description=\"Unique recipient identifier\", example=125)\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=10)\n    role: str = Field(..., description=\"Recipient role\", example=\"Signer\")\n    routing_order: int = Field(..., description=\"Signing order\", example=1)\n    name: str = Field(..., description=\"Recipient name\", example=\"Alice Nguyen\")\n    email: str = Field(..., description=\"Recipient email\", example=\"alice.nguyen@example.com\")\n    status: str = Field(..., description=\"Recipient workflow status\", example=\"Created\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddEnvelopeTabRequest(BaseModel):\n    recipient_id: int = Field(..., description=\"Recipient ID\", example=222)\n    tab_type: str = Field(..., description=\"Type of tab (field)\", example=\"signature\")\n    label: Optional[str] = Field(None, description=\"Tab label\", example=\"Company Name\")\n    required: Optional[bool] = Field(None, description=\"Tab is required\", example=True)\n    anchor_text: Optional[str] = Field(None, description=\"Anchor text for field placement\", example=\"/CLIENT_LEGAL_NAME/\")\n    anchor_offset_x: Optional[int] = Field(None, description=\"X offset from anchor text\", example=10)\n    anchor_offset_y: Optional[int] = Field(None, description=\"Y offset from anchor text\", example=0)\n    max_length: Optional[int] = Field(None, description=\"Max length for text input\", example=80)\n    default_value: Optional[str] = Field(None, description=\"Default value\", example=\"\")\n    checked: Optional[bool] = Field(None, description=\"Checkbox checked by default\", example=False)\n    group_id: Optional[int] = Field(None, description=\"Associated tab group ID\", example=301)\n\nclass AddEnvelopeTabResponse(BaseModel):\n    tab_id: int = Field(..., description=\"Unique envelope tab identifier\", example=1402)\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=20)\n    recipient_id: int = Field(..., description=\"Recipient ID\", example=222)\n    tab_type: str = Field(..., description=\"Tab type\", example=\"signature\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SendEnvelopeRequest(BaseModel):\n    status: str = Field(..., description=\"Status to set\", example=\"Sent\")\n    sent_at: Optional[str] = Field(None, description=\"Timestamp when envelope is sent (ISO8601)\", example=\"2026-02-01T09:00:00Z\")\n    reminder_enabled: Optional[bool] = Field(None, description=\"Enable reminders\", example=True)\n    reminder_interval_days: Optional[int] = Field(None, description=\"Reminder interval (days)\", example=2)\n    reminder_next_at: Optional[str] = Field(None, description=\"Next reminder timestamp\", example=\"2026-02-03T09:00:00Z\")\n    expires_at: Optional[str] = Field(None, description=\"Envelope expiration date/time\", example=\"2026-02-11T23:59:59Z\")\n\nclass SendEnvelopeResponse(BaseModel):\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=20)\n    status: str = Field(..., description=\"Envelope status after update\", example=\"Sent\")\n    sent_at: Optional[str] = Field(None, description=\"Timestamp when envelope was sent\", example=\"2026-02-01T09:00:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass EnvelopeItemModel(BaseModel):\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=90)\n    subject: Optional[str] = Field(None, description=\"Envelope subject\", example=\"Offer Letter - Jordan Lee\")\n    sent_at: Optional[str] = Field(None, description=\"Envelope sent timestamp\", example=\"2026-01-03T08:00:00Z\")\n    status: str = Field(..., description=\"Status\", example=\"Delivered\")\n\nclass EnvelopeListResponse(BaseModel):\n    envelopes: List[EnvelopeItemModel] = Field(..., description=\"List of envelopes\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass AuditEventModel(BaseModel):\n    event_type: str = Field(..., description=\"Type of event\", example=\"delivered\")\n    event_at: str = Field(..., description=\"Timestamp for event\", example=\"2026-01-03T14:00:00Z\")\n    recipient_id: Optional[int] = Field(None, description=\"Recipient ID\", example=242)\n\nclass AuditEventsResponse(BaseModel):\n    audit_events: List[AuditEventModel] = Field(..., description=\"Audit events\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass VoidEnvelopeRequest(BaseModel):\n    void_reason: str = Field(..., description=\"Reason for voiding\", example=\"Customer requested revised pricing; canceling current draft.\")\n\nclass VoidEnvelopeResponse(BaseModel):\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=12)\n    status: str = Field(..., description=\"Envelope status\", example=\"Voided\")\n    void_reason: str = Field(..., description=\"Reason for voiding\", example=\"Customer requested revised pricing; canceling current draft.\")\n    voided_at: str = Field(..., description=\"Timestamp envelope was voided\", example=\"2026-03-01T11:00:00Z\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateReusableTabRequest(BaseModel):\n    name: str = Field(..., description=\"Reusable tab name\", example=\"Client Legal Name\")\n    tab_type: str = Field(..., description=\"Type of tab\", example=\"text\")\n    required: bool = Field(..., description=\"Is field required\", example=True)\n    max_length: Optional[int] = Field(None, description=\"Max length for text input\", example=80)\n    default_value: Optional[str] = Field(None, description=\"Default value\", example=\"\")\n\nclass CreateReusableTabResponse(BaseModel):\n    reusable_tab_id: int = Field(..., description=\"Reusable tab ID\", example=21)\n    name: str = Field(..., description=\"Tab name\", example=\"Client Legal Name\")\n    tab_type: str = Field(..., description=\"Tab type\", example=\"text\")\n    required: bool = Field(..., description=\"Is field required\", example=True)\n    max_length: Optional[int] = Field(None, description=\"Max length for field\", example=80)\n    default_value: Optional[str] = Field(None, description=\"Default value\", example=\"\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddReusableTabToTemplateRequest(BaseModel):\n    role_id: int = Field(..., description=\"Template role ID\", example=22)\n    reusable_tab_id: int = Field(..., description=\"Reusable tab to attach\", example=21)\n    anchor_text: str = Field(..., description=\"Anchor text for placement\", example=\"/CLIENT_LEGAL_NAME/\")\n    anchor_offset_x: Optional[int] = Field(None, description=\"X offset\", example=10)\n    anchor_offset_y: Optional[int] = Field(None, description=\"Y offset\", example=0)\n\nclass AddReusableTabToTemplateResponse(BaseModel):\n    template_tab_id: int = Field(..., description=\"Template tab ID\", example=172)\n    template_id: int = Field(..., description=\"Template ID\", example=5)\n    role_id: int = Field(..., description=\"Role ID\", example=22)\n    reusable_tab_id: int = Field(..., description=\"Reusable tab ID\", example=21)\n    anchor_text: str = Field(..., description=\"Anchor text\", example=\"/CLIENT_LEGAL_NAME/\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateTemplateCheckboxGroupRequest(BaseModel):\n    role_id: int = Field(..., description=\"Role ID within template\", example=34)\n    name: str = Field(..., description=\"Group name\", example=\"Optional Add-ons\")\n    group_type: str = Field(..., description=\"Type (always checkbox_group)\", example=\"checkbox_group\")\n\nclass CreateTemplateCheckboxGroupResponse(BaseModel):\n    tab_group_id: int = Field(..., description=\"Unique tab group ID\", example=401)\n    template_id: int = Field(..., description=\"Template ID\", example=6)\n    role_id: int = Field(..., description=\"Role ID\", example=34)\n    name: str = Field(..., description=\"Group name\", example=\"Optional Add-ons\")\n    group_type: str = Field(..., description=\"Type of group\", example=\"checkbox_group\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddTemplateTabToGroupRequest(BaseModel):\n    role_id: int = Field(..., description=\"Template role ID\", example=34)\n    group_id: int = Field(..., description=\"Checkbox group ID\", example=401)\n    tab_type: str = Field(..., description=\"Type (checkbox)\", example=\"checkbox\")\n    label: str = Field(..., description=\"Checkbox option label\", example=\"Premium Support\")\n    checked: Optional[bool] = Field(None, description=\"Default checked state\", example=False)\n\nclass AddTemplateTabToGroupResponse(BaseModel):\n    template_tab_id: int = Field(..., description=\"Template tab ID\", example=183)\n    group_id: int = Field(..., description=\"Checkbox group ID\", example=401)\n    label: str = Field(..., description=\"Checkbox label\", example=\"Premium Support\")\n    checked: Optional[bool] = Field(None, description=\"Default checked state\", example=False)\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateUserGroupRequest(BaseModel):\n    name: str = Field(..., description=\"Group name\", example=\"APAC Sales\")\n    permission_set_id: int = Field(..., description=\"Permission set ID\", example=3)\n\nclass CreateUserGroupResponse(BaseModel):\n    group_id: int = Field(..., description=\"User group ID\", example=52)\n    name: str = Field(..., description=\"Group name\", example=\"APAC Sales\")\n    permission_set_id: int = Field(..., description=\"Permission set ID\", example=3)\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddUsersToGroupRequest(BaseModel):\n    group_id: int = Field(..., description=\"User group ID\", example=52)\n    user_emails: List[str] = Field(..., description=\"List of user emails to add\", example=[\"sana.watanabe@example.com\", \"li.wei@example.com\"])\n\nclass AddedMemberModel(BaseModel):\n    user_id: int = Field(..., description=\"User ID\", example=17)\n    email: str = Field(..., description=\"User email\", example=\"li.wei@example.com\")\n    group_id: int = Field(..., description=\"User group ID\", example=52)\n\nclass AddUsersToGroupResponse(BaseModel):\n    added_members: List[AddedMemberModel]\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateConnectSubscriptionRequest(BaseModel):\n    name: Optional[str] = Field(None, description=\"Subscription name\", example=\"Envelope Events\")\n    endpoint_url: str = Field(..., description=\"Webhook POST endpoint\", example=\"https://webhook.example.com/docusign/events\")\n    content_type: Optional[str] = Field(None, description=\"Payload content type\", example=\"application/json\")\n    enabled: Optional[bool] = Field(None, description=\"Enable subscription\", example=True)\n    include_recipient_status: Optional[bool] = Field(None, description=\"Include recipient status in payload\", example=True)\n    include_document_status: Optional[bool] = Field(None, description=\"Include document status in payload\", example=True)\n\nclass CreateConnectSubscriptionResponse(BaseModel):\n    subscription_id: int = Field(..., description=\"Subscription ID\", example=82)\n    endpoint_url: str = Field(..., description=\"Webhook endpoint URL\", example=\"https://webhook.example.com/docusign/events\")\n    enabled: bool = Field(..., description=\"Is enabled\", example=True)\n    include_recipient_status: bool = Field(..., description=\"Includes recipient status\", example=True)\n    include_document_status: bool = Field(..., description=\"Includes document status\", example=True)\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddEventsToConnectSubscriptionRequest(BaseModel):\n    event_types: List[str] = Field(..., description=\"Envelope event type(s)\", example=[\"sent\", \"delivered\", \"completed\", \"declined\", \"voided\"])\n\nclass EventTypeModel(BaseModel):\n    event_type: str = Field(..., description=\"Envelope event type\", example=\"sent\")\n\nclass AddEventsToConnectSubscriptionResponse(BaseModel):\n    subscription_id: int = Field(..., description=\"Connect subscription ID\", example=82)\n    events: List[EventTypeModel] = Field(..., description=\"List of event types\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass CreateEnvelopeSimulationRequest(BaseModel):\n    title: str = Field(..., description=\"Envelope title\", example=\"Employee Handbook Acknowledgement - Feb 2026\")\n    status: str = Field(..., description=\"Envelope initial status\", example=\"Created\")\n    source_type: str = Field(..., description=\"Source type\", example=\"api_simulation\")\n\nclass CreateEnvelopeSimulationResponse(BaseModel):\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=2017)\n    title: str = Field(..., description=\"Envelope title\", example=\"Employee Handbook Acknowledgement - Feb 2026\")\n    status: str = Field(..., description=\"Envelope status\", example=\"Created\")\n    source_type: str = Field(..., description=\"Source type\", example=\"api_simulation\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddSimulationEnvelopeRecipientRequest(BaseModel):\n    role: str = Field(..., description=\"Recipient role\", example=\"Signer\")\n    name: str = Field(..., description=\"Recipient name\", example=\"Priya Shah\")\n    email: str = Field(..., description=\"Recipient email\", example=\"priya.shah@example.com\")\n\nclass AddSimulationEnvelopeRecipientResponse(BaseModel):\n    recipient_id: int = Field(..., description=\"Recipient ID\", example=1802)\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=2017)\n    role: str = Field(..., description=\"Recipient role\", example=\"Signer\")\n    email: str = Field(..., description=\"Recipient email\", example=\"priya.shah@example.com\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass AddSimulationEnvelopeTabsRequest(BaseModel):\n    recipient_id: int = Field(..., description=\"Recipient ID\", example=1802)\n    tab_type: str = Field(..., description=\"Tab type\", example=\"signature\")\n    label: Optional[str] = Field(None, description=\"Tab label\", example=\"Employee Signature\")\n\nclass AddSimulationEnvelopeTabsResponse(BaseModel):\n    tab_id: int = Field(..., description=\"Tab ID\", example=1500)\n    tab_type: str = Field(..., description=\"Tab type\", example=\"signature\")\n    label: Optional[str] = Field(None, description=\"Tab label\", example=\"Employee Signature\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass SimulateEnvelopeStatusTransitionRequest(BaseModel):\n    status: str = Field(..., description=\"Envelope status to set\", example=\"Completed\")\n\nclass SimulateEnvelopeStatusTransitionResponse(BaseModel):\n    envelope_id: int = Field(..., description=\"Envelope ID\", example=2017)\n    status: str = Field(..., description=\"New envelope status\", example=\"Completed\")\n    model_config = ConfigDict(from_attributes=True)\n\nclass GetEnvelopeArtifactsResponse(BaseModel):\n    certificate_id: Optional[str] = Field(None, description=\"Completion certificate ID\", example=\"5507a7-certificate\")\n    final_audit_log: Optional[str] = Field(None, description=\"Final audit log (base64 or JSON)\", example=\"<base64_auditlog>\")\n    model_config = ConfigDict(from_attributes=True)\n\n@app.post(\n    \"/api/envelopes\",\n    summary=\"Create a new envelope\",\n    description=\"Create a new envelope owned by the current user.\",\n    tags=[\"envelopes\"],\n    operation_id=\"create_envelope\",\n    response_model=CreateEnvelopeResponse,\n)\nasync def create_envelope(body: CreateEnvelopeRequest):\n    session = SessionLocal()\n    env = Envelopes(\n        owner_user_id=1,\n        title=body.title,\n        subject=body.subject,\n        email_message=body.email_message,\n        status=body.status,\n        source_type=body.source_type,\n        template_id=body.template_id,\n        expires_at=datetime.fromisoformat(body.expires_at.replace(\"Z\", \"+00:00\")) if body.expires_at else None,\n        reminder_enabled=body.reminder_enabled if body.reminder_enabled is not None else False,\n        reminder_interval_days=body.reminder_interval_days,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(env)\n    session.commit()\n    result = CreateEnvelopeResponse(\n        envelope_id=env.id,\n        status=env.status,\n        title=env.title,\n        owner_user_id=env.owner_user_id\n    )\n    session.close()\n    return result\n\n@app.post(\n    \"/api/envelopes/{envelope_id}/documents\",\n    summary=\"Attach a document to an envelope\",\n    description=\"Upload a PDF or attach a document to the specified envelope.\",\n    tags=[\"envelope_documents\"],\n    operation_id=\"add_envelope_document\",\n    response_model=AddEnvelopeDocumentResponse,\n)\nasync def add_envelope_document(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=20),\n    body: AddEnvelopeDocumentRequest = Body(...)\n):\n    session = SessionLocal()\n    doc = Documents(\n        owner_user_id=1,\n        filename=body.filename,\n        mime_type=body.mime_type if body.mime_type else \"application/pdf\",\n        storage_mode=body.storage_mode if body.storage_mode else \"upload\",\n        content_blob=b64decode(body.content_blob) if body.content_blob else None,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(doc)\n    session.commit()\n    num = session.query(EnvelopeDocuments).filter(EnvelopeDocuments.envelope_id == envelope_id).count()\n    envdoc = EnvelopeDocuments(\n        envelope_id=envelope_id,\n        document_id=doc.id,\n        doc_order=num+1,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(envdoc)\n    session.commit()\n    resp = AddEnvelopeDocumentResponse(\n        document_id=doc.id,\n        envelope_id=envelope_id,\n        doc_order=envdoc.doc_order\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/envelopes/{envelope_id}/recipients\",\n    summary=\"Add a recipient to an envelope\",\n    description=\"Add a recipient (Signer, Approver, CC) to an envelope.\",\n    tags=[\"envelope_recipients\"],\n    operation_id=\"add_envelope_recipient\",\n    response_model=AddEnvelopeRecipientResponse,\n)\nasync def add_envelope_recipient(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=10),\n    body: AddEnvelopeRecipientRequest = Body(...)\n):\n    session = SessionLocal()\n    rec = EnvelopeRecipients(\n        envelope_id=envelope_id,\n        role=body.role,\n        routing_order=body.routing_order,\n        name=body.name,\n        email=body.email,\n        status='Created',\n        sms_phone=body.sms_phone,\n        auth_method=body.auth_method,\n        auth_required=body.auth_required if body.auth_required is not None else False,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(rec)\n    session.commit()\n    resp = AddEnvelopeRecipientResponse(\n        recipient_id=rec.id,\n        envelope_id=rec.envelope_id,\n        role=rec.role,\n        routing_order=rec.routing_order,\n        name=rec.name,\n        email=rec.email,\n        status=rec.status\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/envelopes/{envelope_id}/tabs\",\n    summary=\"Add a tab (field) to an envelope for a recipient\",\n    description=\"Add a tab such as signature, date signed, text input or checkbox.\",\n    tags=[\"tabs\"],\n    operation_id=\"add_envelope_tab\",\n    response_model=AddEnvelopeTabResponse,\n)\nasync def add_envelope_tab(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=20),\n    body: AddEnvelopeTabRequest = Body(...)\n):\n    session = SessionLocal()\n    tab = Tabs(\n        envelope_id=envelope_id,\n        recipient_id=body.recipient_id,\n        tab_type=body.tab_type,\n        label=body.label,\n        required=body.required if body.required is not None else False,\n        anchor_text=body.anchor_text,\n        anchor_offset_x=body.anchor_offset_x,\n        anchor_offset_y=body.anchor_offset_y,\n        max_length=body.max_length,\n        default_value=body.default_value,\n        checked=body.checked if body.checked is not None else None,\n        group_id=body.group_id,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(tab)\n    session.commit()\n    resp = AddEnvelopeTabResponse(\n        tab_id=tab.id,\n        envelope_id=tab.envelope_id,\n        recipient_id=tab.recipient_id,\n        tab_type=tab.tab_type\n    )\n    session.close()\n    return resp\n\n@app.put(\n    \"/api/envelopes/{envelope_id}/status\",\n    summary=\"Update (Send) envelope status\",\n    description=\"Set envelope status (e.g., Sent, Delivered, Completed) and reminders.\",\n    tags=[\"envelopes\"],\n    operation_id=\"send_envelope\",\n    response_model=SendEnvelopeResponse,\n)\nasync def send_envelope(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=20),\n    body: SendEnvelopeRequest = Body(...)\n):\n    session = SessionLocal()\n    env = session.query(Envelopes).filter(\n        Envelopes.id == envelope_id,\n        Envelopes.owner_user_id == 1\n    ).first()\n    if env:\n        env.status = body.status\n        env.sent_at = datetime.fromisoformat(body.sent_at.replace(\"Z\", \"+00:00\")) if body.sent_at else env.sent_at\n        env.reminder_enabled = body.reminder_enabled if body.reminder_enabled is not None else env.reminder_enabled\n        env.reminder_interval_days = body.reminder_interval_days if body.reminder_interval_days is not None else env.reminder_interval_days\n        env.reminder_next_at = datetime.fromisoformat(body.reminder_next_at.replace(\"Z\", \"+00:00\")) if body.reminder_next_at else env.reminder_next_at\n        env.expires_at = datetime.fromisoformat(body.expires_at.replace(\"Z\", \"+00:00\")) if body.expires_at else env.expires_at\n        env.updated_at = datetime.utcnow()\n        session.commit()\n    resp = SendEnvelopeResponse(\n        envelope_id=env.id,\n        status=env.status,\n        sent_at=env.sent_at.isoformat().replace(\"+00:00\",\"Z\") if env.sent_at else None\n    )\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/envelopes\",\n    summary=\"Find envelopes by status and recipient email\",\n    description=\"Search envelopes with given status and recipient email.\",\n    tags=[\"envelopes\"],\n    operation_id=\"search_envelopes_by_recipient_and_status\",\n    response_model=EnvelopeListResponse,\n)\nasync def search_envelopes_by_recipient_and_status(\n    status: str = Query(..., description=\"Envelope status to filter\", example=\"Delivered\"),\n    recipient_email: str = Query(..., description=\"Recipient email to filter\", example=\"maria.chen@example.com\")\n):\n    session = SessionLocal()\n    results = (\n        session.query(Envelopes)\n        .join(EnvelopeRecipients, EnvelopeRecipients.envelope_id == Envelopes.id)\n        .filter(\n            Envelopes.status == status,\n            EnvelopeRecipients.email == recipient_email\n        )\n        .order_by(Envelopes.sent_at.desc())\n        .all()\n    )\n    envelopes = [\n        EnvelopeItemModel(\n            envelope_id=env.id,\n            subject=env.subject,\n            sent_at=env.sent_at.isoformat().replace(\"+00:00\",\"Z\") if env.sent_at else None,\n            status=env.status\n        ) for env in results\n    ]\n    resp = EnvelopeListResponse(envelopes=envelopes)\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/envelopes/{envelope_id}/audit_events\",\n    summary=\"Get audit event timestamps for envelope\",\n    description=\"Get audit events for sent and delivered timestamps.\",\n    tags=[\"audit_events\"],\n    operation_id=\"get_envelope_audit_timestamps\",\n    response_model=AuditEventsResponse,\n)\nasync def get_envelope_audit_timestamps(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=90),\n    recipient_email: Optional[str] = Query(None, description=\"Filter by recipient email\", example=\"maria.chen@example.com\")\n):\n    session = SessionLocal()\n    query = session.query(AuditEvents)\n    if recipient_email:\n        rec = session.query(EnvelopeRecipients).filter(\n            EnvelopeRecipients.envelope_id == envelope_id,\n            EnvelopeRecipients.email == recipient_email\n        ).first()\n        rec_id = rec.id if rec else None\n        query = query.filter(AuditEvents.envelope_id == envelope_id, AuditEvents.recipient_id == rec_id)\n    else:\n        query = query.filter(AuditEvents.envelope_id == envelope_id)\n    events = query.order_by(AuditEvents.event_at).all()\n    items = [\n        AuditEventModel(\n            event_type=x.event_type,\n            event_at=x.event_at.isoformat().replace(\"+00:00\",\"Z\") if x.event_at else \"\",\n            recipient_id=x.recipient_id\n        ) for x in events\n    ]\n    resp = AuditEventsResponse(audit_events=items)\n    session.close()\n    return resp\n\n@app.put(\n    \"/api/envelopes/{envelope_id}/void\",\n    summary=\"Void an envelope\",\n    description=\"Set envelope status to Voided and specify the void reason.\",\n    tags=[\"envelopes\"],\n    operation_id=\"void_envelope\",\n    response_model=VoidEnvelopeResponse,\n)\nasync def void_envelope(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=12),\n    body: VoidEnvelopeRequest = Body(...)\n):\n    session = SessionLocal()\n    env = session.query(Envelopes).filter(\n        Envelopes.id == envelope_id,\n        Envelopes.owner_user_id == 1\n    ).first()\n    now = datetime.utcnow()\n    if env:\n        env.status = \"Voided\"\n        env.void_reason = body.void_reason\n        env.voided_at = now\n        env.updated_at = now\n        session.commit()\n    resp = VoidEnvelopeResponse(\n        envelope_id=env.id,\n        status=env.status,\n        void_reason=env.void_reason,\n        voided_at=env.voided_at.isoformat().replace(\"+00:00\",\"Z\") if env.voided_at else None\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/reusable_tabs\",\n    summary=\"Create a reusable tab definition\",\n    description=\"Create a new reusable tab for later addition to templates.\",\n    tags=[\"reusable_tabs\"],\n    operation_id=\"create_reusable_tab\",\n    response_model=CreateReusableTabResponse,\n)\nasync def create_reusable_tab(body: CreateReusableTabRequest):\n    session = SessionLocal()\n    tab = ReusableTabs(\n        owner_user_id=1,\n        name=body.name,\n        tab_type=body.tab_type,\n        required=body.required,\n        max_length=body.max_length,\n        default_value=body.default_value,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(tab)\n    session.commit()\n    resp = CreateReusableTabResponse(\n        reusable_tab_id=tab.id,\n        name=tab.name,\n        tab_type=tab.tab_type,\n        required=bool(tab.required),\n        max_length=tab.max_length,\n        default_value=tab.default_value\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/templates/{template_id}/template_tabs\",\n    summary=\"Add a reusable tab to a template\",\n    description=\"Add a reusable tab to a template at specified anchor text.\",\n    tags=[\"template_tabs\"],\n    operation_id=\"add_reusable_tab_to_template\",\n    response_model=AddReusableTabToTemplateResponse,\n)\nasync def add_reusable_tab_to_template(\n    template_id: int = Path(..., description=\"Template ID\", example=5),\n    body: AddReusableTabToTemplateRequest = Body(...)\n):\n    session = SessionLocal()\n    tab = TemplateTabs(\n        template_id=template_id,\n        role_id=body.role_id,\n        reusable_tab_id=body.reusable_tab_id,\n        tab_type=None,\n        label=None,\n        required=None,\n        anchor_text=body.anchor_text,\n        anchor_offset_x=body.anchor_offset_x,\n        anchor_offset_y=body.anchor_offset_y,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(tab)\n    session.commit()\n    resp = AddReusableTabToTemplateResponse(\n        template_tab_id=tab.id,\n        template_id=tab.template_id,\n        role_id=tab.role_id,\n        reusable_tab_id=tab.reusable_tab_id,\n        anchor_text=tab.anchor_text\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/templates/{template_id}/template_tab_groups\",\n    summary=\"Create a checkbox group for a template role\",\n    description=\"Create a checkbox group for a template role.\",\n    tags=[\"template_tab_groups\"],\n    operation_id=\"create_template_checkbox_group\",\n    response_model=CreateTemplateCheckboxGroupResponse,\n)\nasync def create_template_checkbox_group(\n    template_id: int = Path(..., description=\"Template ID\", example=6),\n    body: CreateTemplateCheckboxGroupRequest = Body(...)\n):\n    session = SessionLocal()\n    tabgroup = TemplateTabGroups(\n        template_id=template_id,\n        role_id=body.role_id,\n        name=body.name,\n        group_type=body.group_type,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(tabgroup)\n    session.commit()\n    resp = CreateTemplateCheckboxGroupResponse(\n        tab_group_id=tabgroup.id,\n        template_id=tabgroup.template_id,\n        role_id=tabgroup.role_id,\n        name=tabgroup.name,\n        group_type=tabgroup.group_type\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/templates/{template_id}/template_tabs\",\n    summary=\"Add checkbox options to a group in template\",\n    description=\"Add checkbox tab options to checkbox group in template.\",\n    tags=[\"template_tabs\"],\n    operation_id=\"add_template_tab_to_group\",\n    response_model=AddTemplateTabToGroupResponse,\n)\nasync def add_template_tab_to_group(\n    template_id: int = Path(..., description=\"Template ID\", example=6),\n    body: AddTemplateTabToGroupRequest = Body(...)\n):\n    session = SessionLocal()\n    tab = TemplateTabs(\n        template_id=template_id,\n        role_id=body.role_id,\n        group_id=body.group_id,\n        tab_type=body.tab_type,\n        label=body.label,\n        checked=body.checked,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(tab)\n    session.commit()\n    resp = AddTemplateTabToGroupResponse(\n        template_tab_id=tab.id,\n        group_id=tab.group_id,\n        label=tab.label,\n        checked=tab.checked\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/user_groups\",\n    summary=\"Create a new user group with permission set\",\n    description=\"Create a new user group with assigned permission set.\",\n    tags=[\"user_groups\"],\n    operation_id=\"create_user_group\",\n    response_model=CreateUserGroupResponse,\n)\nasync def create_user_group(body: CreateUserGroupRequest):\n    session = SessionLocal()\n    group = UserGroups(\n        owner_user_id=1,\n        name=body.name,\n        permission_set_id=body.permission_set_id,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(group)\n    session.commit()\n    resp = CreateUserGroupResponse(\n        group_id=group.id,\n        name=group.name,\n        permission_set_id=group.permission_set_id\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/group_members\",\n    summary=\"Add users to a user group\",\n    description=\"Add one or more users (by email) to an existing user group.\",\n    tags=[\"group_members\"],\n    operation_id=\"add_users_to_group\",\n    response_model=AddUsersToGroupResponse,\n)\nasync def add_users_to_group(body: AddUsersToGroupRequest):\n    session = SessionLocal()\n    added = []\n    for email in body.user_emails:\n        user = session.query(Users).filter(Users.email == email).first()\n        if user:\n            exists = session.query(GroupMembers).filter(\n                GroupMembers.group_id == body.group_id,\n                GroupMembers.user_id == user.id\n            ).first()\n            if not exists:\n                gm = GroupMembers(\n                    group_id=body.group_id,\n                    user_id=user.id,\n                    created_at=datetime.utcnow()\n                )\n                session.add(gm)\n                session.commit()\n            added.append(AddedMemberModel(\n                user_id=user.id,\n                email=user.email,\n                group_id=body.group_id\n            ))\n    resp = AddUsersToGroupResponse(added_members=added)\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/connect_subscriptions\",\n    summary=\"Create a webhook subscription for envelope events\",\n    description=\"Create a subscription that posts envelope JSON events to a given URL.\",\n    tags=[\"connect_subscriptions\"],\n    operation_id=\"create_connect_subscription\",\n    response_model=CreateConnectSubscriptionResponse,\n)\nasync def create_connect_subscription(body: CreateConnectSubscriptionRequest):\n    session = SessionLocal()\n    sub = ConnectSubscriptions(\n        owner_user_id=1,\n        name=body.name,\n        endpoint_url=body.endpoint_url,\n        content_type=body.content_type if body.content_type else \"application/json\",\n        enabled=body.enabled if body.enabled is not None else True,\n        include_recipient_status=body.include_recipient_status if body.include_recipient_status is not None else False,\n        include_document_status=body.include_document_status if body.include_document_status is not None else False,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(sub)\n    session.commit()\n    resp = CreateConnectSubscriptionResponse(\n        subscription_id=sub.id,\n        endpoint_url=sub.endpoint_url,\n        enabled=bool(sub.enabled),\n        include_recipient_status=bool(sub.include_recipient_status),\n        include_document_status=bool(sub.include_document_status)\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/connect_subscriptions/{subscription_id}/events\",\n    summary=\"Add event types to a webhook subscription\",\n    description=\"Specify which envelope event types trigger the webhook.\",\n    tags=[\"connect_subscription_events\"],\n    operation_id=\"add_events_to_connect_subscription\",\n    response_model=AddEventsToConnectSubscriptionResponse,\n)\nasync def add_events_to_connect_subscription(\n    subscription_id: int = Path(..., description=\"Connect subscription ID\", example=82),\n    body: AddEventsToConnectSubscriptionRequest = Body(...)\n):\n    session = SessionLocal()\n    events = []\n    for event_type in body.event_types:\n        evt = ConnectSubscriptionEvents(\n            subscription_id=subscription_id,\n            event_type=event_type,\n            created_at=datetime.utcnow()\n        )\n        session.add(evt)\n        events.append(EventTypeModel(event_type=event_type))\n    session.commit()\n    resp = AddEventsToConnectSubscriptionResponse(\n        subscription_id=subscription_id,\n        events=events\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/envelopes/simulate\",\n    summary=\"Create a metadata-only envelope in simulation mode\",\n    description=\"Create an envelope for workflow simulation and testing.\",\n    tags=[\"envelopes\", \"simulation\"],\n    operation_id=\"create_envelope_simulation\",\n    response_model=CreateEnvelopeSimulationResponse,\n)\nasync def create_envelope_simulation(body: CreateEnvelopeSimulationRequest):\n    session = SessionLocal()\n    env = Envelopes(\n        owner_user_id=1,\n        title=body.title,\n        status=body.status,\n        source_type=body.source_type,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(env)\n    session.commit()\n    resp = CreateEnvelopeSimulationResponse(\n        envelope_id=env.id,\n        title=env.title,\n        status=env.status,\n        source_type=env.source_type\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/envelopes/{envelope_id}/recipients\",\n    summary=\"Add recipients to simulated envelope\",\n    description=\"Add recipients to metadata-only envelope for simulation.\",\n    tags=[\"simulation\", \"envelope_recipients\"],\n    operation_id=\"add_simulation_envelope_recipient\",\n    response_model=AddSimulationEnvelopeRecipientResponse,\n)\nasync def add_simulation_envelope_recipient(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=2017),\n    body: AddSimulationEnvelopeRecipientRequest = Body(...)\n):\n    session = SessionLocal()\n    rec = EnvelopeRecipients(\n        envelope_id=envelope_id,\n        role=body.role,\n        routing_order=1,\n        name=body.name,\n        email=body.email,\n        status='Created',\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(rec)\n    session.commit()\n    resp = AddSimulationEnvelopeRecipientResponse(\n        recipient_id=rec.id,\n        envelope_id=rec.envelope_id,\n        role=rec.role,\n        email=rec.email\n    )\n    session.close()\n    return resp\n\n@app.post(\n    \"/api/envelopes/{envelope_id}/tabs\",\n    summary=\"Add simulation workflow tabs\",\n    description=\"Add tabs like signature and date signed to simulated envelope.\",\n    tags=[\"simulation\", \"tabs\"],\n    operation_id=\"add_simulation_envelope_tabs\",\n    response_model=AddSimulationEnvelopeTabsResponse,\n)\nasync def add_simulation_envelope_tabs(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=2017),\n    body: AddSimulationEnvelopeTabsRequest = Body(...)\n):\n    session = SessionLocal()\n    tab = Tabs(\n        envelope_id=envelope_id,\n        recipient_id=body.recipient_id,\n        tab_type=body.tab_type,\n        label=body.label,\n        required=False,\n        created_at=datetime.utcnow(),\n        updated_at=datetime.utcnow()\n    )\n    session.add(tab)\n    session.commit()\n    resp = AddSimulationEnvelopeTabsResponse(\n        tab_id=tab.id,\n        tab_type=tab.tab_type,\n        label=tab.label\n    )\n    session.close()\n    return resp\n\n@app.put(\n    \"/api/envelopes/{envelope_id}/status\",\n    summary=\"Transition simulated envelope status\",\n    description=\"Change simulated envelope workflow status.\",\n    tags=[\"simulation\", \"envelopes\"],\n    operation_id=\"simulate_envelope_status_transition\",\n    response_model=SimulateEnvelopeStatusTransitionResponse,\n)\nasync def simulate_envelope_status_transition(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=2017),\n    body: SimulateEnvelopeStatusTransitionRequest = Body(...)\n):\n    session = SessionLocal()\n    env = session.query(Envelopes).filter(\n        Envelopes.id == envelope_id,\n        Envelopes.owner_user_id == 1\n    ).first()\n    if env:\n        env.status = body.status\n        env.updated_at = datetime.utcnow()\n        session.commit()\n    resp = SimulateEnvelopeStatusTransitionResponse(\n        envelope_id=env.id,\n        status=env.status\n    )\n    session.close()\n    return resp\n\n@app.get(\n    \"/api/envelopes/{envelope_id}/artifacts\",\n    summary=\"Get envelope completion artifacts\",\n    description=\"Fetch completion certificate and final audit log for workflow.\",\n    tags=[\"artifacts\"],\n    operation_id=\"get_envelope_artifacts\",\n    response_model=GetEnvelopeArtifactsResponse,\n)\nasync def get_envelope_artifacts(\n    envelope_id: int = Path(..., description=\"Envelope ID\", example=2017)\n):\n    session = SessionLocal()\n    cert = session.query(EnvelopeArtifacts).filter(\n        EnvelopeArtifacts.envelope_id == envelope_id,\n        EnvelopeArtifacts.artifact_type == \"certificate\"\n    ).first()\n    audit = session.query(EnvelopeArtifacts).filter(\n        EnvelopeArtifacts.envelope_id == envelope_id,\n        EnvelopeArtifacts.artifact_type == \"final_audit_log\"\n    ).first()\n    resp = GetEnvelopeArtifactsResponse(\n        certificate_id=cert.certificate_id if cert else None,\n        final_audit_log=b64encode(audit.content_blob).decode() if audit and audit.content_blob else None\n    )\n    session.close()\n    return resp\n\nif __name__ == \"__main__\":\n    import uvicorn, os\n    host = os.getenv(\"HOST\", \"127.0.0.1\")\n    port = int(os.getenv(\"PORT\", \"8000\"))\n    uvicorn.run(app, host=host, port=port)\n"}
